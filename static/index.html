<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buffå·®ä»·ç›‘æ§ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .profit-positive {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .profit-high {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        .profit-very-high {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        /* ç§»åŠ¨ç«¯é€‚é…æ ·å¼ */
        @media (max-width: 768px) {
            .mobile-hidden {
                display: none !important;
            }
            
            .mobile-text-sm {
                font-size: 0.875rem !important;
            }
            
            .mobile-p-2 {
                padding: 0.5rem !important;
            }
            
            .mobile-card {
                margin-bottom: 1rem;
                padding: 1rem;
                border-radius: 0.5rem;
                background: white;
                box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            }
            
            .mobile-flex-col {
                display: flex !important;
                flex-direction: column !important;
                gap: 0.5rem !important;
            }
            
            .mobile-w-full {
                width: 100% !important;
            }
            
            .mobile-text-center {
                text-align: center !important;
            }
            
            /* ç§»åŠ¨ç«¯è¡¨æ ¼ä¼˜åŒ– */
            .mobile-table-responsive {
                display: block;
                width: 100%;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .mobile-table-responsive table {
                width: 100%;
                min-width: 800px;
            }
            
            /* ç§»åŠ¨ç«¯æŒ‰é’®ä¼˜åŒ– */
            .mobile-btn {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
                width: 100%;
                margin-bottom: 0.5rem;
            }
            
            /* ç§»åŠ¨ç«¯å¯¼èˆªä¼˜åŒ– */
            .mobile-nav {
                padding: 0.5rem 1rem;
            }
            
            .mobile-nav h1 {
                font-size: 1.125rem;
            }
            
            /* ç§»åŠ¨ç«¯æ¨¡æ€æ¡†ä¼˜åŒ– */
            .mobile-modal {
                margin: 1rem;
                max-height: calc(100vh - 2rem);
                border-radius: 0.5rem;
            }
            
            /* ç§»åŠ¨ç«¯ç»Ÿè®¡å¡ç‰‡ä¼˜åŒ– */
            .mobile-stat-card {
                text-align: center;
                padding: 1rem;
            }
            
            .mobile-stat-card .stat-icon {
                margin: 0 auto 0.5rem;
            }
            
            /* ç§»åŠ¨ç«¯ç­›é€‰é¢æ¿ä¼˜åŒ– */
            .mobile-filter {
                display: flex;
                flex-direction: column;
                gap: 1rem;
            }
            
            .mobile-filter > div {
                width: 100%;
            }
            
            .mobile-filter input,
            .mobile-filter select {
                width: 100%;
            }
        }
        
        /* å°å±å¹•ç‰¹æ®Šä¼˜åŒ– */
        @media (max-width: 480px) {
            .xs-hidden {
                display: none !important;
            }
            
            .xs-text-xs {
                font-size: 0.75rem !important;
            }
            
            .xs-p-1 {
                padding: 0.25rem !important;
            }
            
            /* è¶…å°å±å¹•çš„è¡¨æ ¼å¡ç‰‡æ¨¡å¼ */
            .xs-card-mode {
                display: block !important;
            }
            
            .xs-card-mode table,
            .xs-card-mode thead,
            .xs-card-mode tbody,
            .xs-card-mode th,
            .xs-card-mode td,
            .xs-card-mode tr {
                display: block !important;
            }
            
            .xs-card-mode thead tr {
                position: absolute !important;
                top: -9999px !important;
                left: -9999px !important;
            }
            
            .xs-card-mode tr {
                border: 1px solid #e5e7eb !important;
                margin-bottom: 1rem !important;
                padding: 1rem !important;
                border-radius: 0.5rem !important;
                background: white !important;
            }
            
            .xs-card-mode td {
                border: none !important;
                position: relative !important;
                padding-left: 50% !important;
                padding-top: 0.5rem !important;
                padding-bottom: 0.5rem !important;
            }
            
            .xs-card-mode td:before {
                content: attr(data-label) ": " !important;
                position: absolute !important;
                left: 0.5rem !important;
                width: 45% !important;
                padding-right: 10px !important;
                white-space: nowrap !important;
                font-weight: 600 !important;
                color: #374151 !important;
            }
        }
        
        /* è§¦æ‘¸ä¼˜åŒ– */
        @media (hover: none) and (pointer: coarse) {
            .touch-target {
                min-height: 44px !important;
                min-width: 44px !important;
            }
            
            .touch-btn {
                padding: 0.75rem 1.5rem !important;
                font-size: 1rem !important;
            }
        }

        /* è®¾å¤‡ç‰¹å®šæ ·å¼ */
        .is-mobile {
            /* ç§»åŠ¨ç«¯ç‰¹å®šæ ·å¼ */
        }

        .is-desktop {
            /* æ¡Œé¢ç«¯ç‰¹å®šæ ·å¼ */
        }

        .is-touch {
            /* è§¦æ‘¸è®¾å¤‡ç‰¹å®šæ ·å¼ */
        }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ–çš„åŠ è½½åŠ¨ç”» */
        @media (max-width: 768px) {
            .loading {
                animation: spin 0.8s linear infinite;
            }
            
            /* ç§»åŠ¨ç«¯æ¨¡æ€æ¡†å…¨å±ä¼˜åŒ– */
            @media (max-height: 600px) {
                .mobile-modal {
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    margin: 0;
                    border-radius: 0;
                    max-height: 100vh;
                }
            }
            
            /* ç§»åŠ¨ç«¯è¡¨å•ä¼˜åŒ– */
            .mobile-form-group {
                margin-bottom: 1rem;
            }
            
            .mobile-form-group label {
                display: block;
                margin-bottom: 0.5rem;
                font-weight: 600;
                color: #374151;
            }
            
            .mobile-form-group input,
            .mobile-form-group select,
            .mobile-form-group textarea {
                width: 100%;
                padding: 0.75rem;
                border: 1px solid #d1d5db;
                border-radius: 0.375rem;
                font-size: 1rem;
                line-height: 1.5;
            }
            
            /* ç§»åŠ¨ç«¯ç½‘æ ¼ä¼˜åŒ– */
            .mobile-grid {
                display: grid;
                gap: 1rem;
                grid-template-columns: 1fr;
            }
            
            .mobile-grid-2 {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* æ¨ªå±ä¼˜åŒ– */
        @media (max-width: 768px) and (orientation: landscape) {
            .landscape-optimize {
                max-height: 80vh;
                overflow-y: auto;
            }
        }

        /* iOS Safari ç‰¹æ®Šä¼˜åŒ– */
        @supports (-webkit-touch-callout: none) {
            .ios-safe-area {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="gradient-bg shadow-lg">
        <div class="max-w-7xl mx-auto px-2 sm:px-4 lg:px-8">
            <div class="flex justify-between items-center h-14 sm:h-16">
                <div class="flex items-center min-w-0 flex-1">
                    <i class="fas fa-chart-line text-white text-lg sm:text-2xl mr-2 sm:mr-3 flex-shrink-0"></i>
                    <h1 class="text-white text-sm sm:text-xl font-bold truncate">Buffå·®ä»·ç›‘æ§ç³»ç»Ÿ</h1>
                </div>
                <div class="flex items-center">
                    <button id="settingsBtn" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-2 sm:px-4 py-2 rounded-lg transition duration-200 text-sm sm:text-base touch-target">
                        <i class="fas fa-cog sm:mr-2"></i>
                        <span class="hidden sm:inline">è®¾ç½®</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-2 sm:px-4 lg:px-8 py-4 sm:py-8">
        <!-- ç»Ÿè®¡é¢æ¿ -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-6 mb-6 sm:mb-8">
            <div class="bg-white rounded-lg shadow p-3 sm:p-6">
                <div class="flex flex-col sm:flex-row items-center sm:items-center">
                    <div class="p-2 sm:p-3 rounded-full bg-blue-100 text-blue-600 mb-2 sm:mb-0">
                        <i class="fas fa-gem text-sm sm:text-xl"></i>
                    </div>
                    <div class="sm:ml-4 text-center sm:text-left">
                        <p class="text-xs sm:text-sm font-medium text-gray-600">æ€»é¥°å“æ•°</p>
                        <p class="text-lg sm:text-2xl font-semibold text-gray-900" id="totalCount">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-3 sm:p-6">
                <div class="flex flex-col sm:flex-row items-center sm:items-center">
                    <div class="p-2 sm:p-3 rounded-full bg-green-100 text-green-600 mb-2 sm:mb-0">
                        <i class="fas fa-coins text-sm sm:text-xl"></i>
                    </div>
                    <div class="sm:ml-4 text-center sm:text-left">
                        <p class="text-xs sm:text-sm font-medium text-gray-600">å¹³å‡ä»·å·®</p>
                        <p class="text-lg sm:text-2xl font-semibold text-gray-900" id="avgDiff">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-3 sm:p-6">
                <div class="flex flex-col sm:flex-row items-center sm:items-center">
                    <div class="p-2 sm:p-3 rounded-full bg-yellow-100 text-yellow-600 mb-2 sm:mb-0">
                        <i class="fas fa-chart-bar text-sm sm:text-xl"></i>
                    </div>
                    <div class="sm:ml-4 text-center sm:text-left">
                        <p class="text-xs sm:text-sm font-medium text-gray-600">æœ€å¤§ä»·å·®</p>
                        <p class="text-lg sm:text-2xl font-semibold text-gray-900" id="maxDiff">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-3 sm:p-6 col-span-2 lg:col-span-1">
                <div class="flex flex-col sm:flex-row items-center sm:items-center">
                    <div class="p-2 sm:p-3 rounded-full bg-purple-100 text-purple-600 mb-2 sm:mb-0">
                        <i class="fas fa-clock text-sm sm:text-xl"></i>
                    </div>
                    <div class="sm:ml-4 text-center sm:text-left">
                        <p class="text-xs sm:text-sm font-medium text-gray-600">æ›´æ–°æ—¶é—´</p>
                        <p class="text-xs sm:text-sm font-semibold text-gray-900" id="lastUpdate">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¿‡æ»¤å’Œæ’åº -->
        <div class="bg-white rounded-lg shadow p-3 sm:p-6 mb-6 sm:mb-8">
            <div class="flex flex-col sm:flex-row sm:flex-wrap sm:items-end gap-3 sm:gap-4">
                <div class="flex-1 min-w-0">
                    <label class="block text-sm font-medium text-gray-700 mb-1">ä»·æ ¼åŒºé—´ï¼ˆå…ƒï¼‰</label>
                    <div class="flex items-center space-x-2">
                        <input type="number" id="minPriceFilter" placeholder="æœ€å°ä»·å·®" 
                               class="border border-gray-300 rounded-md px-3 py-2 w-full sm:w-24 touch-target text-sm sm:text-base" step="0.1" min="0">
                        <span class="text-gray-500 flex-shrink-0">-</span>
                        <input type="number" id="maxPriceFilter" placeholder="æœ€å¤§ä»·å·®" 
                               class="border border-gray-300 rounded-md px-3 py-2 w-full sm:w-24 touch-target text-sm sm:text-base" step="0.1" min="0">
                    </div>
                </div>
                <div class="flex-1 min-w-0 sm:min-w-32">
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ’åºæ–¹å¼</label>
                    <select id="sortBy" class="border border-gray-300 rounded-md px-3 py-2 w-full touch-target text-sm sm:text-base">
                        <option value="price_diff">æŒ‰ä»·å·®æ’åº</option>
                        <option value="profit_margin">æŒ‰åˆ©æ¶¦ç‡æ’åº</option>
                    </select>
                </div>
                <div class="flex-1 min-w-0 sm:min-w-24">
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ˜¾ç¤ºæ•°é‡</label>
                    <select id="limitCount" class="border border-gray-300 rounded-md px-3 py-2 w-full touch-target text-sm sm:text-base">
                        <option value="50">50ä¸ª</option>
                        <option value="100" selected>100ä¸ª</option>
                        <option value="200">200ä¸ª</option>
                        <option value="500">500ä¸ª</option>
                    </select>
                </div>
                <div class="flex flex-col sm:flex-row gap-2 sm:gap-2 w-full sm:w-auto">
                    <button id="applyFilter" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition duration-200 touch-btn text-sm sm:text-base">
                        <i class="fas fa-filter mr-2"></i>
                        åº”ç”¨ç­›é€‰
                    </button>
                    <button id="resetFilter" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition duration-200 touch-btn text-sm sm:text-base">
                        <i class="fas fa-undo mr-2"></i>
                        é‡ç½®
                    </button>
                </div>
            </div>
        </div>

        <!-- é¥°å“åˆ—è¡¨ -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-list mr-2"></i>
                    å·®ä»·é¥°å“åˆ—è¡¨
                </h2>
            </div>
            
            <div id="loading" class="flex items-center justify-center p-8">
                <div class="loading text-blue-600 text-2xl">
                    <i class="fas fa-spinner"></i>
                </div>
                <span class="ml-3 text-gray-600">æ­£åœ¨åŠ è½½æ•°æ®...</span>
            </div>
            
            <div id="itemsList" class="hidden">
                <!-- åŠ¨æ€ç”Ÿæˆçš„é¥°å“åˆ—è¡¨ -->
            </div>
        </div>
    </div>

    <!-- è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-2 sm:p-4">
            <div class="bg-white rounded-lg max-w-4xl w-full max-w-none sm:max-w-4xl p-3 sm:p-6 max-h-screen overflow-y-auto m-2 sm:m-0">
                <div class="flex justify-between items-center mb-4 sm:mb-6">
                    <h3 class="text-lg sm:text-xl font-semibold">ç³»ç»Ÿè®¾ç½®</h3>
                    <button id="closeSettings" class="text-gray-400 hover:text-gray-600 touch-target">
                        <i class="fas fa-times text-lg sm:text-xl"></i>
                    </button>
                </div>
                
                <!-- è®¾ç½®æ ‡ç­¾é¡µ -->
                <div class="flex border-b mb-4 sm:mb-6 overflow-x-auto">
                    <button id="generalTab" class="px-3 sm:px-4 py-2 font-medium text-blue-600 border-b-2 border-blue-600 whitespace-nowrap touch-target text-sm sm:text-base">
                        å¸¸è§„è®¾ç½®
                    </button>
                    <button id="tokensTab" class="px-3 sm:px-4 py-2 font-medium text-gray-600 hover:text-blue-600 ml-2 sm:ml-4 whitespace-nowrap touch-target text-sm sm:text-base">
                        Tokenç®¡ç†
                    </button>
                </div>
                
                <!-- å¸¸è§„è®¾ç½®é¢æ¿ -->
                <div id="generalPanel" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ä»·æ ¼å·®å¼‚åŒºé—´ï¼ˆå…ƒï¼‰</label>
                        <div class="flex items-center space-x-2">
                            <input type="number" id="priceRangeMin" placeholder="æœ€å°ä»·å·®" 
                                   class="border border-gray-300 rounded-md px-3 py-2 w-24" step="0.1" min="0">
                            <span class="text-gray-500">-</span>
                            <input type="number" id="priceRangeMax" placeholder="æœ€å¤§ä»·å·®" 
                                   class="border border-gray-300 rounded-md px-3 py-2 w-24" step="0.1" min="0">
                        </div>
                        <p class="text-xs text-gray-500 mt-1">è®¾ç½®ä»·å·®ç­›é€‰åŒºé—´ï¼Œä¾‹å¦‚ 3-5å…ƒ</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Buffä»·æ ¼ç­›é€‰åŒºé—´ï¼ˆå…ƒï¼‰</label>
                        <div class="flex items-center space-x-2">
                            <input type="number" id="buffPriceMin" placeholder="æœ€å°ä»·æ ¼" 
                                   class="border border-gray-300 rounded-md px-3 py-2 w-24" step="0.1" min="0">
                            <span class="text-gray-500">-</span>
                            <input type="number" id="buffPriceMax" placeholder="æœ€å¤§ä»·æ ¼" 
                                   class="border border-gray-300 rounded-md px-3 py-2 w-24" step="0.1" min="0">
                        </div>
                        <p class="text-xs text-gray-500 mt-1">åªåˆ†ææ­¤ä»·æ ¼åŒºé—´å†…çš„Buffå•†å“ï¼Œç”¨äºå¢é‡æ›´æ–°</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Buffæœ€å°åœ¨å”®æ•°é‡</label>
                        <input type="number" id="buffSellNumMin" placeholder="200" 
                               class="w-full border border-gray-300 rounded-md px-3 py-2" min="0" step="1">
                        <p class="text-xs text-gray-500 mt-1">åªåˆ†æåœ¨å”®æ•°é‡â‰¥æ­¤å€¼çš„Buffå•†å“ï¼Œè¿‡æ»¤æµåŠ¨æ€§å·®çš„å•†å“</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æœ€å¤§è¾“å‡ºæ•°é‡</label>
                        <input type="number" id="maxOutputItems" placeholder="300" 
                               class="w-full border border-gray-300 rounded-md px-3 py-2" min="1" step="1">
                        <p class="text-xs text-gray-500 mt-1">é™åˆ¶æœ€ç»ˆè¾“å‡ºçš„å•†å“æ•°é‡</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ›´æ–°é—´éš”è®¾ç½®</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">å…¨é‡æ›´æ–°ï¼ˆå°æ—¶ï¼‰</label>
                                <div class="text-sm text-blue-600 font-medium" id="fullUpdateInterval">1å°æ—¶</div>
                                <p class="text-xs text-gray-500">è·å–å…¨éƒ¨æ•°æ®çš„é—´éš”</p>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">å¢é‡æ›´æ–°ï¼ˆåˆ†é’Ÿï¼‰</label>
                                <div class="text-sm text-blue-600 font-medium" id="incrementalUpdateInterval">1åˆ†é’Ÿ</div>
                                <p class="text-xs text-gray-500">æœç´¢ç‰¹å®šå•†å“çš„é—´éš”</p>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ‰‹åŠ¨æ›´æ–°æ“ä½œ</label>
                        <div class="flex space-x-2">
                            <button id="forceFullUpdate" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-sm">
                                <i class="fas fa-download mr-1"></i>
                                å¼ºåˆ¶å…¨é‡æ›´æ–°
                            </button>
                            <button id="forceIncrementalUpdate" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm">
                                <i class="fas fa-sync mr-1"></i>
                                å¼ºåˆ¶å¢é‡æ›´æ–°
                            </button>
                            <!-- ğŸ”¥ æ–°å¢ï¼šå¢å¼ºå¢é‡æ›´æ–°æŒ‰é’® -->
                            <button id="enhancedIncrementalUpdate" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded text-sm">
                                <i class="fas fa-rocket mr-1"></i>
                                å¢å¼ºå¢é‡æ›´æ–°
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">ç«‹å³æ‰§è¡ŒæŒ‡å®šç±»å‹çš„æ›´æ–°</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ä»·å·®é˜ˆå€¼ï¼ˆå…ƒï¼‰- å…¼å®¹æ¨¡å¼</label>
                        <input type="number" id="thresholdInput" placeholder="20" 
                               class="w-full border border-gray-300 rounded-md px-3 py-2" step="0.1" min="0">
                        <p class="text-xs text-gray-500 mt-1">ä¼ ç»Ÿå•ä¸€é˜ˆå€¼æ¨¡å¼ï¼ˆå»ºè®®ä½¿ç”¨ä»·æ ¼åŒºé—´ï¼‰</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å½“å‰ä»·æ ¼åŒºé—´</label>
                        <div id="currentPriceRange" class="text-sm text-blue-600 font-medium">
                            åŠ è½½ä¸­...
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å½“å‰Buffä»·æ ¼ç­›é€‰</label>
                        <div id="currentBuffPriceRange" class="text-sm text-blue-600 font-medium">
                            åŠ è½½ä¸­...
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å½“å‰Buffåœ¨å”®æ•°é‡ç­›é€‰</label>
                        <div id="currentBuffSellNum" class="text-sm text-blue-600 font-medium">
                            åŠ è½½ä¸­...
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ›´æ–°çŠ¶æ€</label>
                        <div id="updateStatus" class="text-sm">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                <i class="fas fa-clock mr-1"></i>
                                æ­£åœ¨æ£€æŸ¥...
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- Tokenç®¡ç†é¢æ¿ -->
                <div id="tokensPanel" class="hidden space-y-4 sm:space-y-6">
                    <!-- TokençŠ¶æ€æ¦‚è§ˆ -->
                    <div class="bg-gray-50 p-3 sm:p-4 rounded-lg">
                        <h4 class="font-medium text-gray-900 mb-3 text-sm sm:text-base">TokençŠ¶æ€</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                            <div>
                                <p class="text-xs sm:text-sm text-gray-600">Buff API</p>
                                <div id="buffTokenStatus" class="mt-1">
                                    <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-800">
                                        æ£€æŸ¥ä¸­...
                                    </span>
                                </div>
                            </div>
                            <div>
                                <p class="text-xs sm:text-sm text-gray-600">æ‚ æ‚ æœ‰å“ API</p>
                                <div id="youpinTokenStatus" class="mt-1">
                                    <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-800">
                                        æ£€æŸ¥ä¸­...
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Buff Tokenè®¾ç½® -->
                    <div class="border border-gray-200 rounded-lg p-3 sm:p-4">
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 gap-3">
                            <h4 class="font-medium text-gray-900 text-sm sm:text-base">Buff Token é…ç½®</h4>
                            <div class="flex flex-col sm:flex-row gap-2 sm:space-x-2">
                                <button id="validateBuffToken" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 sm:py-1 rounded text-sm touch-target">
                                    <i class="fas fa-check-circle mr-1"></i>
                                    éªŒè¯Token
                                </button>
                                <button id="testBuffConnection" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 sm:py-1 rounded text-sm touch-target">
                                    <i class="fas fa-plug mr-1"></i>
                                    æµ‹è¯•è¿æ¥
                                </button>
                            </div>
                        </div>
                        
                        <div class="space-y-3 sm:space-y-4">
                            <div class="mobile-form-group">
                                <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Session Cookie</label>
                                <input type="text" id="buffSession" placeholder="sessionå€¼..." 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base touch-target">
                            </div>
                            <div class="mobile-form-group">
                                <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">CSRF Token</label>
                                <input type="text" id="buffCsrfToken" placeholder="csrf_tokenå€¼..." 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base touch-target">
                            </div>
                            <div class="mobile-form-group">
                                <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">å…¶ä»–Cookies (JSONæ ¼å¼)</label>
                                <textarea id="buffOtherCookies" placeholder='{"Device-Id": "xxx", "remember_me": "xxx"}'
                                          class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base h-16 sm:h-20 touch-target resize-none"></textarea>
                                <p class="text-xs text-gray-500 mt-1">å¯é€‰ï¼šå…¶ä»–cookiesï¼ŒJSONæ ¼å¼</p>
                            </div>
                            <button id="updateBuffToken" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded w-full sm:w-auto touch-btn">
                                <i class="fas fa-save mr-2"></i>
                                æ›´æ–° Buff Token
                            </button>
                        </div>
                    </div>
                    
                    <!-- æ‚ æ‚ æœ‰å“Tokenè®¾ç½® -->
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-medium text-gray-900">æ‚ æ‚ æœ‰å“ Token é…ç½®</h4>
                            <button id="testYoupinConnection" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                                <i class="fas fa-plug mr-1"></i>
                                æµ‹è¯•è¿æ¥
                            </button>
                        </div>
                        
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Device ID</label>
                                <input type="text" id="youpinDeviceId" placeholder="device_idå€¼..." 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Device UK</label>
                                <input type="text" id="youpinDeviceUk" placeholder="device_ukå€¼..." 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">UK</label>
                                <input type="text" id="youpinUk" placeholder="ukå€¼..." 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">B3</label>
                                <input type="text" id="youpinB3" placeholder="b3å€¼..." 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Authorization Token</label>
                                <input type="text" id="youpinAuthorization" placeholder="Bearer xxxæˆ–JWT token..." 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                                <p class="text-xs text-gray-500 mt-1">è®¤è¯Tokenï¼Œé€šå¸¸ä»¥Bearerå¼€å¤´</p>
                            </div>
                            <div class="flex space-x-2">
                                <button id="validateYoupinToken" class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-2 rounded text-sm">
                                    <i class="fas fa-check-circle mr-1"></i>
                                    éªŒè¯Token
                                </button>
                                <button id="updateYoupinToken" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                                    <i class="fas fa-save mr-2"></i>
                                    æ›´æ–°æ‚ æ‚ æœ‰å“ Token
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tokenè·å–è¯´æ˜ -->
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-medium text-blue-900 mb-2">
                            <i class="fas fa-info-circle mr-2"></i>
                            å¦‚ä½•è·å–Token
                        </h4>
                        <div class="text-sm text-blue-800 space-y-2">
                            <p><strong>Buff Token:</strong></p>
                            <p>1. åœ¨æµè§ˆå™¨ä¸­ç™»å½• buff.163.com</p>
                            <p>2. æ‰“å¼€å¼€å‘è€…å·¥å…· (F12) â†’ Network æ ‡ç­¾</p>
                            <p>3. åˆ·æ–°é¡µé¢ï¼ŒæŸ¥æ‰¾å¯¹ /api/market/goods çš„è¯·æ±‚</p>
                            <p>4. å¤åˆ¶è¯·æ±‚å¤´ä¸­çš„ session å’Œ csrf_token cookies</p>
                            
                            <p><strong>æ‚ æ‚ æœ‰å“Token:</strong></p>
                            <p>1. åœ¨æµè§ˆå™¨ä¸­è®¿é—® youpin898.com</p>
                            <p>2. æ‰“å¼€å¼€å‘è€…å·¥å…· â†’ Network æ ‡ç­¾</p>
                            <p>3. æŸ¥æ‰¾å¯¹ api.youpin898.com çš„è¯·æ±‚</p>
                            <p>4. å¤åˆ¶è¯·æ±‚å¤´ä¸­çš„ç›¸å…³å‚æ•°</p>
                            <p>5. <strong>é‡è¦</strong>ï¼šå¤åˆ¶Authorizationå¤´ï¼ˆé€šå¸¸ä»¥Bearerå¼€å¤´ï¼‰</p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end space-x-3">
                    <button id="saveSettings" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition duration-200">
                        ä¿å­˜è®¾ç½®
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ğŸ”¥ è®¾ç½®åŸºç¡€è·¯å¾„ï¼Œæ”¯æŒå­è·¯å¾„éƒ¨ç½²
        const BASE_PATH = window.location.pathname.includes('/csgo') ? '/csgo' : '';
        
        class BuffMonitor {
            constructor() {
                this.items = [];
                this.allItems = [];
                this.filters = { minPrice: null, maxPrice: null };
                this.sortBy = 'price_diff';
                
                // ğŸ”¥ æ–°å¢ï¼šæµå¼åˆ†æå˜é‡
                this.streamingActive = false;
                this.eventSource = null;
                
                this.initEventListeners();
                this.init(); // ğŸ”¥ ä¿®å¤ï¼šè°ƒç”¨å®Œæ•´çš„åˆå§‹åŒ–æ–¹æ³•
            }

            // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            initEventListeners() {
                
                // è®¾ç½®æŒ‰é’®
                const settingsBtn = document.getElementById('settingsBtn');
                if (settingsBtn) {
                    settingsBtn.addEventListener('click', () => this.openSettings());
                }
                
                // å…³é—­è®¾ç½®æ¨¡æ€æ¡†
                const closeSettings = document.getElementById('closeSettings');
                if (closeSettings) {
                    closeSettings.addEventListener('click', () => this.closeSettings());
                }
                
                // æ ‡ç­¾é¡µåˆ‡æ¢
                const generalTab = document.getElementById('generalTab');
                if (generalTab) {
                    generalTab.addEventListener('click', () => this.showGeneralTab());
                }
                
                const tokensTab = document.getElementById('tokensTab');
                if (tokensTab) {
                    tokensTab.addEventListener('click', () => this.showTokenTab());
                }
                
                // åº”ç”¨ç­›é€‰æŒ‰é’®
                const applyFilter = document.getElementById('applyFilter');
                if (applyFilter) {
                    applyFilter.addEventListener('click', () => this.applyFilters());
                }

                // é‡ç½®ç­›é€‰æŒ‰é’®
                const resetFilter = document.getElementById('resetFilter');
                if (resetFilter) {
                    resetFilter.addEventListener('click', () => this.resetFilters());
                }

                // ä¿å­˜è®¾ç½®æŒ‰é’®
                const saveSettings = document.getElementById('saveSettings');
                if (saveSettings) {
                    saveSettings.addEventListener('click', () => this.saveSettings());
                }

                // Tokenç›¸å…³æŒ‰é’®
                const updateBuffToken = document.getElementById('updateBuffToken');
                if (updateBuffToken) {
                    updateBuffToken.addEventListener('click', () => this.updateBuffToken());
                }

                const updateYoupinToken = document.getElementById('updateYoupinToken');
                if (updateYoupinToken) {
                    updateYoupinToken.addEventListener('click', () => this.updateYoupinToken());
                }

                const testBuffConnection = document.getElementById('testBuffConnection');
                if (testBuffConnection) {
                    testBuffConnection.addEventListener('click', () => this.testBuffConnection());
                }

                const testYoupinConnection = document.getElementById('testYoupinConnection');
                if (testYoupinConnection) {
                    testYoupinConnection.addEventListener('click', () => this.testYoupinConnection());
                }

                // éªŒè¯TokenæŒ‰é’®
                const validateBuffToken = document.getElementById('validateBuffToken');
                if (validateBuffToken) {
                    validateBuffToken.addEventListener('click', () => this.validateSingleToken('buff'));
                }

                const validateYoupinToken = document.getElementById('validateYoupinToken');
                if (validateYoupinToken) {
                    validateYoupinToken.addEventListener('click', () => this.validateSingleToken('youpin'));
                }

                // ğŸ”¥ æ–°å¢ï¼šå¼ºåˆ¶æ›´æ–°æŒ‰é’®
                const forceFullUpdate = document.getElementById('forceFullUpdate');
                if (forceFullUpdate) {
                    forceFullUpdate.addEventListener('click', () => this.forceFullUpdate());
                }
                
                const forceIncrementalUpdate = document.getElementById('forceIncrementalUpdate');
                if (forceIncrementalUpdate) {
                    forceIncrementalUpdate.addEventListener('click', () => this.forceIncrementalUpdate());
                }
                
                // ğŸ”¥ æ–°å¢ï¼šå¢å¼ºå¢é‡æ›´æ–°æŒ‰é’®äº‹ä»¶
                const enhancedIncrementalUpdate = document.getElementById('enhancedIncrementalUpdate');
                if (enhancedIncrementalUpdate) {
                    enhancedIncrementalUpdate.addEventListener('click', () => this.enhancedIncrementalUpdate());
                }
            }

            // åº”ç”¨ç­›é€‰åŠŸèƒ½
            async applyFilters() {
                try {
                    const minPrice = document.getElementById('minPriceFilter').value || 0;
                    const maxPrice = document.getElementById('maxPriceFilter').value || 0;
                    const sortBy = document.getElementById('sortBy').value || 'price_diff';
                    const limit = document.getElementById('limitCount').value || 100;
                    
                    // ä¿å­˜æ’åºæ–¹å¼
                    this.sortBy = sortBy;
                    
                    // å¦‚æœè®¾ç½®äº†ä»·æ ¼åŒºé—´ï¼Œå…ˆæ›´æ–°åç«¯é…ç½®
                    if (minPrice > 0 && maxPrice > 0 && minPrice < maxPrice) {
                        await this.updatePriceRange(parseFloat(minPrice), parseFloat(maxPrice));
                    }
                    
                    // é‡æ–°åŠ è½½æ•°æ®
                    await this.loadData();
                    
                    // ğŸ”¥ ä¿®å¤ï¼šåº”ç”¨æ’åºå’Œé™åˆ¶
                    this.applySorting();
                    this.applyLimit(parseInt(limit));
                    this.renderItems();
                    this.calculateStatistics();
                    
                                            this.showAlert('success', 'âœ… ç­›é€‰å·²åº”ç”¨');
                } catch (error) {
                    console.error('åº”ç”¨ç­›é€‰å¤±è´¥:', error);
                    this.showAlert('error', 'ç­›é€‰å¤±è´¥: ' + error.message);
                }
            }

            // é‡ç½®ç­›é€‰åŠŸèƒ½
            async resetFilters() {
                try {
                    // æ¸…ç©ºè¾“å…¥æ¡†
                    document.getElementById('minPriceFilter').value = '';
                    document.getElementById('maxPriceFilter').value = '';
                    document.getElementById('sortBy').value = 'price_diff';
                    document.getElementById('limitCount').value = '100';
                    
                    // é‡ç½®æ’åºæ–¹å¼
                    this.sortBy = 'price_diff';
                    
                    // é‡ç½®ä¸ºé»˜è®¤ä»·æ ¼åŒºé—´
                    await this.updatePriceRange(3.0, 5.0);
                    
                    // é‡æ–°åŠ è½½æ•°æ®
                    await this.loadData();
                    
                                            this.showAlert('success', 'âœ… ç­›é€‰å·²é‡ç½®');
                } catch (error) {
                    console.error('é‡ç½®ç­›é€‰å¤±è´¥:', error);
                    this.showAlert('error', 'é‡ç½®å¤±è´¥: ' + error.message);
                }
            }

            // æ›´æ–°ä»·æ ¼åŒºé—´
            async updatePriceRange(min, max) {
                try {
                    const response = await fetch(BASE_PATH + '/api/price_range', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ min: min, max: max })
                    });
                    
                    const result = await response.json();
                    
                    if (!result.success) {
                        throw new Error(result.error || 'æ›´æ–°ä»·æ ¼åŒºé—´å¤±è´¥');
                    }
                    
                    console.log('ä»·æ ¼åŒºé—´å·²æ›´æ–°:', result.message);
                } catch (error) {
                    console.error('æ›´æ–°ä»·æ ¼åŒºé—´å¤±è´¥:', error);
                    throw error;
                }
            }

            async init() {
                this.initMobileSupport();
                this.loadConfig();
                this.loadData();
                this.loadStatus();
                this.loadStatistics();
                
                // ğŸ”¥ ä¿®å¤ï¼šåªåˆ·æ–°çŠ¶æ€å’Œç»Ÿè®¡ï¼Œä¸è‡ªåŠ¨é‡æ–°åŠ è½½æ•°æ®
                setInterval(() => {
                    // åªæœ‰åœ¨éæµå¼åˆ†æçŠ¶æ€ä¸‹æ‰æ›´æ–°æ˜¾ç¤º
                    if (!this.streamingActive) {
                        this.loadData(); // ä»…è·å–ç¼“å­˜æ•°æ®ï¼Œä¸è§¦å‘åˆ†æ
                    }
                    this.loadStatus();
                    this.loadStatistics();
                }, 30000); // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡
            }

            initMobileSupport() {
                // æ£€æµ‹è®¾å¤‡ç±»å‹
                this.isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                this.isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
                
                // æ·»åŠ è®¾å¤‡ç±»å‹åˆ°body
                document.body.classList.add(this.isMobile ? 'is-mobile' : 'is-desktop');
                if (this.isTouch) {
                    document.body.classList.add('is-touch');
                }
                
                // ç§»åŠ¨ç«¯ç‰¹æ®Šå¤„ç†
                if (this.isMobile) {
                    this.setupMobileEvents();
                    this.adjustMobileLayout();
                }
            }

            setupMobileEvents() {
                // ç§»åŠ¨ç«¯ä¸‹æ‹‰åˆ·æ–°
                let startY = 0;
                let isScrolling = false;
                
                document.addEventListener('touchstart', (e) => {
                    startY = e.touches[0].clientY;
                    isScrolling = window.scrollY === 0;
                }, { passive: true });
                
                document.addEventListener('touchmove', (e) => {
                    if (!isScrolling) return;
                    
                    const currentY = e.touches[0].clientY;
                    const diffY = currentY - startY;
                    
                    if (diffY > 100 && window.scrollY === 0) {
                        // ä¸‹æ‹‰åˆ·æ–°
                        this.showAlert('info', 'ğŸ”„ æ­£åœ¨åˆ·æ–°æ•°æ®...');
                        this.loadData();
                    }
                }, { passive: true });
                
                // ç§»åŠ¨ç«¯é”®ç›˜é€‚é…
                const viewport = document.querySelector('meta[name=viewport]');
                document.addEventListener('focusin', () => {
                    if (viewport) {
                        viewport.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no';
                    }
                });
                
                document.addEventListener('focusout', () => {
                    if (viewport) {
                        viewport.content = 'width=device-width, initial-scale=1.0';
                    }
                });
            }

            adjustMobileLayout() {
                // è°ƒæ•´ç§»åŠ¨ç«¯å¸ƒå±€
                const container = document.querySelector('.max-w-7xl');
                if (container) {
                    container.classList.add('mobile-optimized');
                }
                
                // ä¼˜åŒ–æŒ‰é’®å¤§å°
                const buttons = document.querySelectorAll('button');
                buttons.forEach(btn => {
                    if (!btn.classList.contains('touch-target')) {
                        btn.classList.add('touch-target');
                    }
                });
            }

            async loadData() {
                const loading = document.getElementById('loading');
                const itemsList = document.getElementById('itemsList');
                
                loading.classList.remove('hidden');
                itemsList.classList.add('hidden');
                
                try {
                    // ğŸ”¥ ä¿®å¤ï¼šåªè·å–ç¼“å­˜æ•°æ®ï¼Œä¸è‡ªåŠ¨è§¦å‘åˆ†æ
                    const response = await fetch(BASE_PATH + '/api/data');
                    const result = await response.json();
                    
                    if (result.success) {
                        this.items = result.data.items;
                        document.getElementById('totalCount').textContent = this.items.length;
                        
                        // ğŸ”¥ ä¿®å¤ï¼šè‡ªåŠ¨åº”ç”¨å½“å‰çš„æ’åºè®¾ç½®
                        if (this.sortBy) {
                            this.applySorting();
                        }
                        
                        this.renderItems();
                        this.calculateStatistics();
                        
                        // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºæç¤º
                        if (this.items.length === 0) {
                            itemsList.innerHTML = `<div class="p-8 text-center text-gray-500">
                                <div class="text-lg mb-2">ğŸ“Š æš‚æ— ä»·å·®æ•°æ®</div>
                                <div class="text-sm">ç³»ç»Ÿä¼šè‡ªåŠ¨åœ¨åå°è¿›è¡Œå¢é‡åˆ†æï¼Œè¯·ç¨ç­‰ç‰‡åˆ»</div>
                            </div>`;
                        }
                    } else {
                        itemsList.innerHTML = `<div class="p-8 text-center text-red-500">åŠ è½½å¤±è´¥: ${result.error}</div>`;
                    }
                } catch (error) {
                    console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                    itemsList.innerHTML = `<div class="p-8 text-center text-red-500">ç½‘ç»œé”™è¯¯: ${error.message}</div>`;
                } finally {
                    if (!this.streamingActive) {
                        loading.classList.add('hidden');
                    }
                }
            }

            // ğŸ”¥ æ–°å¢ï¼šæµå¼æ›´æ–°æ–¹æ³•
            startStreamingUpdate() {
                if (this.streamingActive) return;
                
                this.streamingActive = true;
                this.showStreamingProgress();
                
                const eventSource = new EventSource(BASE_PATH + '/api/stream_analyze');
                
                eventSource.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        this.handleStreamingUpdate(data);
                    } catch (e) {
                        console.error('è§£ææµå¼æ•°æ®å¤±è´¥:', e);
                    }
                };
                
                eventSource.onerror = (error) => {
                    console.error('æµå¼è¿æ¥é”™è¯¯:', error);
                    eventSource.close();
                    this.streamingActive = false;
                    this.hideStreamingProgress();
                };
                
                // ä¿å­˜å¼•ç”¨ä»¥ä¾¿åç»­å…³é—­
                this.eventSource = eventSource;
            }

            // ğŸ”¥ æ–°å¢ï¼šå¤„ç†æµå¼æ›´æ–°æ•°æ®
            handleStreamingUpdate(data) {
                const { type, message } = data;
                
                switch (type) {
                    case 'progress':
                        this.updateStreamingProgress(data);
                        break;
                        
                    case 'incremental_results':
                        this.addIncrementalResults(data);
                        break;
                        
                    case 'completed':
                        this.completeStreamingUpdate(data);
                        break;
                        
                    case 'error':
                        this.showAlert('error', `æµå¼æ›´æ–°é”™è¯¯: ${data.error}`);
                        this.stopStreaming();
                        break;
                }
            }

            // ğŸ”¥ æ–°å¢ï¼šæ˜¾ç¤ºæµå¼è¿›åº¦
            showStreamingProgress() {
                const loading = document.getElementById('loading');
                if (loading) {
                    loading.innerHTML = `
                        <div class="flex flex-col items-center justify-center p-8">
                            <div class="w-64 bg-gray-200 rounded-full h-2 mb-4">
                                <div id="streamProgress" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <div class="loading text-blue-600 text-2xl mb-2">
                                <i class="fas fa-spinner"></i>
                            </div>
                            <span id="streamStatus" class="text-gray-600">å¼€å§‹æµå¼åˆ†æ...</span>
                            <div class="mt-4 text-sm text-gray-500">
                                <div>å·²å¤„ç†: <span id="streamProcessed">0</span> ä¸ªå•†å“</div>
                                <div>æ–°å‘ç°: <span id="streamFound">0</span> ä¸ªä»·å·®å•†å“</div>
                            </div>
                        </div>
                    `;
                    loading.classList.remove('hidden');
                }
            }

            // ğŸ”¥ æ–°å¢ï¼šæ›´æ–°æµå¼è¿›åº¦
            updateStreamingProgress(data) {
                const progress = data.progress || 0;
                const message = data.message || '';
                
                const progressBar = document.getElementById('streamProgress');
                const statusText = document.getElementById('streamStatus');
                
                if (progressBar) {
                    progressBar.style.width = `${progress}%`;
                }
                
                if (statusText) {
                    statusText.textContent = message;
                }
            }

            // ğŸ”¥ æ–°å¢ï¼šæ·»åŠ å¢é‡ç»“æœ
            addIncrementalResults(data) {
                const newItems = data.data || [];
                const totalFound = data.total_found || 0;
                const totalProcessed = data.total_processed || 0;
                
                // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
                const processedElement = document.getElementById('streamProcessed');
                const foundElement = document.getElementById('streamFound');
                
                if (processedElement) {
                    processedElement.textContent = totalProcessed.toLocaleString();
                }
                
                if (foundElement) {
                    foundElement.textContent = totalFound.toLocaleString();
                }
                
                // æ·»åŠ æ–°å•†å“åˆ°åˆ—è¡¨
                if (newItems.length > 0) {
                    this.items = [...this.items, ...newItems];
                    
                    // é‡æ–°æ’åºå’Œæ¸²æŸ“
                    this.applySorting();
                    this.renderItems();
                    
                    // æ›´æ–°æ€»æ•°
                    document.getElementById('totalCount').textContent = this.items.length;
                    
                    // é‡æ–°è®¡ç®—ç»Ÿè®¡
                    this.calculateStatistics();
                    
                    // æ˜¾ç¤ºå¢é‡æç¤º
                                            this.showAlert('success', `ğŸ‰ æ–°å‘ç° ${newItems.length} ä¸ªä»·å·®å•†å“ï¼`);
                }
            }

            // ğŸ”¥ æ–°å¢ï¼šå®Œæˆæµå¼æ›´æ–°
            completeStreamingUpdate(data) {
                const totalFound = data.total_found || 0;
                const totalProcessed = data.total_processed || 0;
                
                                        this.showAlert('success', `ğŸ¯ åˆ†æå®Œæˆï¼å¤„ç†äº† ${totalProcessed.toLocaleString()} ä¸ªå•†å“ï¼Œå‘ç° ${totalFound.toLocaleString()} ä¸ªä»·å·®å•†å“`);
                this.stopStreaming();
            }

            // ğŸ”¥ æ–°å¢ï¼šåœæ­¢æµå¼æ›´æ–°
            stopStreaming() {
                if (this.eventSource) {
                    this.eventSource.close();
                    this.eventSource = null;
                }
                
                this.streamingActive = false;
                this.hideStreamingProgress();
            }

            // ğŸ”¥ æ–°å¢ï¼šéšè—æµå¼è¿›åº¦
            hideStreamingProgress() {
                const loading = document.getElementById('loading');
                if (loading) {
                    loading.classList.add('hidden');
                }
            }

            updateTable(items) {
                this.items = items || [];
                this.renderItems();
            }

            async loadStatistics() {
                try {
                    // ç§»é™¤ç»Ÿè®¡ä¿¡æ¯APIè°ƒç”¨ï¼Œç›´æ¥ä½¿ç”¨statusæ¥å£çš„æ•°æ®
                    const response = await fetch(BASE_PATH + '/api/status');
                    const result = await response.json();
                    
                    if (result.success) {
                        const data = result.data;
                        
                        // ä¿®æ­£å…ƒç´ IDï¼šä»totalItemsæ”¹ä¸ºtotalCount
                        const totalCountElement = document.getElementById('totalCount');
                        const avgDiffElement = document.getElementById('avgDiff');
                        const maxDiffElement = document.getElementById('maxDiff');
                        
                        if (totalCountElement) {
                            totalCountElement.textContent = data.current_items_count || 0;
                        }
                        if (avgDiffElement) {
                            avgDiffElement.textContent = 'è®¡ç®—ä¸­...';
                        }
                        if (maxDiffElement) {
                            maxDiffElement.textContent = 'è®¡ç®—ä¸­...';
                        }
                        
                        // å¦‚æœæœ‰å•†å“æ•°æ®ï¼Œè·å–æ›´è¯¦ç»†çš„ç»Ÿè®¡
                        if (data.current_items_count > 0) {
                            await this.loadDetailedStatistics();
                        }
                    }
                } catch (error) {
                    console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
                }
            }

            async loadDetailedStatistics() {
                try {
                    const response = await fetch(BASE_PATH + '/api/data');
                    const result = await response.json();
                    
                    if (result.success && result.data.items.length > 0) {
                        const items = result.data.items;
                        const totalDiff = items.reduce((sum, item) => sum + item.price_diff, 0);
                        const avgDiff = totalDiff / items.length;
                        const maxDiff = Math.max(...items.map(item => item.price_diff || 0));
                        
                        const avgDiffElement = document.getElementById('avgDiff');
                        const maxDiffElement = document.getElementById('maxDiff');
                        
                        if (avgDiffElement) {
                            avgDiffElement.textContent = `Â¥${avgDiff.toFixed(2)}`;
                        }
                        if (maxDiffElement) {
                            maxDiffElement.textContent = `Â¥${maxDiff.toFixed(2)}`;
                        }
                    }
                } catch (error) {
                    console.error('åŠ è½½è¯¦ç»†ç»Ÿè®¡å¤±è´¥:', error);
                }
            }

            async loadStatus() {
                try {
                    const response = await fetch(BASE_PATH + '/api/status');
                    const result = await response.json();
                    
                    if (result.success) {
                        this.updateStatus(result.data);
                    }
                } catch (error) {
                    console.error('æ£€æŸ¥çŠ¶æ€å¤±è´¥:', error);
                }
            }

            updateStatus(status) {
                const lastUpdate = status.last_update ? 
                    new Date(status.last_update).toLocaleString('zh-CN') : 'æœªçŸ¥';
                document.getElementById('lastUpdate').textContent = lastUpdate;
                
                // æ›´æ–°ç›‘æ§çŠ¶æ€
                const statusElement = document.getElementById('updateStatus');
                if (statusElement) {
                    const isRunning = status.is_running;
                    statusElement.innerHTML = `
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${isRunning ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            <i class="fas ${isRunning ? 'fa-play' : 'fa-pause'} mr-1"></i>
                            ${isRunning ? 'ç›‘æ§ä¸­' : 'å·²åœæ­¢'}
                        </span>
                    `;
                }
            }

            renderItems() {
                const loading = document.getElementById('loading');
                const itemsList = document.getElementById('itemsList');
                
                loading.classList.add('hidden');
                itemsList.classList.remove('hidden');
                
                if (this.items.length === 0) {
                    itemsList.innerHTML = `
                        <div class="p-8 text-center text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-4"></i>
                            <p>æš‚æ— ç¬¦åˆæ¡ä»¶çš„å·®ä»·é¥°å“</p>
                        </div>
                    `;
                    return;
                }
                
                const itemsHtml = this.items.map(item => this.renderItem(item)).join('');
                itemsList.innerHTML = itemsHtml;
            }

            renderItem(item) {
                const profitClass = this.getProfitClass(item.profit_rate || 0);
                const imageUrl = item.image_url || '/static/placeholder.png';
                
                return `
                    <div class="border-b border-gray-200 p-3 sm:p-6 card-hover">
                        <!-- æ¡Œé¢ç«¯å¸ƒå±€ -->
                        <div class="hidden sm:flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <img src="${imageUrl}" alt="${item.name}" 
                                     class="w-16 h-16 rounded-lg object-cover bg-gray-100"
                                     onerror="this.src='/static/placeholder.png'">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 mb-1">${item.name}</h3>
                                    <div class="flex items-center space-x-4 text-sm text-gray-600">
                                        <span>Buff: <span class="font-medium text-red-600">Â¥${item.buff_price}</span></span>
                                        <span>æ‚ æ‚ : <span class="font-medium text-green-600">Â¥${item.youpin_price}</span></span>
                                        <span class="text-xs ${profitClass} text-white px-2 py-1 rounded-full">
                                            åˆ©æ¶¦ç‡ ${(item.profit_rate || 0).toFixed(1)}%
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex items-center space-x-4">
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-green-600">
                                        +Â¥${(item.price_diff || 0).toFixed(2)}
                                    </div>
                                    <div class="text-sm text-gray-500">ä»·å·®</div>
                                </div>
                                
                                <button onclick="window.open('${item.buff_url || '#'}', '_blank')" 
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition duration-200 flex items-center">
                                    <i class="fas fa-external-link-alt mr-2"></i>
                                    ç«‹å³è´­ä¹°
                                </button>
                            </div>
                        </div>

                        <!-- ç§»åŠ¨ç«¯å¸ƒå±€ -->
                        <div class="sm:hidden">
                            <div class="flex items-start space-x-3 mb-3">
                                <img src="${imageUrl}" alt="${item.name}" 
                                     class="w-12 h-12 rounded-lg object-cover bg-gray-100 flex-shrink-0"
                                     onerror="this.src='/static/placeholder.png'">
                                <div class="flex-1 min-w-0">
                                    <h3 class="text-sm font-semibold text-gray-900 mb-1 truncate" title="${item.name}">${item.name}</h3>
                                    <div class="flex flex-wrap gap-1 text-xs text-gray-600">
                                        <span class="bg-red-50 text-red-700 px-2 py-1 rounded">Buff: Â¥${item.buff_price}</span>
                                        <span class="bg-green-50 text-green-700 px-2 py-1 rounded">æ‚ æ‚ : Â¥${item.youpin_price}</span>
                                    </div>
                                </div>
                            </div>

                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="text-center">
                                        <div class="text-lg font-bold text-green-600">
                                            +Â¥${(item.price_diff || 0).toFixed(2)}
                                        </div>
                                        <div class="text-xs text-gray-500">ä»·å·®</div>
                                    </div>
                                    <span class="text-xs ${profitClass} text-white px-2 py-1 rounded-full">
                                        ${(item.profit_rate || 0).toFixed(1)}%
                                    </span>
                                </div>
                                
                                <button onclick="window.open('${item.buff_url || '#'}', '_blank')" 
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition duration-200 flex items-center text-sm touch-target">
                                    <i class="fas fa-external-link-alt mr-1"></i>
                                    è´­ä¹°
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            getProfitClass(margin) {
                if (margin >= 50) return 'profit-very-high';
                if (margin >= 30) return 'profit-high';
                return 'profit-positive';
            }

            openSettings() {
                document.getElementById('settingsModal').classList.remove('hidden');
                this.loadConfig();
            }

            closeSettings() {
                document.getElementById('settingsModal').classList.add('hidden');
            }

            async loadConfig() {
                console.log('ğŸ”„ å¼€å§‹åŠ è½½é…ç½®...');
                try {
                    // åŠ è½½è®¾ç½®
                    const settingsResponse = await fetch(BASE_PATH + '/api/settings');
                    const settingsResult = await settingsResponse.json();
                    
                    if (settingsResult.success) {
                        const data = settingsResult.data;
                        document.getElementById('thresholdInput').value = data.threshold || '';
                        document.getElementById('maxOutputItems').value = data.max_output_items || '';
                        
                        if (data.price_range) {
                            document.getElementById('priceRangeMin').value = data.price_range.min || '';
                            document.getElementById('priceRangeMax').value = data.price_range.max || '';
                        }
                        
                        if (data.buff_price_range) {
                            const buffMinEl = document.getElementById('buffPriceMin');
                            const buffMaxEl = document.getElementById('buffPriceMax');
                            
                            if (buffMinEl && data.buff_price_range.min !== null && data.buff_price_range.min !== undefined) {
                                buffMinEl.value = data.buff_price_range.min;
                            }
                            if (buffMaxEl && data.buff_price_range.max !== null && data.buff_price_range.max !== undefined) {
                                buffMaxEl.value = data.buff_price_range.max;
                            }
                            
                            console.log('ğŸ”§ Buffä»·æ ¼åŒºé—´å·²è®¾ç½®:', data.buff_price_range);
                        } else {
                            console.warn('âš ï¸ æœªæ”¶åˆ°buff_price_rangeæ•°æ®');
                        }
                        
                        if (data.buff_sell_num) {
                            const buffSellNumInput = document.getElementById('buffSellNumMin');
                            if (buffSellNumInput && data.buff_sell_num.min !== null && data.buff_sell_num.min !== undefined) {
                                buffSellNumInput.value = data.buff_sell_num.min;
                            }
                            console.log('ğŸ”§ Buffåœ¨å”®æ•°é‡è®¾ç½®å·²åŠ è½½:', data.buff_sell_num.min);
                        }
                        
                        if (data.update_intervals) {
                            const fullInterval = document.getElementById('fullUpdateInterval');
                            const incrementalInterval = document.getElementById('incrementalUpdateInterval');
                            
                            if (fullInterval) {
                                fullInterval.textContent = `${data.update_intervals.full_update_hours}å°æ—¶`;
                            }
                            
                            if (incrementalInterval) {
                                incrementalInterval.textContent = `${data.update_intervals.incremental_update_minutes}åˆ†é’Ÿ`;
                            }
                        }
                    }

                    // åŠ è½½å½“å‰ä»·æ ¼åŒºé—´
                    const rangeResponse = await fetch(BASE_PATH + '/api/price_range');
                    const rangeResult = await rangeResponse.json();
                    
                    if (rangeResult.success) {
                        const currentRange = document.getElementById('currentPriceRange');
                        if (currentRange) {
                            currentRange.textContent = rangeResult.data.current_range;
                        }
                    }
                    
                    // åŠ è½½Buffä»·æ ¼ç­›é€‰åŒºé—´
                    const buffRangeResponse = await fetch(BASE_PATH + '/api/buff_price_range');
                    const buffRangeResult = await buffRangeResponse.json();
                    
                    if (buffRangeResult.success) {
                        const currentBuffRange = document.getElementById('currentBuffPriceRange');
                        if (currentBuffRange) {
                            currentBuffRange.textContent = buffRangeResult.data.current_range;
                        }
                    }
                    
                    // åŠ è½½Buffåœ¨å”®æ•°é‡ç­›é€‰ï¼ˆæ˜¾ç¤ºå½“å‰å€¼ï¼‰
                    const buffSellNumResponse = await fetch(BASE_PATH + '/api/buff_sell_num');
                    const buffSellNumResult = await buffSellNumResponse.json();
                    
                    if (buffSellNumResult.success) {
                        const currentBuffSellNum = document.getElementById('currentBuffSellNum');
                        if (currentBuffSellNum) {
                            currentBuffSellNum.textContent = `â‰¥ ${buffSellNumResult.data.min_sell_num} ä¸ª`;
                        }
                        console.log('ğŸ”§ Buffåœ¨å”®æ•°é‡å½“å‰å€¼å·²æ˜¾ç¤º:', buffSellNumResult.data.min_sell_num);
                    }
                } catch (error) {
                    console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
                }
            }

            async saveSettings() {
                try {
                    const threshold = document.getElementById('thresholdInput').value;
                    const priceMin = document.getElementById('priceRangeMin').value;
                    const priceMax = document.getElementById('priceRangeMax').value;
                    const buffPriceMin = document.getElementById('buffPriceMin').value;
                    const buffPriceMax = document.getElementById('buffPriceMax').value;
                    const buffSellNumMin = document.getElementById('buffSellNumMin').value;
                    const maxOutputItems = document.getElementById('maxOutputItems').value;
                    
                    // éªŒè¯ä»·æ ¼åŒºé—´
                    if (priceMin && priceMax) {
                        const min = parseFloat(priceMin);
                        const max = parseFloat(priceMax);
                        
                        if (min >= max) {
                            this.showAlert('error', 'æœ€å°ä»·å·®å¿…é¡»å°äºæœ€å¤§ä»·å·®');
                            return;
                        }
                        
                        if (min < 0 || max < 0) {
                            this.showAlert('error', 'ä»·å·®ä¸èƒ½ä¸ºè´Ÿæ•°');
                            return;
                        }
                    }
                    
                    // éªŒè¯Buffä»·æ ¼åŒºé—´
                    if (buffPriceMin && buffPriceMax) {
                        const min = parseFloat(buffPriceMin);
                        const max = parseFloat(buffPriceMax);
                        
                        if (min >= max) {
                            this.showAlert('error', 'Buffæœ€å°ä»·æ ¼å¿…é¡»å°äºæœ€å¤§ä»·æ ¼');
                            return;
                        }
                        
                        if (min < 0 || max < 0) {
                            this.showAlert('error', 'Buffä»·æ ¼ä¸èƒ½ä¸ºè´Ÿæ•°');
                            return;
                        }
                    }
                    
                    // éªŒè¯Buffåœ¨å”®æ•°é‡
                    if (buffSellNumMin) {
                        const num = parseInt(buffSellNumMin);
                        
                        if (num < 0) {
                            this.showAlert('error', 'Buffåœ¨å”®æ•°é‡ä¸èƒ½ä¸ºè´Ÿæ•°');
                            return;
                        }
                    }
                    
                    const updateData = {};
                    
                    if (threshold) {
                        updateData.threshold = parseFloat(threshold);
                    }
                    
                    if (priceMin && priceMax) {
                        updateData.price_min = parseFloat(priceMin);
                        updateData.price_max = parseFloat(priceMax);
                    }
                    
                    if (buffPriceMin && buffPriceMax) {
                        updateData.buff_price_min = parseFloat(buffPriceMin);
                        updateData.buff_price_max = parseFloat(buffPriceMax);
                    }
                    
                    if (buffSellNumMin) {
                        updateData.buff_sell_num_min = parseInt(buffSellNumMin);
                    }
                    
                    if (maxOutputItems) {
                        updateData.max_output_items = parseInt(maxOutputItems);
                    }
                    
                    if (Object.keys(updateData).length === 0) {
                        this.showAlert('warning', 'âš ï¸ æ²¡æœ‰è®¾ç½®éœ€è¦ä¿å­˜');
                        return;
                    }
                    
                    const response = await fetch(BASE_PATH + '/api/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updateData)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // ğŸ”¥ ä¼˜åŒ–ï¼šå…ˆæ˜¾ç¤ºæˆåŠŸæç¤ºï¼Œç¨åå…³é—­è®¾ç½®çª—å£
                        this.showAlert('success', 'âœ… è®¾ç½®ä¿å­˜æˆåŠŸï¼' + result.message);
                        
                        // é‡æ–°åŠ è½½é…ç½®æ˜¾ç¤º
                        setTimeout(() => this.loadConfig(), 500);
                        
                        // ğŸ”¥ å»¶è¿Ÿå…³é—­è®¾ç½®çª—å£ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸæç¤º
                        setTimeout(() => {
                            this.closeSettings();
                            // é‡æ–°åŠ è½½æ•°æ®
                            this.loadData();
                        }, 2000);
                        
                    } else {
                        this.showAlert('error', 'âŒ ä¿å­˜å¤±è´¥: ' + result.error);
                    }
                } catch (error) {
                    console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error);
                    this.showAlert('error', 'ä¿å­˜å¤±è´¥: ' + error.message);
                }
            }

            // ğŸ”¥ æ–°å¢ï¼šå¼ºåˆ¶å…¨é‡æ›´æ–°
            async forceFullUpdate() {
                const btn = document.getElementById('forceFullUpdate');
                const originalText = btn.innerHTML;
                
                try {
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>æ­£åœ¨æ›´æ–°...';
                    btn.disabled = true;
                    
                    const response = await fetch(BASE_PATH + '/api/force_update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.showAlert('success', 'ğŸš€ ' + result.message);
                        // å»¶è¿Ÿé‡æ–°åŠ è½½æ•°æ®
                        setTimeout(() => this.loadData(), 2000);
                    } else {
                        this.showAlert('error', 'âŒ å…¨é‡æ›´æ–°å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                } catch (error) {
                    console.error('å¼ºåˆ¶å…¨é‡æ›´æ–°å¤±è´¥:', error);
                    this.showAlert('error', 'å…¨é‡æ›´æ–°å¤±è´¥: ' + error.message);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
            
            // ğŸ”¥ æ–°å¢ï¼šå¼ºåˆ¶å¢é‡æ›´æ–°
            async forceIncrementalUpdate() {
                const btn = document.getElementById('forceIncrementalUpdate');
                const originalText = btn.innerHTML;
                
                try {
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>æ­£åœ¨æ›´æ–°...';
                    btn.disabled = true;
                    
                    const response = await fetch(BASE_PATH + '/api/force_incremental_update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.showAlert('success', 'âš¡ ' + result.message);
                        // å»¶è¿Ÿé‡æ–°åŠ è½½æ•°æ®
                        setTimeout(() => this.loadData(), 1000);
                    } else {
                        this.showAlert('error', 'âŒ å¢é‡æ›´æ–°å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                } catch (error) {
                    console.error('å¼ºåˆ¶å¢é‡æ›´æ–°å¤±è´¥:', error);
                    this.showAlert('error', 'å¢é‡æ›´æ–°å¤±è´¥: ' + error.message);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }

            // ğŸ”¥ æ–°å¢ï¼šå¢å¼ºå¢é‡æ›´æ–°ï¼ˆæ”¯æŒä»·æ ¼æ›´æ–°å’Œå®Œæˆæ ‡è¯†ï¼‰
            async enhancedIncrementalUpdate() {
                const btn = document.getElementById('enhancedIncrementalUpdate');
                const originalText = btn.innerHTML;
                
                try {
                    // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> å¯åŠ¨ä¸­...';
                    
                    this.showAlert('info', 'ğŸš€ æ­£åœ¨å¯åŠ¨å¢å¼ºå¢é‡æ›´æ–°...');
                    
                    const response = await fetch(BASE_PATH + '/api/enhanced_incremental_update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.showAlert('success', result.message);
                        
                        // å¼€å§‹è½®è¯¢çŠ¶æ€
                        this.startEnhancedUpdateStatusPolling(btn, originalText);
                    } else {
                        this.showAlert('error', `âŒ ${result.message}`);
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                } catch (error) {
                    console.error('å¢å¼ºå¢é‡æ›´æ–°å¤±è´¥:', error);
                    this.showAlert('error', 'å¢å¼ºå¢é‡æ›´æ–°å¤±è´¥: ' + error.message);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }

            // ğŸ”¥ æ–°å¢ï¼šå¼€å§‹çŠ¶æ€è½®è¯¢
            startEnhancedUpdateStatusPolling(btn, originalText) {
                const pollInterval = setInterval(async () => {
                    try {
                        const response = await fetch(BASE_PATH + '/api/incremental_update_status');
                        const result = await response.json();
                        
                        if (result.success) {
                            const status = result.data;
                            
                            if (status.is_running) {
                                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                                const progress = status.completion_percentage || 0;
                                const task = status.current_task || 'å¤„ç†ä¸­';
                                btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-1"></i> ${task} (${progress}%)`;
                                
                                // æ˜¾ç¤ºè¿›åº¦ä¿¡æ¯
                                if (status.processed_count > 0) {
                                    this.showAlert('info', 
                                        `ğŸ”„ ${task} - å·²å¤„ç†: ${status.processed_count} ä¸ªå•†å“ï¼Œå·²æ›´æ–°: ${status.updated_count} ä¸ªä»·æ ¼`, 
                                        false); // ä¸è‡ªåŠ¨éšè—
                                }
                            } else {
                                // æ›´æ–°å®Œæˆ
                                clearInterval(pollInterval);
                                btn.innerHTML = originalText;
                                btn.disabled = false;
                                
                                // é‡æ–°åŠ è½½æ•°æ®
                                await this.loadData();
                                
                                // æ˜¾ç¤ºå®Œæˆé€šçŸ¥
                                const successMsg = status.updated_count > 0 ? 
                                    `âœ… å¢å¼ºå¢é‡æ›´æ–°å®Œæˆï¼å¤„ç†äº† ${status.processed_count} ä¸ªå•†å“ï¼Œæ›´æ–°äº† ${status.updated_count} ä¸ªä»·æ ¼` :
                                    `âœ… å¢é‡æ›´æ–°å®Œæˆï¼å·²æ£€æŸ¥ ${status.processed_count} ä¸ªå•†å“ï¼Œæš‚æ— ä»·æ ¼å˜åŒ–`;
                                
                                this.showAlert('success', successMsg);
                            }
                        } else {
                            throw new Error(result.message || 'è·å–çŠ¶æ€å¤±è´¥');
                        }
                    } catch (error) {
                        console.error('è·å–æ›´æ–°çŠ¶æ€å¤±è´¥:', error);
                        clearInterval(pollInterval);
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                        this.showAlert('error', 'è·å–æ›´æ–°çŠ¶æ€å¤±è´¥: ' + error.message);
                    }
                }, 3000); // æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡çŠ¶æ€
            }

            showAlert(type, message) {
                // ğŸ”¥ ä¼˜åŒ–ï¼šæ¯æ¬¡åˆ›å»ºæ–°çš„æç¤ºæ¡†ï¼Œæ”¯æŒå¤šä¸ªæç¤ºåŒæ—¶æ˜¾ç¤º
                const alertDiv = document.createElement('div');
                
                // ç§»åŠ¨ç«¯é€‚é…ï¼šè°ƒæ•´ä½ç½®å’Œå®½åº¦
                const isMobile = window.innerWidth <= 768;
                alertDiv.className = isMobile 
                    ? 'fixed top-4 left-2 right-2 z-50 mb-2' 
                    : 'fixed top-4 right-4 z-50 max-w-sm mb-2';
                
                // ğŸ”¥ ä¼˜åŒ–ï¼šæ ¹æ®ç±»å‹è®¾ç½®ä¸åŒçš„æ ·å¼å’ŒåŠ¨ç”»
                const alertClass = type === 'success' ? 'bg-green-500 text-white border-green-600 shadow-lg' : 
                                  type === 'warning' ? 'bg-yellow-500 text-white border-yellow-600 shadow-lg' :
                                  type === 'info' ? 'bg-blue-500 text-white border-blue-600 shadow-lg' :
                                  'bg-red-500 text-white border-red-600 shadow-lg';
                
                const icon = type === 'success' ? 'check-circle' : 
                            type === 'warning' ? 'exclamation-triangle' : 
                            type === 'info' ? 'info-circle' :
                            'times-circle';
                
                // ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼šè°ƒæ•´å­—ä½“å¤§å°å’Œé—´è·
                const textSize = isMobile ? 'text-sm' : 'text-base';
                const iconSize = isMobile ? 'text-base' : 'text-lg';
                const padding = isMobile ? 'p-3' : 'p-4';
                const translateX = isMobile ? 'translate-y-full' : 'translate-x-full';
                
                alertDiv.innerHTML = `
                    <div class="border ${alertClass} rounded-lg ${padding} transform transition-all duration-300 ${translateX} opacity-0" id="alertContent">
                        <div class="flex items-center">
                            <i class="fas fa-${icon} mr-2 sm:mr-3 ${iconSize} flex-shrink-0"></i>
                            <span class="font-medium ${textSize} flex-1 min-w-0 pr-2">${message}</span>
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                    class="flex-shrink-0 text-white hover:text-gray-200 touch-target p-1">
                                <i class="fas fa-times text-sm"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(alertDiv);
                
                // ğŸ”¥ æ·»åŠ æ»‘å…¥åŠ¨ç”»
                setTimeout(() => {
                    const content = alertDiv.querySelector('#alertContent');
                    if (isMobile) {
                        content.classList.remove('translate-y-full', 'opacity-0');
                        content.classList.add('translate-y-0', 'opacity-100');
                    } else {
                        content.classList.remove('translate-x-full', 'opacity-0');
                        content.classList.add('translate-x-0', 'opacity-100');
                    }
                }, 100);
                
                // ğŸ”¥ ä¼˜åŒ–ï¼šæˆåŠŸæç¤ºæ˜¾ç¤ºæ›´é•¿æ—¶é—´ï¼Œç§»åŠ¨ç«¯æ—¶é—´ç¨çŸ­
                const baseDelay = isMobile ? 3000 : 4000;
                const hideDelay = type === 'success' ? baseDelay : 
                                 type === 'error' ? baseDelay + 2000 : 
                                 baseDelay - 1000;
                
                // è‡ªåŠ¨éšè—
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        const content = alertDiv.querySelector('#alertContent');
                        if (isMobile) {
                            content.classList.add('translate-y-full', 'opacity-0');
                        } else {
                            content.classList.add('translate-x-full', 'opacity-0');
                        }
                        setTimeout(() => alertDiv.remove(), 300);
                    }
                }, hideDelay);
            }

            // Tokenç®¡ç†æ–¹æ³•
            showGeneralTab() {
                document.getElementById('generalTab').className = 'px-4 py-2 font-medium text-blue-600 border-b-2 border-blue-600';
                document.getElementById('tokensTab').className = 'px-4 py-2 font-medium text-gray-600 hover:text-blue-600 ml-4';
                document.getElementById('generalPanel').classList.remove('hidden');
                document.getElementById('tokensPanel').classList.add('hidden');
            }
            
            showTokenTab() {
                document.getElementById('generalTab').className = 'px-4 py-2 font-medium text-gray-600 hover:text-blue-600';
                document.getElementById('tokensTab').className = 'px-4 py-2 font-medium text-blue-600 border-b-2 border-blue-600 ml-4';
                document.getElementById('generalPanel').classList.add('hidden');
                document.getElementById('tokensPanel').classList.remove('hidden');
                
                // åŠ è½½TokençŠ¶æ€
                this.loadTokenStatus();
            }
            
            async loadTokenStatus() {
                try {
                    const response = await fetch(BASE_PATH + '/api/tokens/status');
                    const result = await response.json();
                    
                    if (result.success) {
                        const { buff, youpin } = result.data;
                        
                        // æ›´æ–°BuffçŠ¶æ€
                        const buffStatus = document.getElementById('buffTokenStatus');
                        const buffValidationStatus = this.getValidationStatusBadge(buff);
                        buffStatus.innerHTML = buffValidationStatus;
                        
                        // æ›´æ–°æ‚ æ‚ æœ‰å“çŠ¶æ€
                        const youpinStatus = document.getElementById('youpinTokenStatus');
                        const youpinValidationStatus = this.getValidationStatusBadge(youpin);
                        youpinStatus.innerHTML = youpinValidationStatus;
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰å¤±æ•ˆçš„token
                        this.checkTokenValidity(buff, youpin);
                    }
                } catch (error) {
                    console.error('åŠ è½½TokençŠ¶æ€å¤±è´¥:', error);
                }
            }

            getValidationStatusBadge(tokenInfo) {
                const configured = tokenInfo.configured || (tokenInfo.has_cookies && tokenInfo.has_csrf) || (tokenInfo.has_device_id && tokenInfo.has_uk);
                const cachedValid = tokenInfo.cached_valid;
                const lastValidation = tokenInfo.last_validation;
                const cachedError = tokenInfo.cached_error;
                
                let statusClass = 'bg-gray-100 text-gray-800';
                let statusText = 'æœªé…ç½®';
                let statusIcon = 'â“';
                
                if (configured) {
                    if (cachedValid === true) {
                        statusClass = 'bg-green-100 text-green-800';
                        statusText = 'å·²éªŒè¯';
                        statusIcon = 'âœ…';
                    } else if (cachedValid === false && cachedError) {
                        if (cachedError.includes('å¤±æ•ˆ') || cachedError.includes('ç™»å½•') || cachedError.includes('401') || cachedError.includes('403')) {
                            statusClass = 'bg-red-100 text-red-800';
                            statusText = 'Tokenå·²å¤±æ•ˆ';
                            statusIcon = 'âŒ';
                        } else {
                            statusClass = 'bg-yellow-100 text-yellow-800';
                            statusText = 'éªŒè¯å¤±è´¥';
                            statusIcon = 'âš ï¸';
                        }
                    } else {
                        statusClass = 'bg-blue-100 text-blue-800';
                        statusText = 'å·²é…ç½®';
                        statusIcon = 'ğŸ”‘';
                    }
                }
                
                let tooltipText = '';
                if (lastValidation) {
                    const validationTime = new Date(lastValidation).toLocaleString();
                    tooltipText = `æœ€åéªŒè¯: ${validationTime}`;
                    if (cachedError) {
                        tooltipText += `\né”™è¯¯: ${cachedError}`;
                    }
                }
                
                return `
                    <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium ${statusClass}" 
                          title="${tooltipText}">
                        ${statusIcon} ${statusText}
                    </span>
                `;
            }

            checkTokenValidity(buff, youpin) {
                const invalidTokens = [];
                
                console.log('ğŸ” æ£€æŸ¥Tokenæœ‰æ•ˆæ€§...', { buff, youpin });
                
                // ğŸ”¥ ä¿®å¤ï¼šåªæœ‰åœ¨Tokenç¡®å®å¤±æ•ˆæ—¶æ‰æ˜¾ç¤ºè­¦æŠ¥
                // æ£€æŸ¥Buff Token - åªæœ‰cached_validæ˜ç¡®ä¸ºfalseæ‰æ£€æŸ¥
                if (buff.configured && buff.cached_valid === false && buff.cached_error) {
                    // åªæœ‰çœŸæ­£çš„Tokenå¤±æ•ˆé”™è¯¯æ‰æ˜¾ç¤ºè­¦æŠ¥
                    if (this.isTokenExpiredError(buff.cached_error)) {
                        console.log('âŒ Buff Tokenå¤±æ•ˆ');
                        invalidTokens.push({
                            platform: 'Buff', 
                            error: buff.cached_error
                        });
                    } else {
                        console.log('âš ï¸ Buff TokenéªŒè¯å¤±è´¥ï¼ˆéå¤±æ•ˆï¼‰:', buff.cached_error);
                    }
                } else if (buff.configured && buff.cached_valid === null) {
                    console.log('ğŸ”„ Buff TokençŠ¶æ€æœªçŸ¥ï¼ˆå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜ï¼‰:', buff.cached_error);
                }
                
                // æ£€æŸ¥æ‚ æ‚ æœ‰å“Token - åªæœ‰cached_validæ˜ç¡®ä¸ºfalseæ‰æ£€æŸ¥
                if (youpin.configured && youpin.cached_valid === false && youpin.cached_error) {
                    // åªæœ‰çœŸæ­£çš„Tokenå¤±æ•ˆé”™è¯¯æ‰æ˜¾ç¤ºè­¦æŠ¥
                    if (this.isTokenExpiredError(youpin.cached_error)) {
                        console.log('âŒ æ‚ æ‚ æœ‰å“Tokenå¤±æ•ˆ');
                        invalidTokens.push({
                            platform: 'æ‚ æ‚ æœ‰å“', 
                            error: youpin.cached_error
                        });
                    } else {
                        console.log('âš ï¸ æ‚ æ‚ æœ‰å“TokenéªŒè¯å¤±è´¥ï¼ˆéå¤±æ•ˆï¼‰:', youpin.cached_error);
                    }
                } else if (youpin.configured && youpin.cached_valid === null) {
                    console.log('ğŸ”„ æ‚ æ‚ æœ‰å“TokençŠ¶æ€æœªçŸ¥ï¼ˆå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜ï¼‰:', youpin.cached_error);
                }
                
                console.log('ğŸš¨ å‘ç°å¤±æ•ˆToken:', invalidTokens);
                
                if (invalidTokens.length > 0) {
                    this.showTokenExpiredAlert(invalidTokens);
                } else {
                    console.log('âœ… æ‰€æœ‰TokençŠ¶æ€æ­£å¸¸');
                }
            }

            showTokenExpiredAlert(invalidTokens) {
                const platforms = invalidTokens.map(t => t.platform).join('ã€');
                const errors = invalidTokens.map(t => t.error).join('\n');
                
                const alertHtml = `
                    <div class="fixed top-4 right-4 bg-red-50 border-l-4 border-red-400 p-4 rounded-md shadow-lg z-50 max-w-md" id="tokenExpiredAlert">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-red-800">
                                    ğŸš¨ API Tokenå·²å¤±æ•ˆ
                                </h3>
                                <div class="mt-2 text-sm text-red-700">
                                    <p><strong>${platforms}</strong> çš„API Tokenå·²å¤±æ•ˆï¼Œè¯·é‡æ–°é…ç½®ï¼š</p>
                                    <ul class="list-disc list-inside mt-1">
                                        ${invalidTokens.map(t => `<li>${t.platform}: ${t.error}</li>`).join('')}
                                    </ul>
                                </div>
                                <div class="mt-4">
                                    <div class="flex space-x-2">
                                        <button onclick="app.showConfigPanel()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
                                            ç«‹å³é…ç½®
                                        </button>
                                        <button onclick="app.validateAllTokens()" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm">
                                            é‡æ–°éªŒè¯
                                        </button>
                                        <button onclick="document.getElementById('tokenExpiredAlert').remove()" class="text-gray-500 hover:text-gray-700 text-sm">
                                            å¿½ç•¥
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // ç§»é™¤æ—§çš„è­¦æŠ¥
                const oldAlert = document.getElementById('tokenExpiredAlert');
                if (oldAlert) {
                    oldAlert.remove();
                }
                
                // æ·»åŠ æ–°çš„è­¦æŠ¥
                document.body.insertAdjacentHTML('beforeend', alertHtml);
                
                // 10ç§’åè‡ªåŠ¨æ¶ˆå¤±
                setTimeout(() => {
                    const alert = document.getElementById('tokenExpiredAlert');
                    if (alert) {
                        alert.style.opacity = '0';
                        alert.style.transform = 'translateX(100%)';
                        setTimeout(() => alert.remove(), 300);
                    }
                }, 10000);
            }

            async validateAllTokens() {
                try {
                    // ğŸ”¥ ä¼˜åŒ–ï¼šæ˜¾ç¤ºå¸¦è¿›åº¦çš„éªŒè¯æç¤º
                    this.showAlert('info', 'ğŸ” æ­£åœ¨éªŒè¯æ‰€æœ‰Token...', 0); // ä¸è‡ªåŠ¨æ¶ˆå¤±
                    
                    // ğŸ”¥ ä¼˜åŒ–ï¼šæ·»åŠ 20ç§’è¶…æ—¶æ§åˆ¶
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 20000);
                    
                    const response = await fetch(BASE_PATH + '/api/tokens/validate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ force_check: true }),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        const { buff, youpin, overall_valid, validation_time } = result.data;
                        
                        // æ˜¾ç¤ºéªŒè¯æ—¶é—´
                        const timeInfo = validation_time ? ` (è€—æ—¶: ${validation_time}ç§’)` : '';
                        
                        if (overall_valid) {
                            this.showAlert('success', `âœ… æ‰€æœ‰TokenéªŒè¯é€šè¿‡ï¼${timeInfo}`);
                        } else {
                            let message = `âŒ TokenéªŒè¯å¤±è´¥${timeInfo}:\n`;
                            if (!buff.valid) {
                                message += `â€¢ Buff: ${buff.error}\n`;
                            }
                            if (!youpin.valid) {
                                message += `â€¢ æ‚ æ‚ æœ‰å“: ${youpin.error}`;
                            }
                            this.showAlert('error', message);
                        }
                        
                        // åˆ·æ–°çŠ¶æ€æ˜¾ç¤º
                        this.loadTokenStatus();
                    } else {
                        this.showAlert('error', `âŒ TokenéªŒè¯å¤±è´¥: ${result.error}`);
                    }
                } catch (error) {
                    if (error.name === 'AbortError') {
                        this.showAlert('warning', 'âš ï¸ TokenéªŒè¯è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•');
                    } else {
                        console.error('éªŒè¯Tokenå¤±è´¥:', error);
                        this.showAlert('error', `âŒ TokenéªŒè¯å¤±è´¥: ${error.message}`);
                    }
                }
            }

            showConfigPanel() {
                // æ˜¾ç¤ºè®¾ç½®é¢æ¿å¹¶åˆ‡æ¢åˆ°Tokené…ç½®æ ‡ç­¾
                const settingsModal = document.getElementById('settingsModal');
                const tokensTab = document.querySelector('[data-tab="tokens"]');
                
                if (settingsModal) {
                    settingsModal.classList.remove('hidden');
                }
                
                if (tokensTab) {
                    tokensTab.click();
                }
            }

            // ğŸ”¥ æ–°å¢ï¼šåˆå§‹åŒ–TokençŠ¶æ€æ£€æŸ¥
            async initTokenStatusCheck() {
                try {
                    console.log('ğŸ” å¼€å§‹æ£€æŸ¥TokençŠ¶æ€...');
                    
                    // 1. å¯åŠ¨TokenéªŒè¯æœåŠ¡
                    await this.startTokenValidationService();
                    
                    // 2. ç«‹å³æ£€æŸ¥ä¸€æ¬¡TokençŠ¶æ€
                    await this.checkInitialTokenStatus();
                    
                    // 3. è®¾ç½®å®šæœŸæ£€æŸ¥ï¼ˆæ¯5åˆ†é’Ÿï¼‰
                    this.setupPeriodicTokenCheck();
                    
                    console.log('âœ… TokençŠ¶æ€æ£€æŸ¥åˆå§‹åŒ–å®Œæˆ');
                } catch (error) {
                    console.error('âŒ TokençŠ¶æ€æ£€æŸ¥åˆå§‹åŒ–å¤±è´¥:', error);
                }
            }

            async startTokenValidationService() {
                try {
                    console.log('ğŸš€ å¯åŠ¨TokenéªŒè¯æœåŠ¡...');
                    const response = await fetch(BASE_PATH + '/api/tokens/validation-service', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'start' })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        console.log('âœ… TokenéªŒè¯æœåŠ¡å·²å¯åŠ¨');
                    } else {
                        console.warn('âš ï¸ TokenéªŒè¯æœåŠ¡å¯åŠ¨å¤±è´¥:', result.error);
                    }
                } catch (error) {
                    console.error('âŒ å¯åŠ¨TokenéªŒè¯æœåŠ¡å¤±è´¥:', error);
                }
            }

            async checkInitialTokenStatus() {
                try {
                    console.log('ğŸ” æ£€æŸ¥åˆå§‹TokençŠ¶æ€...');
                    const response = await fetch(BASE_PATH + '/api/tokens/status');
                    const result = await response.json();
                    
                    if (result.success) {
                        const { buff, youpin } = result.data;
                        console.log('ğŸ“Š TokençŠ¶æ€:', { buff, youpin });
                        
                        // ğŸ”¥ ä¿®å¤ï¼šåªæœ‰åœ¨Tokenæ˜ç¡®å¤±æ•ˆä¸”æœ‰é”™è¯¯ä¿¡æ¯æ—¶æ‰æ˜¾ç¤ºè­¦æŠ¥
                        // é¿å…åœ¨éªŒè¯æœªå®Œæˆæ—¶æ˜¾ç¤ºè¯¯æŠ¥
                        const shouldShowAlert = this.shouldShowTokenAlert(buff, youpin);
                        if (shouldShowAlert.show) {
                            this.checkTokenValidity(buff, youpin);
                        } else {
                            console.log('âœ… TokençŠ¶æ€æ­£å¸¸æˆ–éªŒè¯æœªå®Œæˆï¼Œä¸æ˜¾ç¤ºè­¦æŠ¥');
                        }
                        
                        // ğŸ”¥ æ–°å¢ï¼šå¦‚æœTokenéœ€è¦éªŒè¯ä½†æ²¡æœ‰æ˜ç¡®å¤±æ•ˆï¼Œè¿›è¡Œåå°éªŒè¯
                        if (this.shouldValidateTokensInBackground(buff, youpin)) {
                            console.log('ğŸ”„ åå°éªŒè¯TokençŠ¶æ€...');
                            this.validateTokensInBackground();
                        }
                    }
                } catch (error) {
                    console.error('âŒ æ£€æŸ¥åˆå§‹TokençŠ¶æ€å¤±è´¥:', error);
                }
            }

            shouldShowTokenAlert(buff, youpin) {
                // ğŸ”¥ ä¿®å¤ï¼šåªæœ‰åœ¨ä»¥ä¸‹æƒ…å†µæ‰æ˜¾ç¤ºè­¦æŠ¥ï¼š
                // 1. Tokenå·²é…ç½®
                // 2. cached_validæ˜ç¡®ä¸ºfalseï¼ˆä¸æ˜¯nullï¼‰
                // 3. æœ‰å…·ä½“çš„é”™è¯¯ä¿¡æ¯
                // 4. é”™è¯¯ä¿¡æ¯è¡¨æ˜Tokenç¡®å®å¤±æ•ˆï¼ˆè€Œä¸æ˜¯ç½‘ç»œé”™è¯¯ç­‰ï¼‰
                
                const buffShouldAlert = buff.configured && 
                    buff.cached_valid === false && // æ˜ç¡®ä¸ºfalseï¼Œä¸æ˜¯null
                    buff.cached_error && 
                    this.isTokenExpiredError(buff.cached_error);
                    
                const youpinShouldAlert = youpin.configured && 
                    youpin.cached_valid === false && // æ˜ç¡®ä¸ºfalseï¼Œä¸æ˜¯null
                    youpin.cached_error && 
                    this.isTokenExpiredError(youpin.cached_error);
                
                console.log('ğŸ” Tokenè­¦æŠ¥æ£€æŸ¥:', {
                    buff: { configured: buff.configured, cached_valid: buff.cached_valid, cached_error: buff.cached_error, shouldAlert: buffShouldAlert },
                    youpin: { configured: youpin.configured, cached_valid: youpin.cached_valid, cached_error: youpin.cached_error, shouldAlert: youpinShouldAlert }
                });
                
                return {
                    show: buffShouldAlert || youpinShouldAlert,
                    buff: buffShouldAlert,
                    youpin: youpinShouldAlert
                };
            }

            isTokenExpiredError(error) {
                // ğŸ”¥ ä¼˜åŒ–ï¼šåˆ¤æ–­é”™è¯¯æ˜¯å¦è¡¨æ˜Tokenç¡®å®å¤±æ•ˆ
                const expiredKeywords = [
                    'å¤±æ•ˆ', 'è¿‡æœŸ', 'æ— æ•ˆ', 'ç™»å½•', 'è®¤è¯å¤±è´¥', 'tokenå·²å¤±æ•ˆ', 'tokenæ— æ•ˆ',
                    '401', '403', 'unauthorized', 'forbidden', 'authentication failed',
                    'expired', 'invalid', 'login', 'auth', 'credential'
                ];
                
                // æ’é™¤çš„å…³é”®è¯ï¼ˆè¿™äº›é€šå¸¸æ˜¯ç½‘ç»œæˆ–å…¶ä»–æŠ€æœ¯é—®é¢˜ï¼Œä¸æ˜¯Tokenå¤±æ•ˆï¼‰
                const excludeKeywords = [
                    'ç½‘ç»œ', 'è¶…æ—¶', 'è¿æ¥', 'å“åº”ä¸ºç©º', 'timeout', 'network', 'connection',
                    'apiå“åº”ä¸ºç©º', 'æ ¼å¼å¼‚å¸¸', 'json', 'parse', '500', '502', '503', '504'
                ];
                
                const errorLower = error.toLowerCase();
                
                // å¦‚æœåŒ…å«æ’é™¤å…³é”®è¯ï¼Œåˆ™ä¸è®¤ä¸ºæ˜¯Tokenå¤±æ•ˆ
                const hasExcludeKeyword = excludeKeywords.some(keyword => 
                    errorLower.includes(keyword.toLowerCase())
                );
                
                if (hasExcludeKeyword) {
                    return false;
                }
                
                // æ£€æŸ¥æ˜¯å¦åŒ…å«Tokenå¤±æ•ˆå…³é”®è¯
                const hasExpiredKeyword = expiredKeywords.some(keyword => 
                    errorLower.includes(keyword.toLowerCase())
                );
                
                return hasExpiredKeyword;
            }

            shouldValidateTokensInBackground(buff, youpin) {
                // éœ€è¦åå°éªŒè¯çš„æƒ…å†µï¼š
                // 1. Tokenå·²é…ç½®ä½†æ²¡æœ‰éªŒè¯ç¼“å­˜
                // 2. Tokenå·²é…ç½®ä½†éªŒè¯æ—¶é—´è¿‡ä¹…ï¼ˆè¶…è¿‡1å°æ—¶ï¼‰
                const oneHourAgo = Date.now() - 60 * 60 * 1000;
                
                const buffNeedsValidation = buff.configured && 
                    (buff.cached_valid === null || 
                     !buff.last_validation || 
                     new Date(buff.last_validation).getTime() < oneHourAgo);
                     
                const youpinNeedsValidation = youpin.configured && 
                    (youpin.cached_valid === null || 
                     !youpin.last_validation || 
                     new Date(youpin.last_validation).getTime() < oneHourAgo);
                
                return buffNeedsValidation || youpinNeedsValidation;
            }

            async validateTokensInBackground() {
                // åå°éªŒè¯ï¼Œä¸æ˜¾ç¤ºåŠ è½½æç¤ºï¼Œä¸é˜»å¡ç”¨æˆ·æ“ä½œ
                try {
                    console.log('ğŸ”„ åå°éªŒè¯Token...');
                    
                    const response = await fetch(BASE_PATH + '/api/tokens/validate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ force_check: false }) // ä¸å¼ºåˆ¶æ£€æŸ¥ï¼Œä½¿ç”¨ç¼“å­˜
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        console.log('âœ… åå°TokenéªŒè¯å®Œæˆ');
                        // åˆ·æ–°çŠ¶æ€æ˜¾ç¤º
                        this.loadTokenStatus();
                    } else {
                        console.log('âš ï¸ åå°TokenéªŒè¯å¤±è´¥:', result.error);
                    }
                } catch (error) {
                    console.log('âš ï¸ åå°TokenéªŒè¯å¼‚å¸¸:', error.message);
                }
            }

            setupPeriodicTokenCheck() {
                // æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡TokençŠ¶æ€
                setInterval(async () => {
                    try {
                        console.log('â° å®šæœŸæ£€æŸ¥TokençŠ¶æ€...');
                        await this.checkInitialTokenStatus();
                    } catch (error) {
                        console.error('âŒ å®šæœŸTokenæ£€æŸ¥å¤±è´¥:', error);
                    }
                }, 5 * 60 * 1000); // 5åˆ†é’Ÿ
                
                console.log('â° å·²è®¾ç½®TokençŠ¶æ€å®šæœŸæ£€æŸ¥ï¼ˆæ¯5åˆ†é’Ÿï¼‰');
            }

            async validateSingleToken(platform) {
                try {
                    this.showAlert('info', `ğŸ” æ­£åœ¨éªŒè¯${platform === 'buff' ? 'Buff' : 'æ‚ æ‚ æœ‰å“'}Token...`);
                    
                    const response = await fetch(BASE_PATH + `/api/tokens/validate/${platform}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ force_check: true })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        const { valid, error } = result.data;
                        
                        if (valid) {
                            this.showAlert('success', `âœ… ${platform === 'buff' ? 'Buff' : 'æ‚ æ‚ æœ‰å“'}TokenéªŒè¯é€šè¿‡ï¼`);
                        } else {
                            this.showAlert('error', `âŒ ${platform === 'buff' ? 'Buff' : 'æ‚ æ‚ æœ‰å“'}TokenéªŒè¯å¤±è´¥: ${error}`);
                        }
                        
                        // åˆ·æ–°çŠ¶æ€æ˜¾ç¤º
                        this.loadTokenStatus();
                    } else {
                        this.showAlert('error', `âŒ éªŒè¯${platform === 'buff' ? 'Buff' : 'æ‚ æ‚ æœ‰å“'}Tokenå¤±è´¥: ${result.error}`);
                    }
                } catch (error) {
                    console.error(`éªŒè¯${platform}Tokenå¤±è´¥:`, error);
                    this.showAlert('error', `âŒ éªŒè¯${platform === 'buff' ? 'Buff' : 'æ‚ æ‚ æœ‰å“'}Tokenå¤±è´¥: ${error.message}`);
                }
            }
            
            getStatusBadge(status, isValid) {
                if (status === 'å·²é…ç½®' && isValid) {
                    return `<span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800">
                        <i class="fas fa-check mr-1"></i>å·²é…ç½®
                    </span>`;
                } else if (status === 'å·²é…ç½®' && !isValid) {
                    return `<span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-800">
                        <i class="fas fa-exclamation-triangle mr-1"></i>é…ç½®ä¸å®Œæ•´
                    </span>`;
                } else {
                    return `<span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-800">
                        <i class="fas fa-times mr-1"></i>æœªé…ç½®
                    </span>`;
                }
            }
            
            async updateBuffToken() {
                try {
                    const session = document.getElementById('buffSession').value.trim();
                    const csrfToken = document.getElementById('buffCsrfToken').value.trim();
                    const otherCookiesText = document.getElementById('buffOtherCookies').value.trim();
                    
                    if (!session || !csrfToken) {
                        this.showAlert('warning', 'âš ï¸ è¯·è¾“å…¥Sessionå’ŒCSRF Token');
                        return;
                    }
                    
                    const cookies = {
                        session: session,
                        csrf_token: csrfToken
                    };
                    
                    // è§£æå…¶ä»–cookies
                    if (otherCookiesText) {
                        try {
                            const otherCookies = JSON.parse(otherCookiesText);
                            Object.assign(cookies, otherCookies);
                        } catch (e) {
                            this.showAlert('warning', 'âš ï¸ å…¶ä»–Cookiesæ ¼å¼é”™è¯¯ï¼Œè¯·ä½¿ç”¨æ­£ç¡®çš„JSONæ ¼å¼');
                            return;
                        }
                    }
                    
                    const response = await fetch(BASE_PATH + '/api/tokens/buff', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ cookies })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.showAlert('success', 'ğŸ”‘ Buff Tokenæ›´æ–°æˆåŠŸï¼');
                        this.loadTokenStatus();
                        // æ¸…ç©ºè¾“å…¥æ¡†
                        document.getElementById('buffSession').value = '';
                        document.getElementById('buffCsrfToken').value = '';
                        document.getElementById('buffOtherCookies').value = '';
                    } else {
                        this.showAlert('error', 'âŒ Buff Tokenæ›´æ–°å¤±è´¥: ' + (result.error || result.detail));
                    }
                } catch (error) {
                    console.error('æ›´æ–°Buff Tokenå¤±è´¥:', error);
                    this.showAlert('error', 'âŒ Buff Tokenæ›´æ–°å¤±è´¥: ' + error.message);
                }
            }
            
            async updateYoupinToken() {
                try {
                    const deviceId = document.getElementById('youpinDeviceId').value.trim();
                    const deviceUk = document.getElementById('youpinDeviceUk').value.trim();
                    const uk = document.getElementById('youpinUk').value.trim();
                    const b3 = document.getElementById('youpinB3').value.trim();
                    const authorization = document.getElementById('youpinAuthorization').value.trim();
                    
                    if (!deviceId || !uk) {
                        this.showAlert('warning', 'âš ï¸ è¯·è‡³å°‘è¾“å…¥Device IDå’ŒUK');
                        return;
                    }
                    
                    const response = await fetch(BASE_PATH + '/api/tokens/youpin', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            device_id: deviceId,
                            device_uk: deviceUk,
                            uk: uk,
                            b3: b3,
                            authorization: authorization
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.showAlert('success', 'ğŸ”‘ æ‚ æ‚ æœ‰å“Tokenæ›´æ–°æˆåŠŸï¼');
                        this.loadTokenStatus();
                        // æ¸…ç©ºè¾“å…¥æ¡†
                        document.getElementById('youpinDeviceId').value = '';
                        document.getElementById('youpinDeviceUk').value = '';
                        document.getElementById('youpinUk').value = '';
                        document.getElementById('youpinB3').value = '';
                        document.getElementById('youpinAuthorization').value = '';
                    } else {
                        this.showAlert('error', 'âŒ æ‚ æ‚ æœ‰å“Tokenæ›´æ–°å¤±è´¥: ' + (result.error || result.detail));
                    }
                } catch (error) {
                    console.error('æ›´æ–°æ‚ æ‚ æœ‰å“Tokenå¤±è´¥:', error);
                    this.showAlert('error', 'âŒ æ‚ æ‚ æœ‰å“Tokenæ›´æ–°å¤±è´¥: ' + error.message);
                }
            }
            
            async testBuffConnection() {
                const btn = document.getElementById('testBuffConnection');
                const originalText = btn.innerHTML;
                
                btn.innerHTML = '<i class="fas fa-spinner loading mr-1"></i>æµ‹è¯•ä¸­...';
                btn.disabled = true;
                
                try {
                    const response = await fetch(BASE_PATH + '/api/test/buff', { method: 'POST' });
                    const result = await response.json();
                    
                    if (result.success) {
                        this.showAlert('success', `ğŸ”— Buffè¿æ¥æµ‹è¯•æˆåŠŸï¼${result.message}`);
                    } else {
                        this.showAlert('error', `âŒ Buffè¿æ¥æµ‹è¯•å¤±è´¥ï¼š${result.error}`);
                    }
                } catch (error) {
                    console.error('æµ‹è¯•Buffè¿æ¥å¤±è´¥:', error);
                    this.showAlert('error', 'âŒ Buffè¿æ¥æµ‹è¯•å¤±è´¥: ' + error.message);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
            
            async testYoupinConnection() {
                const btn = document.getElementById('testYoupinConnection');
                const originalText = btn.innerHTML;
                
                btn.innerHTML = '<i class="fas fa-spinner loading mr-1"></i>æµ‹è¯•ä¸­...';
                btn.disabled = true;
                
                try {
                    const response = await fetch(BASE_PATH + '/api/test/youpin', { method: 'POST' });
                    const result = await response.json();
                    
                    if (result.success) {
                        this.showAlert('success', `ğŸ”— æ‚ æ‚ æœ‰å“è¿æ¥æµ‹è¯•æˆåŠŸï¼${result.message}`);
                    } else {
                        this.showAlert('error', `âŒ æ‚ æ‚ æœ‰å“è¿æ¥æµ‹è¯•å¤±è´¥ï¼š${result.error}`);
                    }
                } catch (error) {
                    console.error('æµ‹è¯•æ‚ æ‚ æœ‰å“è¿æ¥å¤±è´¥:', error);
                    this.showAlert('error', 'âŒ æ‚ æ‚ æœ‰å“è¿æ¥æµ‹è¯•å¤±è´¥: ' + error.message);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }

            // ğŸ”¥ æ–°å¢ï¼šåº”ç”¨æ’åº
            applySorting() {
                if (this.sortBy === 'price_diff') {
                    this.items.sort((a, b) => (b.price_diff || 0) - (a.price_diff || 0));
                } else if (this.sortBy === 'profit_margin') {
                    this.items.sort((a, b) => (b.profit_rate || 0) - (a.profit_rate || 0));
                }
            }

            // ğŸ”¥ æ–°å¢ï¼šåº”ç”¨æ•°é‡é™åˆ¶
            applyLimit(limit) {
                if (limit > 0 && this.items.length > limit) {
                    this.items = this.items.slice(0, limit);
                }
            }

            // ğŸ”¥ æ–°å¢ï¼šè®¡ç®—ç»Ÿè®¡ä¿¡æ¯
            calculateStatistics() {
                if (this.items.length === 0) {
                    document.getElementById('avgDiff').textContent = '-';
                    document.getElementById('maxDiff').textContent = '-';
                    return;
                }
                
                const totalDiff = this.items.reduce((sum, item) => sum + (item.price_diff || 0), 0);
                const avgDiff = totalDiff / this.items.length;
                const maxDiff = Math.max(...this.items.map(item => item.price_diff || 0));
                
                document.getElementById('avgDiff').textContent = `Â¥${avgDiff.toFixed(2)}`;
                document.getElementById('maxDiff').textContent = `Â¥${maxDiff.toFixed(2)}`;
            }
        }

        // ç§»åŠ¨ç«¯é€‚é…å·¥å…·å‡½æ•°
        function detectMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        function addMobileClasses() {
            const body = document.body;
            const isMobile = detectMobileDevice();
            const isTouch = 'ontouchstart' in window;
            
            body.classList.add(isMobile ? 'is-mobile' : 'is-desktop');
            if (isTouch) body.classList.add('is-touch');
            
            // ä¸ºiOSè®¾å¤‡æ·»åŠ å®‰å…¨åŒºåŸŸ
            if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                body.classList.add('ios-safe-area');
            }
            
            console.log(`ğŸ“± è®¾å¤‡æ£€æµ‹: ${isMobile ? 'ç§»åŠ¨ç«¯' : 'æ¡Œé¢ç«¯'}, è§¦æ‘¸: ${isTouch ? 'æ˜¯' : 'å¦'}`);
        }

        // ç§»åŠ¨ç«¯viewportåŠ¨æ€è°ƒæ•´
        function setupMobileViewport() {
            const viewport = document.querySelector('meta[name=viewport]');
            if (!viewport) {
                const meta = document.createElement('meta');
                meta.name = 'viewport';
                meta.content = 'width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes';
                document.head.appendChild(meta);
                console.log('ğŸ“± å·²æ·»åŠ ç§»åŠ¨ç«¯viewportæ ‡ç­¾');
            }
        }

        // ç§»åŠ¨ç«¯æ€§èƒ½ä¼˜åŒ–
        function optimizeForMobile() {
            if (detectMobileDevice()) {
                // å‡å°‘åŠ¨ç”»æ—¶é—´
                const style = document.createElement('style');
                style.textContent = `
                    * { 
                        transition-duration: 0.2s !important; 
                        animation-duration: 0.2s !important; 
                    }
                `;
                document.head.appendChild(style);
                
                // ç¦ç”¨éƒ¨åˆ†hoveræ•ˆæœ
                document.documentElement.classList.add('touch-device');
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ“± DOMå·²åŠ è½½ï¼Œåˆå§‹åŒ–ç§»åŠ¨ç«¯é€‚é…...');
            
            // ç§»åŠ¨ç«¯é€‚é…
            addMobileClasses();
            setupMobileViewport();
            optimizeForMobile();
            
            console.log('ğŸ“± åˆå§‹åŒ–BuffMonitor...');
            const monitor = new BuffMonitor();
            
            // å»¶è¿ŸåŠ è½½é…ç½®ç¡®ä¿å…ƒç´ å·²æ¸²æŸ“
            setTimeout(() => {
                console.log('â° å»¶è¿ŸåŠ è½½é…ç½®...');
                monitor.loadConfig();
                
                // ğŸ”¥ æ–°å¢ï¼šåˆå§‹åŒ–TokençŠ¶æ€æ£€æŸ¥
                console.log('ğŸ” åˆå§‹åŒ–TokençŠ¶æ€æ£€æŸ¥...');
                monitor.initTokenStatusCheck();
            }, 100);
        });
    </script>
</body>
</html> 