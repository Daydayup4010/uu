<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buff差价监控系统</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .profit-positive {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .profit-high {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        .profit-very-high {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        /* 移动端适配样式 */
        @media (max-width: 768px) {
            .mobile-hidden {
                display: none !important;
            }
            
            .mobile-text-sm {
                font-size: 0.875rem !important;
            }
            
            .mobile-p-2 {
                padding: 0.5rem !important;
            }
            
            .mobile-card {
                margin-bottom: 1rem;
                padding: 1rem;
                border-radius: 0.5rem;
                background: white;
                box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            }
            
            .mobile-flex-col {
                display: flex !important;
                flex-direction: column !important;
                gap: 0.5rem !important;
            }
            
            .mobile-w-full {
                width: 100% !important;
            }
            
            .mobile-text-center {
                text-align: center !important;
            }
            
            /* 移动端表格优化 */
            .mobile-table-responsive {
                display: block;
                width: 100%;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .mobile-table-responsive table {
                width: 100%;
                min-width: 800px;
            }
            
            /* 移动端按钮优化 */
            .mobile-btn {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
                width: 100%;
                margin-bottom: 0.5rem;
            }
            
            /* 移动端导航优化 */
            .mobile-nav {
                padding: 0.5rem 1rem;
            }
            
            .mobile-nav h1 {
                font-size: 1.125rem;
            }
            
            /* 移动端模态框优化 */
            .mobile-modal {
                margin: 1rem;
                max-height: calc(100vh - 2rem);
                border-radius: 0.5rem;
            }
            
            /* 移动端统计卡片优化 */
            .mobile-stat-card {
                text-align: center;
                padding: 1rem;
            }
            
            .mobile-stat-card .stat-icon {
                margin: 0 auto 0.5rem;
            }
            
            /* 移动端筛选面板优化 */
            .mobile-filter {
                display: flex;
                flex-direction: column;
                gap: 1rem;
            }
            
            .mobile-filter > div {
                width: 100%;
            }
            
            .mobile-filter input,
            .mobile-filter select {
                width: 100%;
            }
        }
        
        /* 小屏幕特殊优化 */
        @media (max-width: 480px) {
            .xs-hidden {
                display: none !important;
            }
            
            .xs-text-xs {
                font-size: 0.75rem !important;
            }
            
            .xs-p-1 {
                padding: 0.25rem !important;
            }
            
            /* 超小屏幕的表格卡片模式 */
            .xs-card-mode {
                display: block !important;
            }
            
            .xs-card-mode table,
            .xs-card-mode thead,
            .xs-card-mode tbody,
            .xs-card-mode th,
            .xs-card-mode td,
            .xs-card-mode tr {
                display: block !important;
            }
            
            .xs-card-mode thead tr {
                position: absolute !important;
                top: -9999px !important;
                left: -9999px !important;
            }
            
            .xs-card-mode tr {
                border: 1px solid #e5e7eb !important;
                margin-bottom: 1rem !important;
                padding: 1rem !important;
                border-radius: 0.5rem !important;
                background: white !important;
            }
            
            .xs-card-mode td {
                border: none !important;
                position: relative !important;
                padding-left: 50% !important;
                padding-top: 0.5rem !important;
                padding-bottom: 0.5rem !important;
            }
            
            .xs-card-mode td:before {
                content: attr(data-label) ": " !important;
                position: absolute !important;
                left: 0.5rem !important;
                width: 45% !important;
                padding-right: 10px !important;
                white-space: nowrap !important;
                font-weight: 600 !important;
                color: #374151 !important;
            }
        }
        
        /* 触摸优化 */
        @media (hover: none) and (pointer: coarse) {
            .touch-target {
                min-height: 44px !important;
                min-width: 44px !important;
            }
            
            .touch-btn {
                padding: 0.75rem 1.5rem !important;
                font-size: 1rem !important;
            }
        }

        /* 设备特定样式 */
        .is-mobile {
            /* 移动端特定样式 */
        }

        .is-desktop {
            /* 桌面端特定样式 */
        }

        .is-touch {
            /* 触摸设备特定样式 */
        }

        /* 移动端优化的加载动画 */
        @media (max-width: 768px) {
            .loading {
                animation: spin 0.8s linear infinite;
            }
            
            /* 移动端模态框全屏优化 */
            @media (max-height: 600px) {
                .mobile-modal {
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    margin: 0;
                    border-radius: 0;
                    max-height: 100vh;
                }
            }
            
            /* 移动端表单优化 */
            .mobile-form-group {
                margin-bottom: 1rem;
            }
            
            .mobile-form-group label {
                display: block;
                margin-bottom: 0.5rem;
                font-weight: 600;
                color: #374151;
            }
            
            .mobile-form-group input,
            .mobile-form-group select,
            .mobile-form-group textarea {
                width: 100%;
                padding: 0.75rem;
                border: 1px solid #d1d5db;
                border-radius: 0.375rem;
                font-size: 1rem;
                line-height: 1.5;
            }
            
            /* 移动端网格优化 */
            .mobile-grid {
                display: grid;
                gap: 1rem;
                grid-template-columns: 1fr;
            }
            
            .mobile-grid-2 {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* 横屏优化 */
        @media (max-width: 768px) and (orientation: landscape) {
            .landscape-optimize {
                max-height: 80vh;
                overflow-y: auto;
            }
        }

        /* iOS Safari 特殊优化 */
        @supports (-webkit-touch-callout: none) {
            .ios-safe-area {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- 顶部导航 -->
    <nav class="gradient-bg shadow-lg">
        <div class="max-w-7xl mx-auto px-2 sm:px-4 lg:px-8">
            <div class="flex justify-between items-center h-14 sm:h-16">
                <div class="flex items-center min-w-0 flex-1">
                    <i class="fas fa-chart-line text-white text-lg sm:text-2xl mr-2 sm:mr-3 flex-shrink-0"></i>
                    <h1 class="text-white text-sm sm:text-xl font-bold truncate">Buff差价监控系统</h1>
                </div>
                <div class="flex items-center">
                    <button id="settingsBtn" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-2 sm:px-4 py-2 rounded-lg transition duration-200 text-sm sm:text-base touch-target">
                        <i class="fas fa-cog sm:mr-2"></i>
                        <span class="hidden sm:inline">设置</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-2 sm:px-4 lg:px-8 py-4 sm:py-8">
        <!-- 统计面板 -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-6 mb-6 sm:mb-8">
            <div class="bg-white rounded-lg shadow p-3 sm:p-6">
                <div class="flex flex-col sm:flex-row items-center sm:items-center">
                    <div class="p-2 sm:p-3 rounded-full bg-blue-100 text-blue-600 mb-2 sm:mb-0">
                        <i class="fas fa-gem text-sm sm:text-xl"></i>
                    </div>
                    <div class="sm:ml-4 text-center sm:text-left">
                        <p class="text-xs sm:text-sm font-medium text-gray-600">总饰品数</p>
                        <p class="text-lg sm:text-2xl font-semibold text-gray-900" id="totalCount">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-3 sm:p-6">
                <div class="flex flex-col sm:flex-row items-center sm:items-center">
                    <div class="p-2 sm:p-3 rounded-full bg-green-100 text-green-600 mb-2 sm:mb-0">
                        <i class="fas fa-coins text-sm sm:text-xl"></i>
                    </div>
                    <div class="sm:ml-4 text-center sm:text-left">
                        <p class="text-xs sm:text-sm font-medium text-gray-600">平均价差</p>
                        <p class="text-lg sm:text-2xl font-semibold text-gray-900" id="avgDiff">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-3 sm:p-6">
                <div class="flex flex-col sm:flex-row items-center sm:items-center">
                    <div class="p-2 sm:p-3 rounded-full bg-yellow-100 text-yellow-600 mb-2 sm:mb-0">
                        <i class="fas fa-chart-bar text-sm sm:text-xl"></i>
                    </div>
                    <div class="sm:ml-4 text-center sm:text-left">
                        <p class="text-xs sm:text-sm font-medium text-gray-600">最大价差</p>
                        <p class="text-lg sm:text-2xl font-semibold text-gray-900" id="maxDiff">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-3 sm:p-6 col-span-2 lg:col-span-1">
                <div class="flex flex-col sm:flex-row items-center sm:items-center">
                    <div class="p-2 sm:p-3 rounded-full bg-purple-100 text-purple-600 mb-2 sm:mb-0">
                        <i class="fas fa-clock text-sm sm:text-xl"></i>
                    </div>
                    <div class="sm:ml-4 text-center sm:text-left">
                        <p class="text-xs sm:text-sm font-medium text-gray-600">更新时间</p>
                        <p class="text-xs sm:text-sm font-semibold text-gray-900" id="lastUpdate">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 过滤和排序 -->
        <div class="bg-white rounded-lg shadow p-3 sm:p-6 mb-6 sm:mb-8">
            <div class="flex flex-col sm:flex-row sm:flex-wrap sm:items-end gap-3 sm:gap-4">
                <div class="flex-1 min-w-0">
                    <label class="block text-sm font-medium text-gray-700 mb-1">价格区间（元）</label>
                    <div class="flex items-center space-x-2">
                        <input type="number" id="minPriceFilter" placeholder="最小价差" 
                               class="border border-gray-300 rounded-md px-3 py-2 w-full sm:w-24 touch-target text-sm sm:text-base" step="0.1" min="0">
                        <span class="text-gray-500 flex-shrink-0">-</span>
                        <input type="number" id="maxPriceFilter" placeholder="最大价差" 
                               class="border border-gray-300 rounded-md px-3 py-2 w-full sm:w-24 touch-target text-sm sm:text-base" step="0.1" min="0">
                    </div>
                </div>
                <div class="flex-1 min-w-0 sm:min-w-32">
                    <label class="block text-sm font-medium text-gray-700 mb-1">排序方式</label>
                    <select id="sortBy" class="border border-gray-300 rounded-md px-3 py-2 w-full touch-target text-sm sm:text-base">
                        <option value="price_diff">按价差排序</option>
                        <option value="profit_margin">按利润率排序</option>
                    </select>
                </div>
                <div class="flex-1 min-w-0 sm:min-w-24">
                    <label class="block text-sm font-medium text-gray-700 mb-1">显示数量</label>
                    <select id="limitCount" class="border border-gray-300 rounded-md px-3 py-2 w-full touch-target text-sm sm:text-base">
                        <option value="50">50个</option>
                        <option value="100" selected>100个</option>
                        <option value="200">200个</option>
                        <option value="500">500个</option>
                    </select>
                </div>
                <div class="flex flex-col sm:flex-row gap-2 sm:gap-2 w-full sm:w-auto">
                    <button id="applyFilter" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition duration-200 touch-btn text-sm sm:text-base">
                        <i class="fas fa-filter mr-2"></i>
                        应用筛选
                    </button>
                    <button id="resetFilter" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition duration-200 touch-btn text-sm sm:text-base">
                        <i class="fas fa-undo mr-2"></i>
                        重置
                    </button>
                </div>
            </div>
        </div>

        <!-- 饰品列表 -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-list mr-2"></i>
                    差价饰品列表
                </h2>
            </div>
            
            <div id="loading" class="flex items-center justify-center p-8">
                <div class="loading text-blue-600 text-2xl">
                    <i class="fas fa-spinner"></i>
                </div>
                <span class="ml-3 text-gray-600">正在加载数据...</span>
            </div>
            
            <div id="itemsList" class="hidden">
                <!-- 动态生成的饰品列表 -->
            </div>
        </div>
    </div>

    <!-- 设置模态框 -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-2 sm:p-4">
            <div class="bg-white rounded-lg max-w-4xl w-full max-w-none sm:max-w-4xl p-3 sm:p-6 max-h-screen overflow-y-auto m-2 sm:m-0">
                <div class="flex justify-between items-center mb-4 sm:mb-6">
                    <h3 class="text-lg sm:text-xl font-semibold">系统设置</h3>
                    <button id="closeSettings" class="text-gray-400 hover:text-gray-600 touch-target">
                        <i class="fas fa-times text-lg sm:text-xl"></i>
                    </button>
                </div>
                
                <!-- 设置标签页 -->
                <div class="flex border-b mb-4 sm:mb-6 overflow-x-auto">
                    <button id="generalTab" class="px-3 sm:px-4 py-2 font-medium text-blue-600 border-b-2 border-blue-600 whitespace-nowrap touch-target text-sm sm:text-base">
                        常规设置
                    </button>
                    <button id="tokensTab" class="px-3 sm:px-4 py-2 font-medium text-gray-600 hover:text-blue-600 ml-2 sm:ml-4 whitespace-nowrap touch-target text-sm sm:text-base">
                        Token管理
                    </button>
                </div>
                
                <!-- 常规设置面板 -->
                <div id="generalPanel" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">价格差异区间（元）</label>
                        <div class="flex items-center space-x-2">
                            <input type="number" id="priceRangeMin" placeholder="最小价差" 
                                   class="border border-gray-300 rounded-md px-3 py-2 w-24" step="0.1" min="0">
                            <span class="text-gray-500">-</span>
                            <input type="number" id="priceRangeMax" placeholder="最大价差" 
                                   class="border border-gray-300 rounded-md px-3 py-2 w-24" step="0.1" min="0">
                        </div>
                        <p class="text-xs text-gray-500 mt-1">设置价差筛选区间，例如 3-5元</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Buff价格筛选区间（元）</label>
                        <div class="flex items-center space-x-2">
                            <input type="number" id="buffPriceMin" placeholder="最小价格" 
                                   class="border border-gray-300 rounded-md px-3 py-2 w-24" step="0.1" min="0">
                            <span class="text-gray-500">-</span>
                            <input type="number" id="buffPriceMax" placeholder="最大价格" 
                                   class="border border-gray-300 rounded-md px-3 py-2 w-24" step="0.1" min="0">
                        </div>
                        <p class="text-xs text-gray-500 mt-1">只分析此价格区间内的Buff商品，用于增量更新</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Buff最小在售数量</label>
                        <input type="number" id="buffSellNumMin" placeholder="200" 
                               class="w-full border border-gray-300 rounded-md px-3 py-2" min="0" step="1">
                        <p class="text-xs text-gray-500 mt-1">只分析在售数量≥此值的Buff商品，过滤流动性差的商品</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">最大输出数量</label>
                        <input type="number" id="maxOutputItems" placeholder="300" 
                               class="w-full border border-gray-300 rounded-md px-3 py-2" min="1" step="1">
                        <p class="text-xs text-gray-500 mt-1">限制最终输出的商品数量</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">更新间隔设置</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">全量更新（小时）</label>
                                <div class="text-sm text-blue-600 font-medium" id="fullUpdateInterval">1小时</div>
                                <p class="text-xs text-gray-500">获取全部数据的间隔</p>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">增量更新（分钟）</label>
                                <div class="text-sm text-blue-600 font-medium" id="incrementalUpdateInterval">1分钟</div>
                                <p class="text-xs text-gray-500">搜索特定商品的间隔</p>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">手动更新操作</label>
                        <div class="flex space-x-2">
                            <button id="forceFullUpdate" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-sm">
                                <i class="fas fa-download mr-1"></i>
                                强制全量更新
                            </button>
                            <button id="forceIncrementalUpdate" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm">
                                <i class="fas fa-sync mr-1"></i>
                                强制增量更新
                            </button>
                            <!-- 🔥 新增：增强增量更新按钮 -->
                            <button id="enhancedIncrementalUpdate" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded text-sm">
                                <i class="fas fa-rocket mr-1"></i>
                                增强增量更新
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">立即执行指定类型的更新</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">价差阈值（元）- 兼容模式</label>
                        <input type="number" id="thresholdInput" placeholder="20" 
                               class="w-full border border-gray-300 rounded-md px-3 py-2" step="0.1" min="0">
                        <p class="text-xs text-gray-500 mt-1">传统单一阈值模式（建议使用价格区间）</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">当前价格区间</label>
                        <div id="currentPriceRange" class="text-sm text-blue-600 font-medium">
                            加载中...
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">当前Buff价格筛选</label>
                        <div id="currentBuffPriceRange" class="text-sm text-blue-600 font-medium">
                            加载中...
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">当前Buff在售数量筛选</label>
                        <div id="currentBuffSellNum" class="text-sm text-blue-600 font-medium">
                            加载中...
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">更新状态</label>
                        <div id="updateStatus" class="text-sm">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                <i class="fas fa-clock mr-1"></i>
                                正在检查...
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- Token管理面板 -->
                <div id="tokensPanel" class="hidden space-y-4 sm:space-y-6">
                    <!-- Token状态概览 -->
                    <div class="bg-gray-50 p-3 sm:p-4 rounded-lg">
                        <h4 class="font-medium text-gray-900 mb-3 text-sm sm:text-base">Token状态</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                            <div>
                                <p class="text-xs sm:text-sm text-gray-600">Buff API</p>
                                <div id="buffTokenStatus" class="mt-1">
                                    <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-800">
                                        检查中...
                                    </span>
                                </div>
                            </div>
                            <div>
                                <p class="text-xs sm:text-sm text-gray-600">悠悠有品 API</p>
                                <div id="youpinTokenStatus" class="mt-1">
                                    <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-800">
                                        检查中...
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Buff Token设置 -->
                    <div class="border border-gray-200 rounded-lg p-3 sm:p-4">
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 gap-3">
                            <h4 class="font-medium text-gray-900 text-sm sm:text-base">Buff Token 配置</h4>
                            <div class="flex flex-col sm:flex-row gap-2 sm:space-x-2">
                                <button id="validateBuffToken" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 sm:py-1 rounded text-sm touch-target">
                                    <i class="fas fa-check-circle mr-1"></i>
                                    验证Token
                                </button>
                                <button id="testBuffConnection" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 sm:py-1 rounded text-sm touch-target">
                                    <i class="fas fa-plug mr-1"></i>
                                    测试连接
                                </button>
                            </div>
                        </div>
                        
                        <div class="space-y-3 sm:space-y-4">
                            <div class="mobile-form-group">
                                <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Session Cookie</label>
                                <input type="text" id="buffSession" placeholder="session值..." 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base touch-target">
                            </div>
                            <div class="mobile-form-group">
                                <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">CSRF Token</label>
                                <input type="text" id="buffCsrfToken" placeholder="csrf_token值..." 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base touch-target">
                            </div>
                            <div class="mobile-form-group">
                                <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">其他Cookies (JSON格式)</label>
                                <textarea id="buffOtherCookies" placeholder='{"Device-Id": "xxx", "remember_me": "xxx"}'
                                          class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm sm:text-base h-16 sm:h-20 touch-target resize-none"></textarea>
                                <p class="text-xs text-gray-500 mt-1">可选：其他cookies，JSON格式</p>
                            </div>
                            <button id="updateBuffToken" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded w-full sm:w-auto touch-btn">
                                <i class="fas fa-save mr-2"></i>
                                更新 Buff Token
                            </button>
                        </div>
                    </div>
                    
                    <!-- 悠悠有品Token设置 -->
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-medium text-gray-900">悠悠有品 Token 配置</h4>
                            <button id="testYoupinConnection" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                                <i class="fas fa-plug mr-1"></i>
                                测试连接
                            </button>
                        </div>
                        
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Device ID</label>
                                <input type="text" id="youpinDeviceId" placeholder="device_id值..." 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Device UK</label>
                                <input type="text" id="youpinDeviceUk" placeholder="device_uk值..." 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">UK</label>
                                <input type="text" id="youpinUk" placeholder="uk值..." 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">B3</label>
                                <input type="text" id="youpinB3" placeholder="b3值..." 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Authorization Token</label>
                                <input type="text" id="youpinAuthorization" placeholder="Bearer xxx或JWT token..." 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                                <p class="text-xs text-gray-500 mt-1">认证Token，通常以Bearer开头</p>
                            </div>
                            <div class="flex space-x-2">
                                <button id="validateYoupinToken" class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-2 rounded text-sm">
                                    <i class="fas fa-check-circle mr-1"></i>
                                    验证Token
                                </button>
                                <button id="updateYoupinToken" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                                    <i class="fas fa-save mr-2"></i>
                                    更新悠悠有品 Token
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Token获取说明 -->
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-medium text-blue-900 mb-2">
                            <i class="fas fa-info-circle mr-2"></i>
                            如何获取Token
                        </h4>
                        <div class="text-sm text-blue-800 space-y-2">
                            <p><strong>Buff Token:</strong></p>
                            <p>1. 在浏览器中登录 buff.163.com</p>
                            <p>2. 打开开发者工具 (F12) → Network 标签</p>
                            <p>3. 刷新页面，查找对 /api/market/goods 的请求</p>
                            <p>4. 复制请求头中的 session 和 csrf_token cookies</p>
                            
                            <p><strong>悠悠有品Token:</strong></p>
                            <p>1. 在浏览器中访问 youpin898.com</p>
                            <p>2. 打开开发者工具 → Network 标签</p>
                            <p>3. 查找对 api.youpin898.com 的请求</p>
                            <p>4. 复制请求头中的相关参数</p>
                            <p>5. <strong>重要</strong>：复制Authorization头（通常以Bearer开头）</p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end space-x-3">
                    <button id="saveSettings" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition duration-200">
                        保存设置
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 🔥 设置基础路径，支持子路径部署
        const BASE_PATH = window.location.pathname.includes('/csgo') ? '/csgo' : '';
        
        class BuffMonitor {
            constructor() {
                this.items = [];
                this.allItems = [];
                this.filters = { minPrice: null, maxPrice: null };
                this.sortBy = 'price_diff';
                
                // 🔥 新增：流式分析变量
                this.streamingActive = false;
                this.eventSource = null;
                
                this.initEventListeners();
                this.init(); // 🔥 修复：调用完整的初始化方法
            }

            // 绑定事件监听器
            initEventListeners() {
                
                // 设置按钮
                const settingsBtn = document.getElementById('settingsBtn');
                if (settingsBtn) {
                    settingsBtn.addEventListener('click', () => this.openSettings());
                }
                
                // 关闭设置模态框
                const closeSettings = document.getElementById('closeSettings');
                if (closeSettings) {
                    closeSettings.addEventListener('click', () => this.closeSettings());
                }
                
                // 标签页切换
                const generalTab = document.getElementById('generalTab');
                if (generalTab) {
                    generalTab.addEventListener('click', () => this.showGeneralTab());
                }
                
                const tokensTab = document.getElementById('tokensTab');
                if (tokensTab) {
                    tokensTab.addEventListener('click', () => this.showTokenTab());
                }
                
                // 应用筛选按钮
                const applyFilter = document.getElementById('applyFilter');
                if (applyFilter) {
                    applyFilter.addEventListener('click', () => this.applyFilters());
                }

                // 重置筛选按钮
                const resetFilter = document.getElementById('resetFilter');
                if (resetFilter) {
                    resetFilter.addEventListener('click', () => this.resetFilters());
                }

                // 保存设置按钮
                const saveSettings = document.getElementById('saveSettings');
                if (saveSettings) {
                    saveSettings.addEventListener('click', () => this.saveSettings());
                }

                // Token相关按钮
                const updateBuffToken = document.getElementById('updateBuffToken');
                if (updateBuffToken) {
                    updateBuffToken.addEventListener('click', () => this.updateBuffToken());
                }

                const updateYoupinToken = document.getElementById('updateYoupinToken');
                if (updateYoupinToken) {
                    updateYoupinToken.addEventListener('click', () => this.updateYoupinToken());
                }

                const testBuffConnection = document.getElementById('testBuffConnection');
                if (testBuffConnection) {
                    testBuffConnection.addEventListener('click', () => this.testBuffConnection());
                }

                const testYoupinConnection = document.getElementById('testYoupinConnection');
                if (testYoupinConnection) {
                    testYoupinConnection.addEventListener('click', () => this.testYoupinConnection());
                }

                // 验证Token按钮
                const validateBuffToken = document.getElementById('validateBuffToken');
                if (validateBuffToken) {
                    validateBuffToken.addEventListener('click', () => this.validateSingleToken('buff'));
                }

                const validateYoupinToken = document.getElementById('validateYoupinToken');
                if (validateYoupinToken) {
                    validateYoupinToken.addEventListener('click', () => this.validateSingleToken('youpin'));
                }

                // 🔥 新增：强制更新按钮
                const forceFullUpdate = document.getElementById('forceFullUpdate');
                if (forceFullUpdate) {
                    forceFullUpdate.addEventListener('click', () => this.forceFullUpdate());
                }
                
                const forceIncrementalUpdate = document.getElementById('forceIncrementalUpdate');
                if (forceIncrementalUpdate) {
                    forceIncrementalUpdate.addEventListener('click', () => this.forceIncrementalUpdate());
                }
                
                // 🔥 新增：增强增量更新按钮事件
                const enhancedIncrementalUpdate = document.getElementById('enhancedIncrementalUpdate');
                if (enhancedIncrementalUpdate) {
                    enhancedIncrementalUpdate.addEventListener('click', () => this.enhancedIncrementalUpdate());
                }
            }

            // 应用筛选功能
            async applyFilters() {
                try {
                    const minPrice = document.getElementById('minPriceFilter').value || 0;
                    const maxPrice = document.getElementById('maxPriceFilter').value || 0;
                    const sortBy = document.getElementById('sortBy').value || 'price_diff';
                    const limit = document.getElementById('limitCount').value || 100;
                    
                    // 保存排序方式
                    this.sortBy = sortBy;
                    
                    // 如果设置了价格区间，先更新后端配置
                    if (minPrice > 0 && maxPrice > 0 && minPrice < maxPrice) {
                        await this.updatePriceRange(parseFloat(minPrice), parseFloat(maxPrice));
                    }
                    
                    // 重新加载数据
                    await this.loadData();
                    
                    // 🔥 修复：应用排序和限制
                    this.applySorting();
                    this.applyLimit(parseInt(limit));
                    this.renderItems();
                    this.calculateStatistics();
                    
                                            this.showAlert('success', '✅ 筛选已应用');
                } catch (error) {
                    console.error('应用筛选失败:', error);
                    this.showAlert('error', '筛选失败: ' + error.message);
                }
            }

            // 重置筛选功能
            async resetFilters() {
                try {
                    // 清空输入框
                    document.getElementById('minPriceFilter').value = '';
                    document.getElementById('maxPriceFilter').value = '';
                    document.getElementById('sortBy').value = 'price_diff';
                    document.getElementById('limitCount').value = '100';
                    
                    // 重置排序方式
                    this.sortBy = 'price_diff';
                    
                    // 重置为默认价格区间
                    await this.updatePriceRange(3.0, 5.0);
                    
                    // 重新加载数据
                    await this.loadData();
                    
                                            this.showAlert('success', '✅ 筛选已重置');
                } catch (error) {
                    console.error('重置筛选失败:', error);
                    this.showAlert('error', '重置失败: ' + error.message);
                }
            }

            // 更新价格区间
            async updatePriceRange(min, max) {
                try {
                    const response = await fetch(BASE_PATH + '/api/price_range', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ min: min, max: max })
                    });
                    
                    const result = await response.json();
                    
                    if (!result.success) {
                        throw new Error(result.error || '更新价格区间失败');
                    }
                    
                    console.log('价格区间已更新:', result.message);
                } catch (error) {
                    console.error('更新价格区间失败:', error);
                    throw error;
                }
            }

            async init() {
                this.initMobileSupport();
                this.loadConfig();
                this.loadData();
                this.loadStatus();
                this.loadStatistics();
                
                // 🔥 修复：只刷新状态和统计，不自动重新加载数据
                setInterval(() => {
                    // 只有在非流式分析状态下才更新显示
                    if (!this.streamingActive) {
                        this.loadData(); // 仅获取缓存数据，不触发分析
                    }
                    this.loadStatus();
                    this.loadStatistics();
                }, 30000); // 每30秒刷新一次
            }

            initMobileSupport() {
                // 检测设备类型
                this.isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                this.isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
                
                // 添加设备类型到body
                document.body.classList.add(this.isMobile ? 'is-mobile' : 'is-desktop');
                if (this.isTouch) {
                    document.body.classList.add('is-touch');
                }
                
                // 移动端特殊处理
                if (this.isMobile) {
                    this.setupMobileEvents();
                    this.adjustMobileLayout();
                }
            }

            setupMobileEvents() {
                // 移动端下拉刷新
                let startY = 0;
                let isScrolling = false;
                
                document.addEventListener('touchstart', (e) => {
                    startY = e.touches[0].clientY;
                    isScrolling = window.scrollY === 0;
                }, { passive: true });
                
                document.addEventListener('touchmove', (e) => {
                    if (!isScrolling) return;
                    
                    const currentY = e.touches[0].clientY;
                    const diffY = currentY - startY;
                    
                    if (diffY > 100 && window.scrollY === 0) {
                        // 下拉刷新
                        this.showAlert('info', '🔄 正在刷新数据...');
                        this.loadData();
                    }
                }, { passive: true });
                
                // 移动端键盘适配
                const viewport = document.querySelector('meta[name=viewport]');
                document.addEventListener('focusin', () => {
                    if (viewport) {
                        viewport.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no';
                    }
                });
                
                document.addEventListener('focusout', () => {
                    if (viewport) {
                        viewport.content = 'width=device-width, initial-scale=1.0';
                    }
                });
            }

            adjustMobileLayout() {
                // 调整移动端布局
                const container = document.querySelector('.max-w-7xl');
                if (container) {
                    container.classList.add('mobile-optimized');
                }
                
                // 优化按钮大小
                const buttons = document.querySelectorAll('button');
                buttons.forEach(btn => {
                    if (!btn.classList.contains('touch-target')) {
                        btn.classList.add('touch-target');
                    }
                });
            }

            async loadData() {
                const loading = document.getElementById('loading');
                const itemsList = document.getElementById('itemsList');
                
                loading.classList.remove('hidden');
                itemsList.classList.add('hidden');
                
                try {
                    // 🔥 修复：只获取缓存数据，不自动触发分析
                    const response = await fetch(BASE_PATH + '/api/data');
                    const result = await response.json();
                    
                    if (result.success) {
                        this.items = result.data.items;
                        document.getElementById('totalCount').textContent = this.items.length;
                        
                        // 🔥 修复：自动应用当前的排序设置
                        if (this.sortBy) {
                            this.applySorting();
                        }
                        
                        this.renderItems();
                        this.calculateStatistics();
                        
                        // 如果没有数据，显示提示
                        if (this.items.length === 0) {
                            itemsList.innerHTML = `<div class="p-8 text-center text-gray-500">
                                <div class="text-lg mb-2">📊 暂无价差数据</div>
                                <div class="text-sm">系统会自动在后台进行增量分析，请稍等片刻</div>
                            </div>`;
                        }
                    } else {
                        itemsList.innerHTML = `<div class="p-8 text-center text-red-500">加载失败: ${result.error}</div>`;
                    }
                } catch (error) {
                    console.error('加载数据失败:', error);
                    itemsList.innerHTML = `<div class="p-8 text-center text-red-500">网络错误: ${error.message}</div>`;
                } finally {
                    if (!this.streamingActive) {
                        loading.classList.add('hidden');
                    }
                }
            }

            // 🔥 新增：流式更新方法
            startStreamingUpdate() {
                if (this.streamingActive) return;
                
                this.streamingActive = true;
                this.showStreamingProgress();
                
                const eventSource = new EventSource(BASE_PATH + '/api/stream_analyze');
                
                eventSource.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        this.handleStreamingUpdate(data);
                    } catch (e) {
                        console.error('解析流式数据失败:', e);
                    }
                };
                
                eventSource.onerror = (error) => {
                    console.error('流式连接错误:', error);
                    eventSource.close();
                    this.streamingActive = false;
                    this.hideStreamingProgress();
                };
                
                // 保存引用以便后续关闭
                this.eventSource = eventSource;
            }

            // 🔥 新增：处理流式更新数据
            handleStreamingUpdate(data) {
                const { type, message } = data;
                
                switch (type) {
                    case 'progress':
                        this.updateStreamingProgress(data);
                        break;
                        
                    case 'incremental_results':
                        this.addIncrementalResults(data);
                        break;
                        
                    case 'completed':
                        this.completeStreamingUpdate(data);
                        break;
                        
                    case 'error':
                        this.showAlert('error', `流式更新错误: ${data.error}`);
                        this.stopStreaming();
                        break;
                }
            }

            // 🔥 新增：显示流式进度
            showStreamingProgress() {
                const loading = document.getElementById('loading');
                if (loading) {
                    loading.innerHTML = `
                        <div class="flex flex-col items-center justify-center p-8">
                            <div class="w-64 bg-gray-200 rounded-full h-2 mb-4">
                                <div id="streamProgress" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <div class="loading text-blue-600 text-2xl mb-2">
                                <i class="fas fa-spinner"></i>
                            </div>
                            <span id="streamStatus" class="text-gray-600">开始流式分析...</span>
                            <div class="mt-4 text-sm text-gray-500">
                                <div>已处理: <span id="streamProcessed">0</span> 个商品</div>
                                <div>新发现: <span id="streamFound">0</span> 个价差商品</div>
                            </div>
                        </div>
                    `;
                    loading.classList.remove('hidden');
                }
            }

            // 🔥 新增：更新流式进度
            updateStreamingProgress(data) {
                const progress = data.progress || 0;
                const message = data.message || '';
                
                const progressBar = document.getElementById('streamProgress');
                const statusText = document.getElementById('streamStatus');
                
                if (progressBar) {
                    progressBar.style.width = `${progress}%`;
                }
                
                if (statusText) {
                    statusText.textContent = message;
                }
            }

            // 🔥 新增：添加增量结果
            addIncrementalResults(data) {
                const newItems = data.data || [];
                const totalFound = data.total_found || 0;
                const totalProcessed = data.total_processed || 0;
                
                // 更新统计显示
                const processedElement = document.getElementById('streamProcessed');
                const foundElement = document.getElementById('streamFound');
                
                if (processedElement) {
                    processedElement.textContent = totalProcessed.toLocaleString();
                }
                
                if (foundElement) {
                    foundElement.textContent = totalFound.toLocaleString();
                }
                
                // 添加新商品到列表
                if (newItems.length > 0) {
                    this.items = [...this.items, ...newItems];
                    
                    // 重新排序和渲染
                    this.applySorting();
                    this.renderItems();
                    
                    // 更新总数
                    document.getElementById('totalCount').textContent = this.items.length;
                    
                    // 重新计算统计
                    this.calculateStatistics();
                    
                    // 显示增量提示
                                            this.showAlert('success', `🎉 新发现 ${newItems.length} 个价差商品！`);
                }
            }

            // 🔥 新增：完成流式更新
            completeStreamingUpdate(data) {
                const totalFound = data.total_found || 0;
                const totalProcessed = data.total_processed || 0;
                
                                        this.showAlert('success', `🎯 分析完成！处理了 ${totalProcessed.toLocaleString()} 个商品，发现 ${totalFound.toLocaleString()} 个价差商品`);
                this.stopStreaming();
            }

            // 🔥 新增：停止流式更新
            stopStreaming() {
                if (this.eventSource) {
                    this.eventSource.close();
                    this.eventSource = null;
                }
                
                this.streamingActive = false;
                this.hideStreamingProgress();
            }

            // 🔥 新增：隐藏流式进度
            hideStreamingProgress() {
                const loading = document.getElementById('loading');
                if (loading) {
                    loading.classList.add('hidden');
                }
            }

            updateTable(items) {
                this.items = items || [];
                this.renderItems();
            }

            async loadStatistics() {
                try {
                    // 移除统计信息API调用，直接使用status接口的数据
                    const response = await fetch(BASE_PATH + '/api/status');
                    const result = await response.json();
                    
                    if (result.success) {
                        const data = result.data;
                        
                        // 修正元素ID：从totalItems改为totalCount
                        const totalCountElement = document.getElementById('totalCount');
                        const avgDiffElement = document.getElementById('avgDiff');
                        const maxDiffElement = document.getElementById('maxDiff');
                        
                        if (totalCountElement) {
                            totalCountElement.textContent = data.current_items_count || 0;
                        }
                        if (avgDiffElement) {
                            avgDiffElement.textContent = '计算中...';
                        }
                        if (maxDiffElement) {
                            maxDiffElement.textContent = '计算中...';
                        }
                        
                        // 如果有商品数据，获取更详细的统计
                        if (data.current_items_count > 0) {
                            await this.loadDetailedStatistics();
                        }
                    }
                } catch (error) {
                    console.error('加载统计信息失败:', error);
                }
            }

            async loadDetailedStatistics() {
                try {
                    const response = await fetch(BASE_PATH + '/api/data');
                    const result = await response.json();
                    
                    if (result.success && result.data.items.length > 0) {
                        const items = result.data.items;
                        const totalDiff = items.reduce((sum, item) => sum + item.price_diff, 0);
                        const avgDiff = totalDiff / items.length;
                        const maxDiff = Math.max(...items.map(item => item.price_diff || 0));
                        
                        const avgDiffElement = document.getElementById('avgDiff');
                        const maxDiffElement = document.getElementById('maxDiff');
                        
                        if (avgDiffElement) {
                            avgDiffElement.textContent = `¥${avgDiff.toFixed(2)}`;
                        }
                        if (maxDiffElement) {
                            maxDiffElement.textContent = `¥${maxDiff.toFixed(2)}`;
                        }
                    }
                } catch (error) {
                    console.error('加载详细统计失败:', error);
                }
            }

            async loadStatus() {
                try {
                    const response = await fetch(BASE_PATH + '/api/status');
                    const result = await response.json();
                    
                    if (result.success) {
                        this.updateStatus(result.data);
                    }
                } catch (error) {
                    console.error('检查状态失败:', error);
                }
            }

            updateStatus(status) {
                const lastUpdate = status.last_update ? 
                    new Date(status.last_update).toLocaleString('zh-CN') : '未知';
                document.getElementById('lastUpdate').textContent = lastUpdate;
                
                // 更新监控状态
                const statusElement = document.getElementById('updateStatus');
                if (statusElement) {
                    const isRunning = status.is_running;
                    statusElement.innerHTML = `
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${isRunning ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            <i class="fas ${isRunning ? 'fa-play' : 'fa-pause'} mr-1"></i>
                            ${isRunning ? '监控中' : '已停止'}
                        </span>
                    `;
                }
            }

            renderItems() {
                const loading = document.getElementById('loading');
                const itemsList = document.getElementById('itemsList');
                
                loading.classList.add('hidden');
                itemsList.classList.remove('hidden');
                
                if (this.items.length === 0) {
                    itemsList.innerHTML = `
                        <div class="p-8 text-center text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-4"></i>
                            <p>暂无符合条件的差价饰品</p>
                        </div>
                    `;
                    return;
                }
                
                const itemsHtml = this.items.map(item => this.renderItem(item)).join('');
                itemsList.innerHTML = itemsHtml;
            }

            renderItem(item) {
                const profitClass = this.getProfitClass(item.profit_rate || 0);
                const imageUrl = item.image_url || '/static/placeholder.png';
                
                return `
                    <div class="border-b border-gray-200 p-3 sm:p-6 card-hover">
                        <!-- 桌面端布局 -->
                        <div class="hidden sm:flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <img src="${imageUrl}" alt="${item.name}" 
                                     class="w-16 h-16 rounded-lg object-cover bg-gray-100"
                                     onerror="this.src='/static/placeholder.png'">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 mb-1">${item.name}</h3>
                                    <div class="flex items-center space-x-4 text-sm text-gray-600">
                                        <span>Buff: <span class="font-medium text-red-600">¥${item.buff_price}</span></span>
                                        <span>悠悠: <span class="font-medium text-green-600">¥${item.youpin_price}</span></span>
                                        <span class="text-xs ${profitClass} text-white px-2 py-1 rounded-full">
                                            利润率 ${(item.profit_rate || 0).toFixed(1)}%
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex items-center space-x-4">
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-green-600">
                                        +¥${(item.price_diff || 0).toFixed(2)}
                                    </div>
                                    <div class="text-sm text-gray-500">价差</div>
                                </div>
                                
                                <button onclick="window.open('${item.buff_url || '#'}', '_blank')" 
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition duration-200 flex items-center">
                                    <i class="fas fa-external-link-alt mr-2"></i>
                                    立即购买
                                </button>
                            </div>
                        </div>

                        <!-- 移动端布局 -->
                        <div class="sm:hidden">
                            <div class="flex items-start space-x-3 mb-3">
                                <img src="${imageUrl}" alt="${item.name}" 
                                     class="w-12 h-12 rounded-lg object-cover bg-gray-100 flex-shrink-0"
                                     onerror="this.src='/static/placeholder.png'">
                                <div class="flex-1 min-w-0">
                                    <h3 class="text-sm font-semibold text-gray-900 mb-1 truncate" title="${item.name}">${item.name}</h3>
                                    <div class="flex flex-wrap gap-1 text-xs text-gray-600">
                                        <span class="bg-red-50 text-red-700 px-2 py-1 rounded">Buff: ¥${item.buff_price}</span>
                                        <span class="bg-green-50 text-green-700 px-2 py-1 rounded">悠悠: ¥${item.youpin_price}</span>
                                    </div>
                                </div>
                            </div>

                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="text-center">
                                        <div class="text-lg font-bold text-green-600">
                                            +¥${(item.price_diff || 0).toFixed(2)}
                                        </div>
                                        <div class="text-xs text-gray-500">价差</div>
                                    </div>
                                    <span class="text-xs ${profitClass} text-white px-2 py-1 rounded-full">
                                        ${(item.profit_rate || 0).toFixed(1)}%
                                    </span>
                                </div>
                                
                                <button onclick="window.open('${item.buff_url || '#'}', '_blank')" 
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition duration-200 flex items-center text-sm touch-target">
                                    <i class="fas fa-external-link-alt mr-1"></i>
                                    购买
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            getProfitClass(margin) {
                if (margin >= 50) return 'profit-very-high';
                if (margin >= 30) return 'profit-high';
                return 'profit-positive';
            }

            openSettings() {
                document.getElementById('settingsModal').classList.remove('hidden');
                this.loadConfig();
            }

            closeSettings() {
                document.getElementById('settingsModal').classList.add('hidden');
            }

            async loadConfig() {
                console.log('🔄 开始加载配置...');
                try {
                    // 加载设置
                    const settingsResponse = await fetch(BASE_PATH + '/api/settings');
                    const settingsResult = await settingsResponse.json();
                    
                    if (settingsResult.success) {
                        const data = settingsResult.data;
                        document.getElementById('thresholdInput').value = data.threshold || '';
                        document.getElementById('maxOutputItems').value = data.max_output_items || '';
                        
                        if (data.price_range) {
                            document.getElementById('priceRangeMin').value = data.price_range.min || '';
                            document.getElementById('priceRangeMax').value = data.price_range.max || '';
                        }
                        
                        if (data.buff_price_range) {
                            const buffMinEl = document.getElementById('buffPriceMin');
                            const buffMaxEl = document.getElementById('buffPriceMax');
                            
                            if (buffMinEl && data.buff_price_range.min !== null && data.buff_price_range.min !== undefined) {
                                buffMinEl.value = data.buff_price_range.min;
                            }
                            if (buffMaxEl && data.buff_price_range.max !== null && data.buff_price_range.max !== undefined) {
                                buffMaxEl.value = data.buff_price_range.max;
                            }
                            
                            console.log('🔧 Buff价格区间已设置:', data.buff_price_range);
                        } else {
                            console.warn('⚠️ 未收到buff_price_range数据');
                        }
                        
                        if (data.buff_sell_num) {
                            const buffSellNumInput = document.getElementById('buffSellNumMin');
                            if (buffSellNumInput && data.buff_sell_num.min !== null && data.buff_sell_num.min !== undefined) {
                                buffSellNumInput.value = data.buff_sell_num.min;
                            }
                            console.log('🔧 Buff在售数量设置已加载:', data.buff_sell_num.min);
                        }
                        
                        if (data.update_intervals) {
                            const fullInterval = document.getElementById('fullUpdateInterval');
                            const incrementalInterval = document.getElementById('incrementalUpdateInterval');
                            
                            if (fullInterval) {
                                fullInterval.textContent = `${data.update_intervals.full_update_hours}小时`;
                            }
                            
                            if (incrementalInterval) {
                                incrementalInterval.textContent = `${data.update_intervals.incremental_update_minutes}分钟`;
                            }
                        }
                    }

                    // 加载当前价格区间
                    const rangeResponse = await fetch(BASE_PATH + '/api/price_range');
                    const rangeResult = await rangeResponse.json();
                    
                    if (rangeResult.success) {
                        const currentRange = document.getElementById('currentPriceRange');
                        if (currentRange) {
                            currentRange.textContent = rangeResult.data.current_range;
                        }
                    }
                    
                    // 加载Buff价格筛选区间
                    const buffRangeResponse = await fetch(BASE_PATH + '/api/buff_price_range');
                    const buffRangeResult = await buffRangeResponse.json();
                    
                    if (buffRangeResult.success) {
                        const currentBuffRange = document.getElementById('currentBuffPriceRange');
                        if (currentBuffRange) {
                            currentBuffRange.textContent = buffRangeResult.data.current_range;
                        }
                    }
                    
                    // 加载Buff在售数量筛选（显示当前值）
                    const buffSellNumResponse = await fetch(BASE_PATH + '/api/buff_sell_num');
                    const buffSellNumResult = await buffSellNumResponse.json();
                    
                    if (buffSellNumResult.success) {
                        const currentBuffSellNum = document.getElementById('currentBuffSellNum');
                        if (currentBuffSellNum) {
                            currentBuffSellNum.textContent = `≥ ${buffSellNumResult.data.min_sell_num} 个`;
                        }
                        console.log('🔧 Buff在售数量当前值已显示:', buffSellNumResult.data.min_sell_num);
                    }
                } catch (error) {
                    console.error('加载配置失败:', error);
                }
            }

            async saveSettings() {
                try {
                    const threshold = document.getElementById('thresholdInput').value;
                    const priceMin = document.getElementById('priceRangeMin').value;
                    const priceMax = document.getElementById('priceRangeMax').value;
                    const buffPriceMin = document.getElementById('buffPriceMin').value;
                    const buffPriceMax = document.getElementById('buffPriceMax').value;
                    const buffSellNumMin = document.getElementById('buffSellNumMin').value;
                    const maxOutputItems = document.getElementById('maxOutputItems').value;
                    
                    // 验证价格区间
                    if (priceMin && priceMax) {
                        const min = parseFloat(priceMin);
                        const max = parseFloat(priceMax);
                        
                        if (min >= max) {
                            this.showAlert('error', '最小价差必须小于最大价差');
                            return;
                        }
                        
                        if (min < 0 || max < 0) {
                            this.showAlert('error', '价差不能为负数');
                            return;
                        }
                    }
                    
                    // 验证Buff价格区间
                    if (buffPriceMin && buffPriceMax) {
                        const min = parseFloat(buffPriceMin);
                        const max = parseFloat(buffPriceMax);
                        
                        if (min >= max) {
                            this.showAlert('error', 'Buff最小价格必须小于最大价格');
                            return;
                        }
                        
                        if (min < 0 || max < 0) {
                            this.showAlert('error', 'Buff价格不能为负数');
                            return;
                        }
                    }
                    
                    // 验证Buff在售数量
                    if (buffSellNumMin) {
                        const num = parseInt(buffSellNumMin);
                        
                        if (num < 0) {
                            this.showAlert('error', 'Buff在售数量不能为负数');
                            return;
                        }
                    }
                    
                    const updateData = {};
                    
                    if (threshold) {
                        updateData.threshold = parseFloat(threshold);
                    }
                    
                    if (priceMin && priceMax) {
                        updateData.price_min = parseFloat(priceMin);
                        updateData.price_max = parseFloat(priceMax);
                    }
                    
                    if (buffPriceMin && buffPriceMax) {
                        updateData.buff_price_min = parseFloat(buffPriceMin);
                        updateData.buff_price_max = parseFloat(buffPriceMax);
                    }
                    
                    if (buffSellNumMin) {
                        updateData.buff_sell_num_min = parseInt(buffSellNumMin);
                    }
                    
                    if (maxOutputItems) {
                        updateData.max_output_items = parseInt(maxOutputItems);
                    }
                    
                    if (Object.keys(updateData).length === 0) {
                        this.showAlert('warning', '⚠️ 没有设置需要保存');
                        return;
                    }
                    
                    const response = await fetch(BASE_PATH + '/api/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updateData)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // 🔥 优化：先显示成功提示，稍后关闭设置窗口
                        this.showAlert('success', '✅ 设置保存成功！' + result.message);
                        
                        // 重新加载配置显示
                        setTimeout(() => this.loadConfig(), 500);
                        
                        // 🔥 延迟关闭设置窗口，让用户看到成功提示
                        setTimeout(() => {
                            this.closeSettings();
                            // 重新加载数据
                            this.loadData();
                        }, 2000);
                        
                    } else {
                        this.showAlert('error', '❌ 保存失败: ' + result.error);
                    }
                } catch (error) {
                    console.error('保存设置失败:', error);
                    this.showAlert('error', '保存失败: ' + error.message);
                }
            }

            // 🔥 新增：强制全量更新
            async forceFullUpdate() {
                const btn = document.getElementById('forceFullUpdate');
                const originalText = btn.innerHTML;
                
                try {
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>正在更新...';
                    btn.disabled = true;
                    
                    const response = await fetch(BASE_PATH + '/api/force_update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.showAlert('success', '🚀 ' + result.message);
                        // 延迟重新加载数据
                        setTimeout(() => this.loadData(), 2000);
                    } else {
                        this.showAlert('error', '❌ 全量更新失败: ' + (result.error || '未知错误'));
                    }
                } catch (error) {
                    console.error('强制全量更新失败:', error);
                    this.showAlert('error', '全量更新失败: ' + error.message);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
            
            // 🔥 新增：强制增量更新
            async forceIncrementalUpdate() {
                const btn = document.getElementById('forceIncrementalUpdate');
                const originalText = btn.innerHTML;
                
                try {
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>正在更新...';
                    btn.disabled = true;
                    
                    const response = await fetch(BASE_PATH + '/api/force_incremental_update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.showAlert('success', '⚡ ' + result.message);
                        // 延迟重新加载数据
                        setTimeout(() => this.loadData(), 1000);
                    } else {
                        this.showAlert('error', '❌ 增量更新失败: ' + (result.error || '未知错误'));
                    }
                } catch (error) {
                    console.error('强制增量更新失败:', error);
                    this.showAlert('error', '增量更新失败: ' + error.message);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }

            // 🔥 新增：增强增量更新（支持价格更新和完成标识）
            async enhancedIncrementalUpdate() {
                const btn = document.getElementById('enhancedIncrementalUpdate');
                const originalText = btn.innerHTML;
                
                try {
                    // 禁用按钮防止重复点击
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> 启动中...';
                    
                    this.showAlert('info', '🚀 正在启动增强增量更新...');
                    
                    const response = await fetch(BASE_PATH + '/api/enhanced_incremental_update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.showAlert('success', result.message);
                        
                        // 开始轮询状态
                        this.startEnhancedUpdateStatusPolling(btn, originalText);
                    } else {
                        this.showAlert('error', `❌ ${result.message}`);
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                } catch (error) {
                    console.error('增强增量更新失败:', error);
                    this.showAlert('error', '增强增量更新失败: ' + error.message);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }

            // 🔥 新增：开始状态轮询
            startEnhancedUpdateStatusPolling(btn, originalText) {
                const pollInterval = setInterval(async () => {
                    try {
                        const response = await fetch(BASE_PATH + '/api/incremental_update_status');
                        const result = await response.json();
                        
                        if (result.success) {
                            const status = result.data;
                            
                            if (status.is_running) {
                                // 更新按钮状态
                                const progress = status.completion_percentage || 0;
                                const task = status.current_task || '处理中';
                                btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-1"></i> ${task} (${progress}%)`;
                                
                                // 显示进度信息
                                if (status.processed_count > 0) {
                                    this.showAlert('info', 
                                        `🔄 ${task} - 已处理: ${status.processed_count} 个商品，已更新: ${status.updated_count} 个价格`, 
                                        false); // 不自动隐藏
                                }
                            } else {
                                // 更新完成
                                clearInterval(pollInterval);
                                btn.innerHTML = originalText;
                                btn.disabled = false;
                                
                                // 重新加载数据
                                await this.loadData();
                                
                                // 显示完成通知
                                const successMsg = status.updated_count > 0 ? 
                                    `✅ 增强增量更新完成！处理了 ${status.processed_count} 个商品，更新了 ${status.updated_count} 个价格` :
                                    `✅ 增量更新完成！已检查 ${status.processed_count} 个商品，暂无价格变化`;
                                
                                this.showAlert('success', successMsg);
                            }
                        } else {
                            throw new Error(result.message || '获取状态失败');
                        }
                    } catch (error) {
                        console.error('获取更新状态失败:', error);
                        clearInterval(pollInterval);
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                        this.showAlert('error', '获取更新状态失败: ' + error.message);
                    }
                }, 3000); // 每3秒检查一次状态
            }

            showAlert(type, message) {
                // 🔥 优化：每次创建新的提示框，支持多个提示同时显示
                const alertDiv = document.createElement('div');
                
                // 移动端适配：调整位置和宽度
                const isMobile = window.innerWidth <= 768;
                alertDiv.className = isMobile 
                    ? 'fixed top-4 left-2 right-2 z-50 mb-2' 
                    : 'fixed top-4 right-4 z-50 max-w-sm mb-2';
                
                // 🔥 优化：根据类型设置不同的样式和动画
                const alertClass = type === 'success' ? 'bg-green-500 text-white border-green-600 shadow-lg' : 
                                  type === 'warning' ? 'bg-yellow-500 text-white border-yellow-600 shadow-lg' :
                                  type === 'info' ? 'bg-blue-500 text-white border-blue-600 shadow-lg' :
                                  'bg-red-500 text-white border-red-600 shadow-lg';
                
                const icon = type === 'success' ? 'check-circle' : 
                            type === 'warning' ? 'exclamation-triangle' : 
                            type === 'info' ? 'info-circle' :
                            'times-circle';
                
                // 移动端优化：调整字体大小和间距
                const textSize = isMobile ? 'text-sm' : 'text-base';
                const iconSize = isMobile ? 'text-base' : 'text-lg';
                const padding = isMobile ? 'p-3' : 'p-4';
                const translateX = isMobile ? 'translate-y-full' : 'translate-x-full';
                
                alertDiv.innerHTML = `
                    <div class="border ${alertClass} rounded-lg ${padding} transform transition-all duration-300 ${translateX} opacity-0" id="alertContent">
                        <div class="flex items-center">
                            <i class="fas fa-${icon} mr-2 sm:mr-3 ${iconSize} flex-shrink-0"></i>
                            <span class="font-medium ${textSize} flex-1 min-w-0 pr-2">${message}</span>
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                    class="flex-shrink-0 text-white hover:text-gray-200 touch-target p-1">
                                <i class="fas fa-times text-sm"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(alertDiv);
                
                // 🔥 添加滑入动画
                setTimeout(() => {
                    const content = alertDiv.querySelector('#alertContent');
                    if (isMobile) {
                        content.classList.remove('translate-y-full', 'opacity-0');
                        content.classList.add('translate-y-0', 'opacity-100');
                    } else {
                        content.classList.remove('translate-x-full', 'opacity-0');
                        content.classList.add('translate-x-0', 'opacity-100');
                    }
                }, 100);
                
                // 🔥 优化：成功提示显示更长时间，移动端时间稍短
                const baseDelay = isMobile ? 3000 : 4000;
                const hideDelay = type === 'success' ? baseDelay : 
                                 type === 'error' ? baseDelay + 2000 : 
                                 baseDelay - 1000;
                
                // 自动隐藏
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        const content = alertDiv.querySelector('#alertContent');
                        if (isMobile) {
                            content.classList.add('translate-y-full', 'opacity-0');
                        } else {
                            content.classList.add('translate-x-full', 'opacity-0');
                        }
                        setTimeout(() => alertDiv.remove(), 300);
                    }
                }, hideDelay);
            }

            // Token管理方法
            showGeneralTab() {
                document.getElementById('generalTab').className = 'px-4 py-2 font-medium text-blue-600 border-b-2 border-blue-600';
                document.getElementById('tokensTab').className = 'px-4 py-2 font-medium text-gray-600 hover:text-blue-600 ml-4';
                document.getElementById('generalPanel').classList.remove('hidden');
                document.getElementById('tokensPanel').classList.add('hidden');
            }
            
            showTokenTab() {
                document.getElementById('generalTab').className = 'px-4 py-2 font-medium text-gray-600 hover:text-blue-600';
                document.getElementById('tokensTab').className = 'px-4 py-2 font-medium text-blue-600 border-b-2 border-blue-600 ml-4';
                document.getElementById('generalPanel').classList.add('hidden');
                document.getElementById('tokensPanel').classList.remove('hidden');
                
                // 加载Token状态
                this.loadTokenStatus();
            }
            
            async loadTokenStatus() {
                try {
                    const response = await fetch(BASE_PATH + '/api/tokens/status');
                    const result = await response.json();
                    
                    if (result.success) {
                        const { buff, youpin } = result.data;
                        
                        // 更新Buff状态
                        const buffStatus = document.getElementById('buffTokenStatus');
                        const buffValidationStatus = this.getValidationStatusBadge(buff);
                        buffStatus.innerHTML = buffValidationStatus;
                        
                        // 更新悠悠有品状态
                        const youpinStatus = document.getElementById('youpinTokenStatus');
                        const youpinValidationStatus = this.getValidationStatusBadge(youpin);
                        youpinStatus.innerHTML = youpinValidationStatus;
                        
                        // 检查是否有失效的token
                        this.checkTokenValidity(buff, youpin);
                    }
                } catch (error) {
                    console.error('加载Token状态失败:', error);
                }
            }

            getValidationStatusBadge(tokenInfo) {
                const configured = tokenInfo.configured || (tokenInfo.has_cookies && tokenInfo.has_csrf) || (tokenInfo.has_device_id && tokenInfo.has_uk);
                const cachedValid = tokenInfo.cached_valid;
                const lastValidation = tokenInfo.last_validation;
                const cachedError = tokenInfo.cached_error;
                
                let statusClass = 'bg-gray-100 text-gray-800';
                let statusText = '未配置';
                let statusIcon = '❓';
                
                if (configured) {
                    if (cachedValid === true) {
                        statusClass = 'bg-green-100 text-green-800';
                        statusText = '已验证';
                        statusIcon = '✅';
                    } else if (cachedValid === false && cachedError) {
                        if (cachedError.includes('失效') || cachedError.includes('登录') || cachedError.includes('401') || cachedError.includes('403')) {
                            statusClass = 'bg-red-100 text-red-800';
                            statusText = 'Token已失效';
                            statusIcon = '❌';
                        } else {
                            statusClass = 'bg-yellow-100 text-yellow-800';
                            statusText = '验证失败';
                            statusIcon = '⚠️';
                        }
                    } else {
                        statusClass = 'bg-blue-100 text-blue-800';
                        statusText = '已配置';
                        statusIcon = '🔑';
                    }
                }
                
                let tooltipText = '';
                if (lastValidation) {
                    const validationTime = new Date(lastValidation).toLocaleString();
                    tooltipText = `最后验证: ${validationTime}`;
                    if (cachedError) {
                        tooltipText += `\n错误: ${cachedError}`;
                    }
                }
                
                return `
                    <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium ${statusClass}" 
                          title="${tooltipText}">
                        ${statusIcon} ${statusText}
                    </span>
                `;
            }

            checkTokenValidity(buff, youpin) {
                const invalidTokens = [];
                
                console.log('🔍 检查Token有效性...', { buff, youpin });
                
                // 🔥 修复：只有在Token确实失效时才显示警报
                // 检查Buff Token - 只有cached_valid明确为false才检查
                if (buff.configured && buff.cached_valid === false && buff.cached_error) {
                    // 只有真正的Token失效错误才显示警报
                    if (this.isTokenExpiredError(buff.cached_error)) {
                        console.log('❌ Buff Token失效');
                        invalidTokens.push({
                            platform: 'Buff', 
                            error: buff.cached_error
                        });
                    } else {
                        console.log('⚠️ Buff Token验证失败（非失效）:', buff.cached_error);
                    }
                } else if (buff.configured && buff.cached_valid === null) {
                    console.log('🔄 Buff Token状态未知（可能是网络问题）:', buff.cached_error);
                }
                
                // 检查悠悠有品Token - 只有cached_valid明确为false才检查
                if (youpin.configured && youpin.cached_valid === false && youpin.cached_error) {
                    // 只有真正的Token失效错误才显示警报
                    if (this.isTokenExpiredError(youpin.cached_error)) {
                        console.log('❌ 悠悠有品Token失效');
                        invalidTokens.push({
                            platform: '悠悠有品', 
                            error: youpin.cached_error
                        });
                    } else {
                        console.log('⚠️ 悠悠有品Token验证失败（非失效）:', youpin.cached_error);
                    }
                } else if (youpin.configured && youpin.cached_valid === null) {
                    console.log('🔄 悠悠有品Token状态未知（可能是网络问题）:', youpin.cached_error);
                }
                
                console.log('🚨 发现失效Token:', invalidTokens);
                
                if (invalidTokens.length > 0) {
                    this.showTokenExpiredAlert(invalidTokens);
                } else {
                    console.log('✅ 所有Token状态正常');
                }
            }

            showTokenExpiredAlert(invalidTokens) {
                const platforms = invalidTokens.map(t => t.platform).join('、');
                const errors = invalidTokens.map(t => t.error).join('\n');
                
                const alertHtml = `
                    <div class="fixed top-4 right-4 bg-red-50 border-l-4 border-red-400 p-4 rounded-md shadow-lg z-50 max-w-md" id="tokenExpiredAlert">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-red-800">
                                    🚨 API Token已失效
                                </h3>
                                <div class="mt-2 text-sm text-red-700">
                                    <p><strong>${platforms}</strong> 的API Token已失效，请重新配置：</p>
                                    <ul class="list-disc list-inside mt-1">
                                        ${invalidTokens.map(t => `<li>${t.platform}: ${t.error}</li>`).join('')}
                                    </ul>
                                </div>
                                <div class="mt-4">
                                    <div class="flex space-x-2">
                                        <button onclick="app.showConfigPanel()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
                                            立即配置
                                        </button>
                                        <button onclick="app.validateAllTokens()" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm">
                                            重新验证
                                        </button>
                                        <button onclick="document.getElementById('tokenExpiredAlert').remove()" class="text-gray-500 hover:text-gray-700 text-sm">
                                            忽略
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // 移除旧的警报
                const oldAlert = document.getElementById('tokenExpiredAlert');
                if (oldAlert) {
                    oldAlert.remove();
                }
                
                // 添加新的警报
                document.body.insertAdjacentHTML('beforeend', alertHtml);
                
                // 10秒后自动消失
                setTimeout(() => {
                    const alert = document.getElementById('tokenExpiredAlert');
                    if (alert) {
                        alert.style.opacity = '0';
                        alert.style.transform = 'translateX(100%)';
                        setTimeout(() => alert.remove(), 300);
                    }
                }, 10000);
            }

            async validateAllTokens() {
                try {
                    // 🔥 优化：显示带进度的验证提示
                    this.showAlert('info', '🔍 正在验证所有Token...', 0); // 不自动消失
                    
                    // 🔥 优化：添加20秒超时控制
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 20000);
                    
                    const response = await fetch(BASE_PATH + '/api/tokens/validate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ force_check: true }),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        const { buff, youpin, overall_valid, validation_time } = result.data;
                        
                        // 显示验证时间
                        const timeInfo = validation_time ? ` (耗时: ${validation_time}秒)` : '';
                        
                        if (overall_valid) {
                            this.showAlert('success', `✅ 所有Token验证通过！${timeInfo}`);
                        } else {
                            let message = `❌ Token验证失败${timeInfo}:\n`;
                            if (!buff.valid) {
                                message += `• Buff: ${buff.error}\n`;
                            }
                            if (!youpin.valid) {
                                message += `• 悠悠有品: ${youpin.error}`;
                            }
                            this.showAlert('error', message);
                        }
                        
                        // 刷新状态显示
                        this.loadTokenStatus();
                    } else {
                        this.showAlert('error', `❌ Token验证失败: ${result.error}`);
                    }
                } catch (error) {
                    if (error.name === 'AbortError') {
                        this.showAlert('warning', '⚠️ Token验证超时，请检查网络连接或稍后重试');
                    } else {
                        console.error('验证Token失败:', error);
                        this.showAlert('error', `❌ Token验证失败: ${error.message}`);
                    }
                }
            }

            showConfigPanel() {
                // 显示设置面板并切换到Token配置标签
                const settingsModal = document.getElementById('settingsModal');
                const tokensTab = document.querySelector('[data-tab="tokens"]');
                
                if (settingsModal) {
                    settingsModal.classList.remove('hidden');
                }
                
                if (tokensTab) {
                    tokensTab.click();
                }
            }

            // 🔥 新增：初始化Token状态检查
            async initTokenStatusCheck() {
                try {
                    console.log('🔍 开始检查Token状态...');
                    
                    // 1. 启动Token验证服务
                    await this.startTokenValidationService();
                    
                    // 2. 立即检查一次Token状态
                    await this.checkInitialTokenStatus();
                    
                    // 3. 设置定期检查（每5分钟）
                    this.setupPeriodicTokenCheck();
                    
                    console.log('✅ Token状态检查初始化完成');
                } catch (error) {
                    console.error('❌ Token状态检查初始化失败:', error);
                }
            }

            async startTokenValidationService() {
                try {
                    console.log('🚀 启动Token验证服务...');
                    const response = await fetch(BASE_PATH + '/api/tokens/validation-service', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'start' })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        console.log('✅ Token验证服务已启动');
                    } else {
                        console.warn('⚠️ Token验证服务启动失败:', result.error);
                    }
                } catch (error) {
                    console.error('❌ 启动Token验证服务失败:', error);
                }
            }

            async checkInitialTokenStatus() {
                try {
                    console.log('🔍 检查初始Token状态...');
                    const response = await fetch(BASE_PATH + '/api/tokens/status');
                    const result = await response.json();
                    
                    if (result.success) {
                        const { buff, youpin } = result.data;
                        console.log('📊 Token状态:', { buff, youpin });
                        
                        // 🔥 修复：只有在Token明确失效且有错误信息时才显示警报
                        // 避免在验证未完成时显示误报
                        const shouldShowAlert = this.shouldShowTokenAlert(buff, youpin);
                        if (shouldShowAlert.show) {
                            this.checkTokenValidity(buff, youpin);
                        } else {
                            console.log('✅ Token状态正常或验证未完成，不显示警报');
                        }
                        
                        // 🔥 新增：如果Token需要验证但没有明确失效，进行后台验证
                        if (this.shouldValidateTokensInBackground(buff, youpin)) {
                            console.log('🔄 后台验证Token状态...');
                            this.validateTokensInBackground();
                        }
                    }
                } catch (error) {
                    console.error('❌ 检查初始Token状态失败:', error);
                }
            }

            shouldShowTokenAlert(buff, youpin) {
                // 🔥 修复：只有在以下情况才显示警报：
                // 1. Token已配置
                // 2. cached_valid明确为false（不是null）
                // 3. 有具体的错误信息
                // 4. 错误信息表明Token确实失效（而不是网络错误等）
                
                const buffShouldAlert = buff.configured && 
                    buff.cached_valid === false && // 明确为false，不是null
                    buff.cached_error && 
                    this.isTokenExpiredError(buff.cached_error);
                    
                const youpinShouldAlert = youpin.configured && 
                    youpin.cached_valid === false && // 明确为false，不是null
                    youpin.cached_error && 
                    this.isTokenExpiredError(youpin.cached_error);
                
                console.log('🔍 Token警报检查:', {
                    buff: { configured: buff.configured, cached_valid: buff.cached_valid, cached_error: buff.cached_error, shouldAlert: buffShouldAlert },
                    youpin: { configured: youpin.configured, cached_valid: youpin.cached_valid, cached_error: youpin.cached_error, shouldAlert: youpinShouldAlert }
                });
                
                return {
                    show: buffShouldAlert || youpinShouldAlert,
                    buff: buffShouldAlert,
                    youpin: youpinShouldAlert
                };
            }

            isTokenExpiredError(error) {
                // 🔥 优化：判断错误是否表明Token确实失效
                const expiredKeywords = [
                    '失效', '过期', '无效', '登录', '认证失败', 'token已失效', 'token无效',
                    '401', '403', 'unauthorized', 'forbidden', 'authentication failed',
                    'expired', 'invalid', 'login', 'auth', 'credential'
                ];
                
                // 排除的关键词（这些通常是网络或其他技术问题，不是Token失效）
                const excludeKeywords = [
                    '网络', '超时', '连接', '响应为空', 'timeout', 'network', 'connection',
                    'api响应为空', '格式异常', 'json', 'parse', '500', '502', '503', '504'
                ];
                
                const errorLower = error.toLowerCase();
                
                // 如果包含排除关键词，则不认为是Token失效
                const hasExcludeKeyword = excludeKeywords.some(keyword => 
                    errorLower.includes(keyword.toLowerCase())
                );
                
                if (hasExcludeKeyword) {
                    return false;
                }
                
                // 检查是否包含Token失效关键词
                const hasExpiredKeyword = expiredKeywords.some(keyword => 
                    errorLower.includes(keyword.toLowerCase())
                );
                
                return hasExpiredKeyword;
            }

            shouldValidateTokensInBackground(buff, youpin) {
                // 需要后台验证的情况：
                // 1. Token已配置但没有验证缓存
                // 2. Token已配置但验证时间过久（超过1小时）
                const oneHourAgo = Date.now() - 60 * 60 * 1000;
                
                const buffNeedsValidation = buff.configured && 
                    (buff.cached_valid === null || 
                     !buff.last_validation || 
                     new Date(buff.last_validation).getTime() < oneHourAgo);
                     
                const youpinNeedsValidation = youpin.configured && 
                    (youpin.cached_valid === null || 
                     !youpin.last_validation || 
                     new Date(youpin.last_validation).getTime() < oneHourAgo);
                
                return buffNeedsValidation || youpinNeedsValidation;
            }

            async validateTokensInBackground() {
                // 后台验证，不显示加载提示，不阻塞用户操作
                try {
                    console.log('🔄 后台验证Token...');
                    
                    const response = await fetch(BASE_PATH + '/api/tokens/validate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ force_check: false }) // 不强制检查，使用缓存
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        console.log('✅ 后台Token验证完成');
                        // 刷新状态显示
                        this.loadTokenStatus();
                    } else {
                        console.log('⚠️ 后台Token验证失败:', result.error);
                    }
                } catch (error) {
                    console.log('⚠️ 后台Token验证异常:', error.message);
                }
            }

            setupPeriodicTokenCheck() {
                // 每5分钟检查一次Token状态
                setInterval(async () => {
                    try {
                        console.log('⏰ 定期检查Token状态...');
                        await this.checkInitialTokenStatus();
                    } catch (error) {
                        console.error('❌ 定期Token检查失败:', error);
                    }
                }, 5 * 60 * 1000); // 5分钟
                
                console.log('⏰ 已设置Token状态定期检查（每5分钟）');
            }

            async validateSingleToken(platform) {
                try {
                    this.showAlert('info', `🔍 正在验证${platform === 'buff' ? 'Buff' : '悠悠有品'}Token...`);
                    
                    const response = await fetch(BASE_PATH + `/api/tokens/validate/${platform}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ force_check: true })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        const { valid, error } = result.data;
                        
                        if (valid) {
                            this.showAlert('success', `✅ ${platform === 'buff' ? 'Buff' : '悠悠有品'}Token验证通过！`);
                        } else {
                            this.showAlert('error', `❌ ${platform === 'buff' ? 'Buff' : '悠悠有品'}Token验证失败: ${error}`);
                        }
                        
                        // 刷新状态显示
                        this.loadTokenStatus();
                    } else {
                        this.showAlert('error', `❌ 验证${platform === 'buff' ? 'Buff' : '悠悠有品'}Token失败: ${result.error}`);
                    }
                } catch (error) {
                    console.error(`验证${platform}Token失败:`, error);
                    this.showAlert('error', `❌ 验证${platform === 'buff' ? 'Buff' : '悠悠有品'}Token失败: ${error.message}`);
                }
            }
            
            getStatusBadge(status, isValid) {
                if (status === '已配置' && isValid) {
                    return `<span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800">
                        <i class="fas fa-check mr-1"></i>已配置
                    </span>`;
                } else if (status === '已配置' && !isValid) {
                    return `<span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-800">
                        <i class="fas fa-exclamation-triangle mr-1"></i>配置不完整
                    </span>`;
                } else {
                    return `<span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-800">
                        <i class="fas fa-times mr-1"></i>未配置
                    </span>`;
                }
            }
            
            async updateBuffToken() {
                try {
                    const session = document.getElementById('buffSession').value.trim();
                    const csrfToken = document.getElementById('buffCsrfToken').value.trim();
                    const otherCookiesText = document.getElementById('buffOtherCookies').value.trim();
                    
                    if (!session || !csrfToken) {
                        this.showAlert('warning', '⚠️ 请输入Session和CSRF Token');
                        return;
                    }
                    
                    const cookies = {
                        session: session,
                        csrf_token: csrfToken
                    };
                    
                    // 解析其他cookies
                    if (otherCookiesText) {
                        try {
                            const otherCookies = JSON.parse(otherCookiesText);
                            Object.assign(cookies, otherCookies);
                        } catch (e) {
                            this.showAlert('warning', '⚠️ 其他Cookies格式错误，请使用正确的JSON格式');
                            return;
                        }
                    }
                    
                    const response = await fetch(BASE_PATH + '/api/tokens/buff', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ cookies })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.showAlert('success', '🔑 Buff Token更新成功！');
                        this.loadTokenStatus();
                        // 清空输入框
                        document.getElementById('buffSession').value = '';
                        document.getElementById('buffCsrfToken').value = '';
                        document.getElementById('buffOtherCookies').value = '';
                    } else {
                        this.showAlert('error', '❌ Buff Token更新失败: ' + (result.error || result.detail));
                    }
                } catch (error) {
                    console.error('更新Buff Token失败:', error);
                    this.showAlert('error', '❌ Buff Token更新失败: ' + error.message);
                }
            }
            
            async updateYoupinToken() {
                try {
                    const deviceId = document.getElementById('youpinDeviceId').value.trim();
                    const deviceUk = document.getElementById('youpinDeviceUk').value.trim();
                    const uk = document.getElementById('youpinUk').value.trim();
                    const b3 = document.getElementById('youpinB3').value.trim();
                    const authorization = document.getElementById('youpinAuthorization').value.trim();
                    
                    if (!deviceId || !uk) {
                        this.showAlert('warning', '⚠️ 请至少输入Device ID和UK');
                        return;
                    }
                    
                    const response = await fetch(BASE_PATH + '/api/tokens/youpin', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            device_id: deviceId,
                            device_uk: deviceUk,
                            uk: uk,
                            b3: b3,
                            authorization: authorization
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.showAlert('success', '🔑 悠悠有品Token更新成功！');
                        this.loadTokenStatus();
                        // 清空输入框
                        document.getElementById('youpinDeviceId').value = '';
                        document.getElementById('youpinDeviceUk').value = '';
                        document.getElementById('youpinUk').value = '';
                        document.getElementById('youpinB3').value = '';
                        document.getElementById('youpinAuthorization').value = '';
                    } else {
                        this.showAlert('error', '❌ 悠悠有品Token更新失败: ' + (result.error || result.detail));
                    }
                } catch (error) {
                    console.error('更新悠悠有品Token失败:', error);
                    this.showAlert('error', '❌ 悠悠有品Token更新失败: ' + error.message);
                }
            }
            
            async testBuffConnection() {
                const btn = document.getElementById('testBuffConnection');
                const originalText = btn.innerHTML;
                
                btn.innerHTML = '<i class="fas fa-spinner loading mr-1"></i>测试中...';
                btn.disabled = true;
                
                try {
                    const response = await fetch(BASE_PATH + '/api/test/buff', { method: 'POST' });
                    const result = await response.json();
                    
                    if (result.success) {
                        this.showAlert('success', `🔗 Buff连接测试成功！${result.message}`);
                    } else {
                        this.showAlert('error', `❌ Buff连接测试失败：${result.error}`);
                    }
                } catch (error) {
                    console.error('测试Buff连接失败:', error);
                    this.showAlert('error', '❌ Buff连接测试失败: ' + error.message);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
            
            async testYoupinConnection() {
                const btn = document.getElementById('testYoupinConnection');
                const originalText = btn.innerHTML;
                
                btn.innerHTML = '<i class="fas fa-spinner loading mr-1"></i>测试中...';
                btn.disabled = true;
                
                try {
                    const response = await fetch(BASE_PATH + '/api/test/youpin', { method: 'POST' });
                    const result = await response.json();
                    
                    if (result.success) {
                        this.showAlert('success', `🔗 悠悠有品连接测试成功！${result.message}`);
                    } else {
                        this.showAlert('error', `❌ 悠悠有品连接测试失败：${result.error}`);
                    }
                } catch (error) {
                    console.error('测试悠悠有品连接失败:', error);
                    this.showAlert('error', '❌ 悠悠有品连接测试失败: ' + error.message);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }

            // 🔥 新增：应用排序
            applySorting() {
                if (this.sortBy === 'price_diff') {
                    this.items.sort((a, b) => (b.price_diff || 0) - (a.price_diff || 0));
                } else if (this.sortBy === 'profit_margin') {
                    this.items.sort((a, b) => (b.profit_rate || 0) - (a.profit_rate || 0));
                }
            }

            // 🔥 新增：应用数量限制
            applyLimit(limit) {
                if (limit > 0 && this.items.length > limit) {
                    this.items = this.items.slice(0, limit);
                }
            }

            // 🔥 新增：计算统计信息
            calculateStatistics() {
                if (this.items.length === 0) {
                    document.getElementById('avgDiff').textContent = '-';
                    document.getElementById('maxDiff').textContent = '-';
                    return;
                }
                
                const totalDiff = this.items.reduce((sum, item) => sum + (item.price_diff || 0), 0);
                const avgDiff = totalDiff / this.items.length;
                const maxDiff = Math.max(...this.items.map(item => item.price_diff || 0));
                
                document.getElementById('avgDiff').textContent = `¥${avgDiff.toFixed(2)}`;
                document.getElementById('maxDiff').textContent = `¥${maxDiff.toFixed(2)}`;
            }
        }

        // 移动端适配工具函数
        function detectMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        function addMobileClasses() {
            const body = document.body;
            const isMobile = detectMobileDevice();
            const isTouch = 'ontouchstart' in window;
            
            body.classList.add(isMobile ? 'is-mobile' : 'is-desktop');
            if (isTouch) body.classList.add('is-touch');
            
            // 为iOS设备添加安全区域
            if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                body.classList.add('ios-safe-area');
            }
            
            console.log(`📱 设备检测: ${isMobile ? '移动端' : '桌面端'}, 触摸: ${isTouch ? '是' : '否'}`);
        }

        // 移动端viewport动态调整
        function setupMobileViewport() {
            const viewport = document.querySelector('meta[name=viewport]');
            if (!viewport) {
                const meta = document.createElement('meta');
                meta.name = 'viewport';
                meta.content = 'width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes';
                document.head.appendChild(meta);
                console.log('📱 已添加移动端viewport标签');
            }
        }

        // 移动端性能优化
        function optimizeForMobile() {
            if (detectMobileDevice()) {
                // 减少动画时间
                const style = document.createElement('style');
                style.textContent = `
                    * { 
                        transition-duration: 0.2s !important; 
                        animation-duration: 0.2s !important; 
                    }
                `;
                document.head.appendChild(style);
                
                // 禁用部分hover效果
                document.documentElement.classList.add('touch-device');
            }
        }

        // 初始化应用
        document.addEventListener('DOMContentLoaded', () => {
            console.log('📱 DOM已加载，初始化移动端适配...');
            
            // 移动端适配
            addMobileClasses();
            setupMobileViewport();
            optimizeForMobile();
            
            console.log('📱 初始化BuffMonitor...');
            const monitor = new BuffMonitor();
            
            // 延迟加载配置确保元素已渲染
            setTimeout(() => {
                console.log('⏰ 延迟加载配置...');
                monitor.loadConfig();
                
                // 🔥 新增：初始化Token状态检查
                console.log('🔍 初始化Token状态检查...');
                monitor.initTokenStatusCheck();
            }, 100);
        });
    </script>
</body>
</html> 