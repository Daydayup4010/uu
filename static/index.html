<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buffå·®ä»·ç›‘æ§ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .profit-positive {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .profit-high {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        .profit-very-high {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="gradient-bg shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fas fa-chart-line text-white text-2xl mr-3"></i>
                    <h1 class="text-white text-xl font-bold">Buffå·®ä»·ç›‘æ§ç³»ç»Ÿ</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="refreshBtn" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg transition duration-200">
                        <i class="fas fa-sync-alt mr-2"></i>
                        åˆ·æ–°æ•°æ®
                    </button>
                    <button id="settingsBtn" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg transition duration-200">
                        <i class="fas fa-cog mr-2"></i>
                        è®¾ç½®
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- ç»Ÿè®¡é¢æ¿ -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                        <i class="fas fa-gem text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">æ€»é¥°å“æ•°</p>
                        <p class="text-2xl font-semibold text-gray-900" id="totalCount">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-600">
                        <i class="fas fa-coins text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">å¹³å‡ä»·å·®</p>
                        <p class="text-2xl font-semibold text-gray-900" id="avgDiff">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                        <i class="fas fa-chart-bar text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">æœ€å¤§ä»·å·®</p>
                        <p class="text-2xl font-semibold text-gray-900" id="maxDiff">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                        <i class="fas fa-clock text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">æ›´æ–°æ—¶é—´</p>
                        <p class="text-sm font-semibold text-gray-900" id="lastUpdate">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¿‡æ»¤å’Œæ’åº -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <div class="flex flex-wrap items-center gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ä»·æ ¼åŒºé—´ï¼ˆå…ƒï¼‰</label>
                    <div class="flex items-center space-x-2">
                        <input type="number" id="minPriceFilter" placeholder="æœ€å°ä»·å·®" 
                               class="border border-gray-300 rounded-md px-3 py-2 w-24" step="0.1" min="0">
                        <span class="text-gray-500">-</span>
                        <input type="number" id="maxPriceFilter" placeholder="æœ€å¤§ä»·å·®" 
                               class="border border-gray-300 rounded-md px-3 py-2 w-24" step="0.1" min="0">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ’åºæ–¹å¼</label>
                    <select id="sortBy" class="border border-gray-300 rounded-md px-3 py-2">
                        <option value="price_diff">æŒ‰ä»·å·®æ’åº</option>
                        <option value="profit_margin">æŒ‰åˆ©æ¶¦ç‡æ’åº</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ˜¾ç¤ºæ•°é‡</label>
                    <select id="limitCount" class="border border-gray-300 rounded-md px-3 py-2">
                        <option value="50">50ä¸ª</option>
                        <option value="100" selected>100ä¸ª</option>
                        <option value="200">200ä¸ª</option>
                        <option value="500">500ä¸ª</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button id="applyFilter" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition duration-200">
                        <i class="fas fa-filter mr-2"></i>
                        åº”ç”¨ç­›é€‰
                    </button>
                </div>
                <div class="flex items-end">
                    <button id="resetFilter" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition duration-200 ml-2">
                        <i class="fas fa-undo mr-2"></i>
                        é‡ç½®
                    </button>
                </div>
            </div>
        </div>

        <!-- é¥°å“åˆ—è¡¨ -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-list mr-2"></i>
                    å·®ä»·é¥°å“åˆ—è¡¨
                </h2>
            </div>
            
            <div id="loading" class="flex items-center justify-center p-8">
                <div class="loading text-blue-600 text-2xl">
                    <i class="fas fa-spinner"></i>
                </div>
                <span class="ml-3 text-gray-600">æ­£åœ¨åŠ è½½æ•°æ®...</span>
            </div>
            
            <div id="itemsList" class="hidden">
                <!-- åŠ¨æ€ç”Ÿæˆçš„é¥°å“åˆ—è¡¨ -->
            </div>
        </div>
    </div>

    <!-- è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-4xl w-full p-6 max-h-screen overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold">ç³»ç»Ÿè®¾ç½®</h3>
                    <button id="closeSettings" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <!-- è®¾ç½®æ ‡ç­¾é¡µ -->
                <div class="flex border-b mb-6">
                    <button id="generalTab" class="px-4 py-2 font-medium text-blue-600 border-b-2 border-blue-600">
                        å¸¸è§„è®¾ç½®
                    </button>
                    <button id="tokensTab" class="px-4 py-2 font-medium text-gray-600 hover:text-blue-600 ml-4">
                        Tokenç®¡ç†
                    </button>
                </div>
                
                <!-- å¸¸è§„è®¾ç½®é¢æ¿ -->
                <div id="generalPanel" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ä»·æ ¼å·®å¼‚åŒºé—´ï¼ˆå…ƒï¼‰</label>
                        <div class="flex items-center space-x-2">
                            <input type="number" id="priceRangeMin" placeholder="æœ€å°ä»·å·®" 
                                   class="border border-gray-300 rounded-md px-3 py-2 w-24" step="0.1" min="0">
                            <span class="text-gray-500">-</span>
                            <input type="number" id="priceRangeMax" placeholder="æœ€å¤§ä»·å·®" 
                                   class="border border-gray-300 rounded-md px-3 py-2 w-24" step="0.1" min="0">
                        </div>
                        <p class="text-xs text-gray-500 mt-1">è®¾ç½®ä»·å·®ç­›é€‰åŒºé—´ï¼Œä¾‹å¦‚ 3-5å…ƒ</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Buffä»·æ ¼ç­›é€‰åŒºé—´ï¼ˆå…ƒï¼‰</label>
                        <div class="flex items-center space-x-2">
                            <input type="number" id="buffPriceMin" placeholder="æœ€å°ä»·æ ¼" 
                                   class="border border-gray-300 rounded-md px-3 py-2 w-24" step="0.1" min="0">
                            <span class="text-gray-500">-</span>
                            <input type="number" id="buffPriceMax" placeholder="æœ€å¤§ä»·æ ¼" 
                                   class="border border-gray-300 rounded-md px-3 py-2 w-24" step="0.1" min="0">
                        </div>
                        <p class="text-xs text-gray-500 mt-1">åªåˆ†ææ­¤ä»·æ ¼åŒºé—´å†…çš„Buffå•†å“ï¼Œç”¨äºå¢é‡æ›´æ–°</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æœ€å¤§è¾“å‡ºæ•°é‡</label>
                        <input type="number" id="maxOutputItems" placeholder="300" 
                               class="w-full border border-gray-300 rounded-md px-3 py-2" min="1" step="1">
                        <p class="text-xs text-gray-500 mt-1">é™åˆ¶æœ€ç»ˆè¾“å‡ºçš„å•†å“æ•°é‡</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ›´æ–°é—´éš”è®¾ç½®</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">å…¨é‡æ›´æ–°ï¼ˆå°æ—¶ï¼‰</label>
                                <div class="text-sm text-blue-600 font-medium" id="fullUpdateInterval">1å°æ—¶</div>
                                <p class="text-xs text-gray-500">è·å–å…¨éƒ¨æ•°æ®çš„é—´éš”</p>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">å¢é‡æ›´æ–°ï¼ˆåˆ†é’Ÿï¼‰</label>
                                <div class="text-sm text-blue-600 font-medium" id="incrementalUpdateInterval">1åˆ†é’Ÿ</div>
                                <p class="text-xs text-gray-500">æœç´¢ç‰¹å®šå•†å“çš„é—´éš”</p>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ‰‹åŠ¨æ›´æ–°æ“ä½œ</label>
                        <div class="flex space-x-2">
                            <button id="forceFullUpdate" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-sm">
                                <i class="fas fa-download mr-1"></i>
                                å¼ºåˆ¶å…¨é‡æ›´æ–°
                            </button>
                            <button id="forceIncrementalUpdate" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm">
                                <i class="fas fa-sync mr-1"></i>
                                å¼ºåˆ¶å¢é‡æ›´æ–°
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">ç«‹å³æ‰§è¡ŒæŒ‡å®šç±»å‹çš„æ›´æ–°</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ä»·å·®é˜ˆå€¼ï¼ˆå…ƒï¼‰- å…¼å®¹æ¨¡å¼</label>
                        <input type="number" id="thresholdInput" placeholder="20" 
                               class="w-full border border-gray-300 rounded-md px-3 py-2" step="0.1" min="0">
                        <p class="text-xs text-gray-500 mt-1">ä¼ ç»Ÿå•ä¸€é˜ˆå€¼æ¨¡å¼ï¼ˆå»ºè®®ä½¿ç”¨ä»·æ ¼åŒºé—´ï¼‰</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å½“å‰ä»·æ ¼åŒºé—´</label>
                        <div id="currentPriceRange" class="text-sm text-blue-600 font-medium">
                            åŠ è½½ä¸­...
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å½“å‰Buffä»·æ ¼ç­›é€‰</label>
                        <div id="currentBuffPriceRange" class="text-sm text-blue-600 font-medium">
                            åŠ è½½ä¸­...
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ›´æ–°çŠ¶æ€</label>
                        <div id="updateStatus" class="text-sm">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                <i class="fas fa-clock mr-1"></i>
                                æ­£åœ¨æ£€æŸ¥...
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- Tokenç®¡ç†é¢æ¿ -->
                <div id="tokensPanel" class="hidden space-y-6">
                    <!-- TokençŠ¶æ€æ¦‚è§ˆ -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-medium text-gray-900 mb-3">TokençŠ¶æ€</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">Buff API</p>
                                <div id="buffTokenStatus" class="mt-1">
                                    <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-800">
                                        æ£€æŸ¥ä¸­...
                                    </span>
                                </div>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">æ‚ æ‚ æœ‰å“ API</p>
                                <div id="youpinTokenStatus" class="mt-1">
                                    <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-800">
                                        æ£€æŸ¥ä¸­...
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Buff Tokenè®¾ç½® -->
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-medium text-gray-900">Buff Token é…ç½®</h4>
                            <button id="testBuffConnection" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                                <i class="fas fa-plug mr-1"></i>
                                æµ‹è¯•è¿æ¥
                            </button>
                        </div>
                        
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Session Cookie</label>
                                <input type="text" id="buffSession" placeholder="sessionå€¼..." 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">CSRF Token</label>
                                <input type="text" id="buffCsrfToken" placeholder="csrf_tokenå€¼..." 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">å…¶ä»–Cookies (JSONæ ¼å¼)</label>
                                <textarea id="buffOtherCookies" placeholder='{"Device-Id": "xxx", "remember_me": "xxx"}'
                                          class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm h-20"></textarea>
                                <p class="text-xs text-gray-500 mt-1">å¯é€‰ï¼šå…¶ä»–cookiesï¼ŒJSONæ ¼å¼</p>
                            </div>
                            <button id="updateBuffToken" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                                <i class="fas fa-save mr-2"></i>
                                æ›´æ–° Buff Token
                            </button>
                        </div>
                    </div>
                    
                    <!-- æ‚ æ‚ æœ‰å“Tokenè®¾ç½® -->
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-medium text-gray-900">æ‚ æ‚ æœ‰å“ Token é…ç½®</h4>
                            <button id="testYoupinConnection" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                                <i class="fas fa-plug mr-1"></i>
                                æµ‹è¯•è¿æ¥
                            </button>
                        </div>
                        
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Device ID</label>
                                <input type="text" id="youpinDeviceId" placeholder="device_idå€¼..." 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Device UK</label>
                                <input type="text" id="youpinDeviceUk" placeholder="device_ukå€¼..." 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">UK</label>
                                <input type="text" id="youpinUk" placeholder="ukå€¼..." 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">B3</label>
                                <input type="text" id="youpinB3" placeholder="b3å€¼..." 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Authorization Token</label>
                                <input type="text" id="youpinAuthorization" placeholder="Bearer xxxæˆ–JWT token..." 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                                <p class="text-xs text-gray-500 mt-1">è®¤è¯Tokenï¼Œé€šå¸¸ä»¥Bearerå¼€å¤´</p>
                            </div>
                            <button id="updateYoupinToken" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                                <i class="fas fa-save mr-2"></i>
                                æ›´æ–°æ‚ æ‚ æœ‰å“ Token
                            </button>
                        </div>
                    </div>
                    
                    <!-- Tokenè·å–è¯´æ˜ -->
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-medium text-blue-900 mb-2">
                            <i class="fas fa-info-circle mr-2"></i>
                            å¦‚ä½•è·å–Token
                        </h4>
                        <div class="text-sm text-blue-800 space-y-2">
                            <p><strong>Buff Token:</strong></p>
                            <p>1. åœ¨æµè§ˆå™¨ä¸­ç™»å½• buff.163.com</p>
                            <p>2. æ‰“å¼€å¼€å‘è€…å·¥å…· (F12) â†’ Network æ ‡ç­¾</p>
                            <p>3. åˆ·æ–°é¡µé¢ï¼ŒæŸ¥æ‰¾å¯¹ /api/market/goods çš„è¯·æ±‚</p>
                            <p>4. å¤åˆ¶è¯·æ±‚å¤´ä¸­çš„ session å’Œ csrf_token cookies</p>
                            
                            <p><strong>æ‚ æ‚ æœ‰å“Token:</strong></p>
                            <p>1. åœ¨æµè§ˆå™¨ä¸­è®¿é—® youpin898.com</p>
                            <p>2. æ‰“å¼€å¼€å‘è€…å·¥å…· â†’ Network æ ‡ç­¾</p>
                            <p>3. æŸ¥æ‰¾å¯¹ api.youpin898.com çš„è¯·æ±‚</p>
                            <p>4. å¤åˆ¶è¯·æ±‚å¤´ä¸­çš„ç›¸å…³å‚æ•°</p>
                            <p>5. <strong>é‡è¦</strong>ï¼šå¤åˆ¶Authorizationå¤´ï¼ˆé€šå¸¸ä»¥Bearerå¼€å¤´ï¼‰</p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end space-x-3">
                    <button id="saveSettings" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition duration-200">
                        ä¿å­˜è®¾ç½®
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class BuffMonitor {
            constructor() {
                this.items = [];
                this.allItems = [];
                this.filters = { minPrice: null, maxPrice: null };
                this.sortBy = 'price_diff';
                
                // ğŸ”¥ æ–°å¢ï¼šæµå¼åˆ†æå˜é‡
                this.streamingActive = false;
                this.eventSource = null;
                
                this.initEventListeners();
                this.loadData();
                this.loadStatus();
            }

            // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            initEventListeners() {
                // åˆ·æ–°æŒ‰é’®
                const refreshBtn = document.getElementById('refreshBtn');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', () => this.forceUpdate());
                }
                
                // è®¾ç½®æŒ‰é’®
                const settingsBtn = document.getElementById('settingsBtn');
                if (settingsBtn) {
                    settingsBtn.addEventListener('click', () => this.openSettings());
                }
                
                // å…³é—­è®¾ç½®æ¨¡æ€æ¡†
                const closeSettings = document.getElementById('closeSettings');
                if (closeSettings) {
                    closeSettings.addEventListener('click', () => this.closeSettings());
                }
                
                // æ ‡ç­¾é¡µåˆ‡æ¢
                const generalTab = document.getElementById('generalTab');
                if (generalTab) {
                    generalTab.addEventListener('click', () => this.showGeneralTab());
                }
                
                const tokensTab = document.getElementById('tokensTab');
                if (tokensTab) {
                    tokensTab.addEventListener('click', () => this.showTokenTab());
                }
                
                // åº”ç”¨ç­›é€‰æŒ‰é’®
                const applyFilter = document.getElementById('applyFilter');
                if (applyFilter) {
                    applyFilter.addEventListener('click', () => this.applyFilters());
                }

                // é‡ç½®ç­›é€‰æŒ‰é’®
                const resetFilter = document.getElementById('resetFilter');
                if (resetFilter) {
                    resetFilter.addEventListener('click', () => this.resetFilters());
                }

                // ä¿å­˜è®¾ç½®æŒ‰é’®
                const saveSettings = document.getElementById('saveSettings');
                if (saveSettings) {
                    saveSettings.addEventListener('click', () => this.saveSettings());
                }

                // Tokenç›¸å…³æŒ‰é’®
                const updateBuffToken = document.getElementById('updateBuffToken');
                if (updateBuffToken) {
                    updateBuffToken.addEventListener('click', () => this.updateBuffToken());
                }

                const updateYoupinToken = document.getElementById('updateYoupinToken');
                if (updateYoupinToken) {
                    updateYoupinToken.addEventListener('click', () => this.updateYoupinToken());
                }

                const testBuffConnection = document.getElementById('testBuffConnection');
                if (testBuffConnection) {
                    testBuffConnection.addEventListener('click', () => this.testBuffConnection());
                }

                const testYoupinConnection = document.getElementById('testYoupinConnection');
                if (testYoupinConnection) {
                    testYoupinConnection.addEventListener('click', () => this.testYoupinConnection());
                }

                // ğŸ”¥ æ–°å¢ï¼šå¼ºåˆ¶æ›´æ–°æŒ‰é’®
                const forceFullUpdate = document.getElementById('forceFullUpdate');
                if (forceFullUpdate) {
                    forceFullUpdate.addEventListener('click', () => this.forceFullUpdate());
                }
                
                const forceIncrementalUpdate = document.getElementById('forceIncrementalUpdate');
                if (forceIncrementalUpdate) {
                    forceIncrementalUpdate.addEventListener('click', () => this.forceIncrementalUpdate());
                }
            }

            // åº”ç”¨ç­›é€‰åŠŸèƒ½
            async applyFilters() {
                try {
                    const minPrice = document.getElementById('minPriceFilter').value || 0;
                    const maxPrice = document.getElementById('maxPriceFilter').value || 0;
                    const sortBy = document.getElementById('sortBy').value || 'price_diff';
                    const limit = document.getElementById('limitCount').value || 100;
                    
                    // å¦‚æœè®¾ç½®äº†ä»·æ ¼åŒºé—´ï¼Œå…ˆæ›´æ–°åç«¯é…ç½®
                    if (minPrice > 0 && maxPrice > 0 && minPrice < maxPrice) {
                        await this.updatePriceRange(parseFloat(minPrice), parseFloat(maxPrice));
                    }
                    
                    // é‡æ–°åŠ è½½æ•°æ®
                    await this.loadData();
                    
                    this.showAlert('success', 'ç­›é€‰å·²åº”ç”¨');
                } catch (error) {
                    console.error('åº”ç”¨ç­›é€‰å¤±è´¥:', error);
                    this.showAlert('error', 'ç­›é€‰å¤±è´¥: ' + error.message);
                }
            }

            // é‡ç½®ç­›é€‰åŠŸèƒ½
            async resetFilters() {
                try {
                    // æ¸…ç©ºè¾“å…¥æ¡†
                    document.getElementById('minPriceFilter').value = '';
                    document.getElementById('maxPriceFilter').value = '';
                    document.getElementById('sortBy').value = 'price_diff';
                    document.getElementById('limitCount').value = '100';
                    
                    // é‡ç½®ä¸ºé»˜è®¤ä»·æ ¼åŒºé—´
                    await this.updatePriceRange(3.0, 5.0);
                    
                    // é‡æ–°åŠ è½½æ•°æ®
                    await this.loadData();
                    
                    this.showAlert('success', 'ç­›é€‰å·²é‡ç½®');
                } catch (error) {
                    console.error('é‡ç½®ç­›é€‰å¤±è´¥:', error);
                    this.showAlert('error', 'é‡ç½®å¤±è´¥: ' + error.message);
                }
            }

            // æ›´æ–°ä»·æ ¼åŒºé—´
            async updatePriceRange(min, max) {
                try {
                    const response = await fetch('/api/price_range', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ min: min, max: max })
                    });
                    
                    const result = await response.json();
                    
                    if (!result.success) {
                        throw new Error(result.error || 'æ›´æ–°ä»·æ ¼åŒºé—´å¤±è´¥');
                    }
                    
                    console.log('ä»·æ ¼åŒºé—´å·²æ›´æ–°:', result.message);
                } catch (error) {
                    console.error('æ›´æ–°ä»·æ ¼åŒºé—´å¤±è´¥:', error);
                    throw error;
                }
            }

            async init() {
                this.loadConfig();
                this.loadData();
                this.loadStatus();
                this.loadStatistics();
                
                // å¯åŠ¨å®šæ—¶åˆ·æ–°
                setInterval(() => {
                    this.loadData();
                    this.loadStatus();
                    this.loadStatistics();
                }, 30000); // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡
            }

            async loadData() {
                const loading = document.getElementById('loading');
                const itemsList = document.getElementById('itemsList');
                
                loading.classList.remove('hidden');
                itemsList.classList.add('hidden');
                
                try {
                    // ğŸ”¥ æ–°å¢ï¼šå°è¯•å¢é‡åˆ†æï¼ˆç«‹å³è¿”å›ç¼“å­˜æ•°æ®ï¼‰
                    const incrementalResponse = await fetch('/api/analyze_incremental', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ force_refresh: false })
                    });
                    
                    const incrementalResult = await incrementalResponse.json();
                    
                    if (incrementalResult.success && incrementalResult.data.cached) {
                        // ç«‹å³æ˜¾ç¤ºç¼“å­˜æ•°æ®
                        this.items = incrementalResult.data.items;
                        document.getElementById('totalCount').textContent = this.items.length;
                        this.renderItems();
                        
                        // æ˜¾ç¤ºç¼“å­˜æç¤º
                        this.showAlert('info', 'æ˜¾ç¤ºç¼“å­˜æ•°æ®ï¼Œæ­£åœ¨åå°æ›´æ–°å…¨é‡æ•°æ®...');
                        
                        // å¯åŠ¨æµå¼æ›´æ–°
                        if (incrementalResult.background_update) {
                            setTimeout(() => this.startStreamingUpdate(), 1000);
                        }
                        
                        this.calculateStatistics();
                        return;
                    }
                    
                    // å›é€€åˆ°åŸæœ‰é€»è¾‘
                    const response = await fetch('/api/data');
                    const result = await response.json();
                    
                    if (result.success) {
                        this.items = result.data.items;
                        document.getElementById('totalCount').textContent = this.items.length;
                        this.renderItems();
                        this.calculateStatistics();
                    } else {
                        itemsList.innerHTML = `<div class="p-8 text-center text-red-500">åŠ è½½å¤±è´¥: ${result.error}</div>`;
                    }
                } catch (error) {
                    console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                    itemsList.innerHTML = `<div class="p-8 text-center text-red-500">ç½‘ç»œé”™è¯¯: ${error.message}</div>`;
                } finally {
                    if (!this.streamingActive) {
                        loading.classList.add('hidden');
                    }
                }
            }

            // ğŸ”¥ æ–°å¢ï¼šæµå¼æ›´æ–°æ–¹æ³•
            startStreamingUpdate() {
                if (this.streamingActive) return;
                
                this.streamingActive = true;
                this.showStreamingProgress();
                
                const eventSource = new EventSource('/api/stream_analyze');
                
                eventSource.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        this.handleStreamingUpdate(data);
                    } catch (e) {
                        console.error('è§£ææµå¼æ•°æ®å¤±è´¥:', e);
                    }
                };
                
                eventSource.onerror = (error) => {
                    console.error('æµå¼è¿æ¥é”™è¯¯:', error);
                    eventSource.close();
                    this.streamingActive = false;
                    this.hideStreamingProgress();
                };
                
                // ä¿å­˜å¼•ç”¨ä»¥ä¾¿åç»­å…³é—­
                this.eventSource = eventSource;
            }

            // ğŸ”¥ æ–°å¢ï¼šå¤„ç†æµå¼æ›´æ–°æ•°æ®
            handleStreamingUpdate(data) {
                const { type, message } = data;
                
                switch (type) {
                    case 'progress':
                        this.updateStreamingProgress(data);
                        break;
                        
                    case 'incremental_results':
                        this.addIncrementalResults(data);
                        break;
                        
                    case 'completed':
                        this.completeStreamingUpdate(data);
                        break;
                        
                    case 'error':
                        this.showAlert('error', `æµå¼æ›´æ–°é”™è¯¯: ${data.error}`);
                        this.stopStreaming();
                        break;
                }
            }

            // ğŸ”¥ æ–°å¢ï¼šæ˜¾ç¤ºæµå¼è¿›åº¦
            showStreamingProgress() {
                const loading = document.getElementById('loading');
                if (loading) {
                    loading.innerHTML = `
                        <div class="flex flex-col items-center justify-center p-8">
                            <div class="w-64 bg-gray-200 rounded-full h-2 mb-4">
                                <div id="streamProgress" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <div class="loading text-blue-600 text-2xl mb-2">
                                <i class="fas fa-spinner"></i>
                            </div>
                            <span id="streamStatus" class="text-gray-600">å¼€å§‹æµå¼åˆ†æ...</span>
                            <div class="mt-4 text-sm text-gray-500">
                                <div>å·²å¤„ç†: <span id="streamProcessed">0</span> ä¸ªå•†å“</div>
                                <div>æ–°å‘ç°: <span id="streamFound">0</span> ä¸ªä»·å·®å•†å“</div>
                            </div>
                        </div>
                    `;
                    loading.classList.remove('hidden');
                }
            }

            // ğŸ”¥ æ–°å¢ï¼šæ›´æ–°æµå¼è¿›åº¦
            updateStreamingProgress(data) {
                const progress = data.progress || 0;
                const message = data.message || '';
                
                const progressBar = document.getElementById('streamProgress');
                const statusText = document.getElementById('streamStatus');
                
                if (progressBar) {
                    progressBar.style.width = `${progress}%`;
                }
                
                if (statusText) {
                    statusText.textContent = message;
                }
            }

            // ğŸ”¥ æ–°å¢ï¼šæ·»åŠ å¢é‡ç»“æœ
            addIncrementalResults(data) {
                const newItems = data.data || [];
                const totalFound = data.total_found || 0;
                const totalProcessed = data.total_processed || 0;
                
                // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
                const processedElement = document.getElementById('streamProcessed');
                const foundElement = document.getElementById('streamFound');
                
                if (processedElement) {
                    processedElement.textContent = totalProcessed.toLocaleString();
                }
                
                if (foundElement) {
                    foundElement.textContent = totalFound.toLocaleString();
                }
                
                // æ·»åŠ æ–°å•†å“åˆ°åˆ—è¡¨
                if (newItems.length > 0) {
                    this.items = [...this.items, ...newItems];
                    
                    // é‡æ–°æ’åºå’Œæ¸²æŸ“
                    this.applySorting();
                    this.renderItems();
                    
                    // æ›´æ–°æ€»æ•°
                    document.getElementById('totalCount').textContent = this.items.length;
                    
                    // é‡æ–°è®¡ç®—ç»Ÿè®¡
                    this.calculateStatistics();
                    
                    // æ˜¾ç¤ºå¢é‡æç¤º
                    this.showAlert('success', `æ–°å‘ç° ${newItems.length} ä¸ªä»·å·®å•†å“ï¼`);
                }
            }

            // ğŸ”¥ æ–°å¢ï¼šå®Œæˆæµå¼æ›´æ–°
            completeStreamingUpdate(data) {
                const totalFound = data.total_found || 0;
                const totalProcessed = data.total_processed || 0;
                
                this.showAlert('success', `åˆ†æå®Œæˆï¼å¤„ç†äº† ${totalProcessed.toLocaleString()} ä¸ªå•†å“ï¼Œå‘ç° ${totalFound.toLocaleString()} ä¸ªä»·å·®å•†å“`);
                this.stopStreaming();
            }

            // ğŸ”¥ æ–°å¢ï¼šåœæ­¢æµå¼æ›´æ–°
            stopStreaming() {
                if (this.eventSource) {
                    this.eventSource.close();
                    this.eventSource = null;
                }
                
                this.streamingActive = false;
                this.hideStreamingProgress();
            }

            // ğŸ”¥ æ–°å¢ï¼šéšè—æµå¼è¿›åº¦
            hideStreamingProgress() {
                const loading = document.getElementById('loading');
                if (loading) {
                    loading.classList.add('hidden');
                }
            }

            updateTable(items) {
                this.items = items || [];
                this.renderItems();
            }

            async loadStatistics() {
                try {
                    // ç§»é™¤ç»Ÿè®¡ä¿¡æ¯APIè°ƒç”¨ï¼Œç›´æ¥ä½¿ç”¨statusæ¥å£çš„æ•°æ®
                    const response = await fetch('/api/status');
                    const result = await response.json();
                    
                    if (result.success) {
                        const data = result.data;
                        
                        // ä¿®æ­£å…ƒç´ IDï¼šä»totalItemsæ”¹ä¸ºtotalCount
                        const totalCountElement = document.getElementById('totalCount');
                        const avgDiffElement = document.getElementById('avgDiff');
                        const maxDiffElement = document.getElementById('maxDiff');
                        
                        if (totalCountElement) {
                            totalCountElement.textContent = data.current_items_count || 0;
                        }
                        if (avgDiffElement) {
                            avgDiffElement.textContent = 'è®¡ç®—ä¸­...';
                        }
                        if (maxDiffElement) {
                            maxDiffElement.textContent = 'è®¡ç®—ä¸­...';
                        }
                        
                        // å¦‚æœæœ‰å•†å“æ•°æ®ï¼Œè·å–æ›´è¯¦ç»†çš„ç»Ÿè®¡
                        if (data.current_items_count > 0) {
                            await this.loadDetailedStatistics();
                        }
                    }
                } catch (error) {
                    console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
                }
            }

            async loadDetailedStatistics() {
                try {
                    const response = await fetch('/api/data');
                    const result = await response.json();
                    
                    if (result.success && result.data.items.length > 0) {
                        const items = result.data.items;
                        const totalDiff = items.reduce((sum, item) => sum + item.price_diff, 0);
                        const avgDiff = totalDiff / items.length;
                        const maxDiff = Math.max(...items.map(item => item.price_diff));
                        
                        const avgDiffElement = document.getElementById('avgDiff');
                        const maxDiffElement = document.getElementById('maxDiff');
                        
                        if (avgDiffElement) {
                            avgDiffElement.textContent = `Â¥${avgDiff.toFixed(2)}`;
                        }
                        if (maxDiffElement) {
                            maxDiffElement.textContent = `Â¥${maxDiff.toFixed(2)}`;
                        }
                    }
                } catch (error) {
                    console.error('åŠ è½½è¯¦ç»†ç»Ÿè®¡å¤±è´¥:', error);
                }
            }

            async loadStatus() {
                try {
                    const response = await fetch('/api/status');
                    const result = await response.json();
                    
                    if (result.success) {
                        this.updateStatus(result.data);
                    }
                } catch (error) {
                    console.error('æ£€æŸ¥çŠ¶æ€å¤±è´¥:', error);
                }
            }

            updateStatus(status) {
                const lastUpdate = status.last_update ? 
                    new Date(status.last_update).toLocaleString('zh-CN') : 'æœªçŸ¥';
                document.getElementById('lastUpdate').textContent = lastUpdate;
                
                // æ›´æ–°ç›‘æ§çŠ¶æ€
                const statusElement = document.getElementById('updateStatus');
                if (statusElement) {
                    const isRunning = status.is_running;
                    statusElement.innerHTML = `
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${isRunning ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            <i class="fas ${isRunning ? 'fa-play' : 'fa-pause'} mr-1"></i>
                            ${isRunning ? 'ç›‘æ§ä¸­' : 'å·²åœæ­¢'}
                        </span>
                    `;
                }
            }

            renderItems() {
                const loading = document.getElementById('loading');
                const itemsList = document.getElementById('itemsList');
                
                loading.classList.add('hidden');
                itemsList.classList.remove('hidden');
                
                if (this.items.length === 0) {
                    itemsList.innerHTML = `
                        <div class="p-8 text-center text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-4"></i>
                            <p>æš‚æ— ç¬¦åˆæ¡ä»¶çš„å·®ä»·é¥°å“</p>
                        </div>
                    `;
                    return;
                }
                
                const itemsHtml = this.items.map(item => this.renderItem(item)).join('');
                itemsList.innerHTML = itemsHtml;
            }

            renderItem(item) {
                const profitClass = this.getProfitClass(item.profit_rate || 0);
                const imageUrl = item.image_url || '/static/placeholder.png';
                
                return `
                    <div class="border-b border-gray-200 p-6 card-hover">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <img src="${imageUrl}" alt="${item.name}" 
                                     class="w-16 h-16 rounded-lg object-cover bg-gray-100"
                                     onerror="this.src='/static/placeholder.png'">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 mb-1">${item.name}</h3>
                                    <div class="flex items-center space-x-4 text-sm text-gray-600">
                                        <span>Buff: <span class="font-medium text-red-600">Â¥${item.buff_price}</span></span>
                                        <span>æ‚ æ‚ : <span class="font-medium text-green-600">Â¥${item.youpin_price}</span></span>
                                        <span class="text-xs ${profitClass} text-white px-2 py-1 rounded-full">
                                            åˆ©æ¶¦ç‡ ${(item.profit_rate || 0).toFixed(1)}%
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex items-center space-x-4">
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-green-600">
                                        +Â¥${(item.price_diff || 0).toFixed(2)}
                                    </div>
                                    <div class="text-sm text-gray-500">ä»·å·®</div>
                                </div>
                                
                                <button onclick="window.open('${item.buff_url || '#'}', '_blank')" 
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition duration-200 flex items-center">
                                    <i class="fas fa-external-link-alt mr-2"></i>
                                    ç«‹å³è´­ä¹°
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            getProfitClass(margin) {
                if (margin >= 50) return 'profit-very-high';
                if (margin >= 30) return 'profit-high';
                return 'profit-positive';
            }

            async forceUpdate() {
                const btn = document.getElementById('refreshBtn');
                const originalText = btn.innerHTML;
                
                btn.innerHTML = '<i class="fas fa-spinner loading mr-1"></i>æ›´æ–°ä¸­...';
                btn.disabled = true;
                
                try {
                    // ğŸ”¥ æ–°å¢ï¼šå¯åŠ¨æµå¼åˆ†æè€Œä¸æ˜¯ä¼ ç»Ÿçš„force_update
                    if (this.streamingActive) {
                        this.stopStreaming();
                    }
                    
                    // æ¸…ç©ºå½“å‰æ•°æ®
                    this.items = [];
                    this.renderItems();
                    
                    // å¯åŠ¨å¢é‡åˆ†æï¼ˆå¼ºåˆ¶åˆ·æ–°ï¼‰
                    const response = await fetch('/api/analyze_incremental', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ force_refresh: true })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // ç«‹å³æ˜¾ç¤ºç¼“å­˜æ•°æ®ï¼ˆå¦‚æœæœ‰ï¼‰
                        if (result.data.items.length > 0) {
                            this.items = result.data.items;
                            document.getElementById('totalCount').textContent = this.items.length;
                            this.renderItems();
                            this.calculateStatistics();
                        }
                        
                        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        this.showAlert('success', 'å¼€å§‹å¼ºåˆ¶åˆ·æ–°ï¼Œæ­£åœ¨å¯åŠ¨æµå¼åˆ†æ...');
                        
                        // å¯åŠ¨æµå¼æ›´æ–°
                        setTimeout(() => this.startStreamingUpdate(), 1000);
                    } else {
                        this.showAlert('error', 'æ›´æ–°å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                } catch (error) {
                    console.error('å¼ºåˆ¶æ›´æ–°å¤±è´¥:', error);
                    this.showAlert('error', 'æ›´æ–°å¤±è´¥: ' + error.message);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }

            openSettings() {
                document.getElementById('settingsModal').classList.remove('hidden');
                this.loadConfig();
            }

            closeSettings() {
                document.getElementById('settingsModal').classList.add('hidden');
            }

            async loadConfig() {
                try {
                    // åŠ è½½è®¾ç½®
                    const settingsResponse = await fetch('/api/settings');
                    const settingsResult = await settingsResponse.json();
                    
                    if (settingsResult.success) {
                        const data = settingsResult.data;
                        document.getElementById('thresholdInput').value = data.threshold || '';
                        document.getElementById('maxOutputItems').value = data.max_output_items || '';
                        
                        if (data.price_range) {
                            document.getElementById('priceRangeMin').value = data.price_range.min || '';
                            document.getElementById('priceRangeMax').value = data.price_range.max || '';
                        }
                        
                        if (data.buff_price_range) {
                            document.getElementById('buffPriceMin').value = data.buff_price_range.min || '';
                            document.getElementById('buffPriceMax').value = data.buff_price_range.max || '';
                        }
                        
                        if (data.update_intervals) {
                            const fullInterval = document.getElementById('fullUpdateInterval');
                            const incrementalInterval = document.getElementById('incrementalUpdateInterval');
                            
                            if (fullInterval) {
                                fullInterval.textContent = `${data.update_intervals.full_update_hours}å°æ—¶`;
                            }
                            
                            if (incrementalInterval) {
                                incrementalInterval.textContent = `${data.update_intervals.incremental_update_minutes}åˆ†é’Ÿ`;
                            }
                        }
                    }

                    // åŠ è½½å½“å‰ä»·æ ¼åŒºé—´
                    const rangeResponse = await fetch('/api/price_range');
                    const rangeResult = await rangeResponse.json();
                    
                    if (rangeResult.success) {
                        const currentRange = document.getElementById('currentPriceRange');
                        if (currentRange) {
                            currentRange.textContent = rangeResult.data.current_range;
                        }
                    }
                    
                    // åŠ è½½Buffä»·æ ¼ç­›é€‰åŒºé—´
                    const buffRangeResponse = await fetch('/api/buff_price_range');
                    const buffRangeResult = await buffRangeResponse.json();
                    
                    if (buffRangeResult.success) {
                        const currentBuffRange = document.getElementById('currentBuffPriceRange');
                        if (currentBuffRange) {
                            currentBuffRange.textContent = buffRangeResult.data.current_range;
                        }
                    }
                } catch (error) {
                    console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
                }
            }

            async saveSettings() {
                try {
                    const threshold = document.getElementById('thresholdInput').value;
                    const priceMin = document.getElementById('priceRangeMin').value;
                    const priceMax = document.getElementById('priceRangeMax').value;
                    const buffPriceMin = document.getElementById('buffPriceMin').value;
                    const buffPriceMax = document.getElementById('buffPriceMax').value;
                    const maxOutputItems = document.getElementById('maxOutputItems').value;
                    
                    // éªŒè¯ä»·æ ¼åŒºé—´
                    if (priceMin && priceMax) {
                        const min = parseFloat(priceMin);
                        const max = parseFloat(priceMax);
                        
                        if (min >= max) {
                            this.showAlert('error', 'æœ€å°ä»·å·®å¿…é¡»å°äºæœ€å¤§ä»·å·®');
                            return;
                        }
                        
                        if (min < 0 || max < 0) {
                            this.showAlert('error', 'ä»·å·®ä¸èƒ½ä¸ºè´Ÿæ•°');
                            return;
                        }
                    }
                    
                    // éªŒè¯Buffä»·æ ¼åŒºé—´
                    if (buffPriceMin && buffPriceMax) {
                        const min = parseFloat(buffPriceMin);
                        const max = parseFloat(buffPriceMax);
                        
                        if (min >= max) {
                            this.showAlert('error', 'Buffæœ€å°ä»·æ ¼å¿…é¡»å°äºæœ€å¤§ä»·æ ¼');
                            return;
                        }
                        
                        if (min < 0 || max < 0) {
                            this.showAlert('error', 'Buffä»·æ ¼ä¸èƒ½ä¸ºè´Ÿæ•°');
                            return;
                        }
                    }
                    
                    const updateData = {};
                    
                    if (threshold) {
                        updateData.threshold = parseFloat(threshold);
                    }
                    
                    if (priceMin && priceMax) {
                        updateData.price_min = parseFloat(priceMin);
                        updateData.price_max = parseFloat(priceMax);
                    }
                    
                    if (buffPriceMin && buffPriceMax) {
                        updateData.buff_price_min = parseFloat(buffPriceMin);
                        updateData.buff_price_max = parseFloat(buffPriceMax);
                    }
                    
                    if (maxOutputItems) {
                        updateData.max_output_items = parseInt(maxOutputItems);
                    }
                    
                    if (Object.keys(updateData).length === 0) {
                        this.showAlert('warning', 'æ²¡æœ‰è®¾ç½®éœ€è¦ä¿å­˜');
                        return;
                    }
                    
                    const response = await fetch('/api/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updateData)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.showAlert('success', 'è®¾ç½®å·²ä¿å­˜: ' + result.message);
                        this.closeSettings();
                        
                        // é‡æ–°åŠ è½½é…ç½®æ˜¾ç¤º
                        setTimeout(() => this.loadConfig(), 500);
                        
                        // é‡æ–°åŠ è½½æ•°æ®
                        setTimeout(() => this.loadData(), 1000);
                    } else {
                        this.showAlert('error', 'ä¿å­˜å¤±è´¥: ' + result.error);
                    }
                } catch (error) {
                    console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error);
                    this.showAlert('error', 'ä¿å­˜å¤±è´¥: ' + error.message);
                }
            }

            // ğŸ”¥ æ–°å¢ï¼šå¼ºåˆ¶å…¨é‡æ›´æ–°
            async forceFullUpdate() {
                const btn = document.getElementById('forceFullUpdate');
                const originalText = btn.innerHTML;
                
                try {
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>æ­£åœ¨æ›´æ–°...';
                    btn.disabled = true;
                    
                    const response = await fetch('/api/force_update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.showAlert('success', result.message);
                        // å»¶è¿Ÿé‡æ–°åŠ è½½æ•°æ®
                        setTimeout(() => this.loadData(), 2000);
                    } else {
                        this.showAlert('error', 'å…¨é‡æ›´æ–°å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                } catch (error) {
                    console.error('å¼ºåˆ¶å…¨é‡æ›´æ–°å¤±è´¥:', error);
                    this.showAlert('error', 'å…¨é‡æ›´æ–°å¤±è´¥: ' + error.message);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
            
            // ğŸ”¥ æ–°å¢ï¼šå¼ºåˆ¶å¢é‡æ›´æ–°
            async forceIncrementalUpdate() {
                const btn = document.getElementById('forceIncrementalUpdate');
                const originalText = btn.innerHTML;
                
                try {
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>æ­£åœ¨æ›´æ–°...';
                    btn.disabled = true;
                    
                    const response = await fetch('/api/force_incremental_update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.showAlert('success', result.message);
                        // å»¶è¿Ÿé‡æ–°åŠ è½½æ•°æ®
                        setTimeout(() => this.loadData(), 1000);
                    } else {
                        this.showAlert('error', 'å¢é‡æ›´æ–°å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                } catch (error) {
                    console.error('å¼ºåˆ¶å¢é‡æ›´æ–°å¤±è´¥:', error);
                    this.showAlert('error', 'å¢é‡æ›´æ–°å¤±è´¥: ' + error.message);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }

            showAlert(type, message) {
                // åˆ›å»ºæˆ–æ›´æ–°æç¤ºæ¡†
                let alertDiv = document.getElementById('alertBox');
                if (!alertDiv) {
                    alertDiv = document.createElement('div');
                    alertDiv.id = 'alertBox';
                    alertDiv.className = 'fixed top-4 right-4 z-50 max-w-sm';
                    document.body.appendChild(alertDiv);
                }
                
                const alertClass = type === 'success' ? 'bg-green-100 text-green-800 border-green-400' : 
                                  type === 'warning' ? 'bg-yellow-100 text-yellow-800 border-yellow-400' :
                                  type === 'info' ? 'bg-blue-100 text-blue-800 border-blue-400' :
                                  'bg-red-100 text-red-800 border-red-400';
                
                const icon = type === 'success' ? 'check-circle' : 
                            type === 'warning' ? 'exclamation-triangle' : 
                            type === 'info' ? 'info-circle' :
                            'times-circle';
                
                alertDiv.innerHTML = `
                    <div class="border ${alertClass} rounded-lg p-4 shadow-lg">
                        <div class="flex items-center">
                            <i class="fas fa-${icon} mr-2"></i>
                            <span>${message}</span>
                            <button onclick="this.parentElement.parentElement.remove()" class="ml-auto pl-2">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                // è‡ªåŠ¨éšè—
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 5000);
            }

            // Tokenç®¡ç†æ–¹æ³•
            showGeneralTab() {
                document.getElementById('generalTab').className = 'px-4 py-2 font-medium text-blue-600 border-b-2 border-blue-600';
                document.getElementById('tokensTab').className = 'px-4 py-2 font-medium text-gray-600 hover:text-blue-600 ml-4';
                document.getElementById('generalPanel').classList.remove('hidden');
                document.getElementById('tokensPanel').classList.add('hidden');
            }
            
            showTokenTab() {
                document.getElementById('generalTab').className = 'px-4 py-2 font-medium text-gray-600 hover:text-blue-600';
                document.getElementById('tokensTab').className = 'px-4 py-2 font-medium text-blue-600 border-b-2 border-blue-600 ml-4';
                document.getElementById('generalPanel').classList.add('hidden');
                document.getElementById('tokensPanel').classList.remove('hidden');
                
                // åŠ è½½TokençŠ¶æ€
                this.loadTokenStatus();
            }
            
            async loadTokenStatus() {
                try {
                    const response = await fetch('/api/tokens/status');
                    const result = await response.json();
                    
                    if (result.success) {
                        const { buff, youpin } = result.data;
                        
                        // æ›´æ–°BuffçŠ¶æ€
                        const buffStatus = document.getElementById('buffTokenStatus');
                        buffStatus.innerHTML = this.getStatusBadge(buff.status, buff.has_cookies && buff.has_csrf);
                        
                        // æ›´æ–°æ‚ æ‚ æœ‰å“çŠ¶æ€
                        const youpinStatus = document.getElementById('youpinTokenStatus');
                        youpinStatus.innerHTML = this.getStatusBadge(youpin.status, youpin.has_device_id && youpin.has_uk);
                    }
                } catch (error) {
                    console.error('åŠ è½½TokençŠ¶æ€å¤±è´¥:', error);
                }
            }
            
            getStatusBadge(status, isValid) {
                if (status === 'å·²é…ç½®' && isValid) {
                    return `<span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800">
                        <i class="fas fa-check mr-1"></i>å·²é…ç½®
                    </span>`;
                } else if (status === 'å·²é…ç½®' && !isValid) {
                    return `<span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-800">
                        <i class="fas fa-exclamation-triangle mr-1"></i>é…ç½®ä¸å®Œæ•´
                    </span>`;
                } else {
                    return `<span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-800">
                        <i class="fas fa-times mr-1"></i>æœªé…ç½®
                    </span>`;
                }
            }
            
            async updateBuffToken() {
                try {
                    const session = document.getElementById('buffSession').value.trim();
                    const csrfToken = document.getElementById('buffCsrfToken').value.trim();
                    const otherCookiesText = document.getElementById('buffOtherCookies').value.trim();
                    
                    if (!session || !csrfToken) {
                        alert('è¯·è¾“å…¥Sessionå’ŒCSRF Token');
                        return;
                    }
                    
                    const cookies = {
                        session: session,
                        csrf_token: csrfToken
                    };
                    
                    // è§£æå…¶ä»–cookies
                    if (otherCookiesText) {
                        try {
                            const otherCookies = JSON.parse(otherCookiesText);
                            Object.assign(cookies, otherCookies);
                        } catch (e) {
                            alert('å…¶ä»–Cookiesæ ¼å¼é”™è¯¯ï¼Œè¯·ä½¿ç”¨æ­£ç¡®çš„JSONæ ¼å¼');
                            return;
                        }
                    }
                    
                    const response = await fetch('/api/tokens/buff', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ cookies })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('Buff Tokenæ›´æ–°æˆåŠŸï¼');
                        this.loadTokenStatus();
                        // æ¸…ç©ºè¾“å…¥æ¡†
                        document.getElementById('buffSession').value = '';
                        document.getElementById('buffCsrfToken').value = '';
                        document.getElementById('buffOtherCookies').value = '';
                    } else {
                        alert('æ›´æ–°å¤±è´¥: ' + (result.error || result.detail));
                    }
                } catch (error) {
                    console.error('æ›´æ–°Buff Tokenå¤±è´¥:', error);
                    alert('æ›´æ–°å¤±è´¥: ' + error.message);
                }
            }
            
            async updateYoupinToken() {
                try {
                    const deviceId = document.getElementById('youpinDeviceId').value.trim();
                    const deviceUk = document.getElementById('youpinDeviceUk').value.trim();
                    const uk = document.getElementById('youpinUk').value.trim();
                    const b3 = document.getElementById('youpinB3').value.trim();
                    const authorization = document.getElementById('youpinAuthorization').value.trim();
                    
                    if (!deviceId || !uk) {
                        alert('è¯·è‡³å°‘è¾“å…¥Device IDå’ŒUK');
                        return;
                    }
                    
                    const response = await fetch('/api/tokens/youpin', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            device_id: deviceId,
                            device_uk: deviceUk,
                            uk: uk,
                            b3: b3,
                            authorization: authorization
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('æ‚ æ‚ æœ‰å“Tokenæ›´æ–°æˆåŠŸï¼');
                        this.loadTokenStatus();
                        // æ¸…ç©ºè¾“å…¥æ¡†
                        document.getElementById('youpinDeviceId').value = '';
                        document.getElementById('youpinDeviceUk').value = '';
                        document.getElementById('youpinUk').value = '';
                        document.getElementById('youpinB3').value = '';
                        document.getElementById('youpinAuthorization').value = '';
                    } else {
                        alert('æ›´æ–°å¤±è´¥: ' + (result.error || result.detail));
                    }
                } catch (error) {
                    console.error('æ›´æ–°æ‚ æ‚ æœ‰å“Tokenå¤±è´¥:', error);
                    alert('æ›´æ–°å¤±è´¥: ' + error.message);
                }
            }
            
            async testBuffConnection() {
                const btn = document.getElementById('testBuffConnection');
                const originalText = btn.innerHTML;
                
                btn.innerHTML = '<i class="fas fa-spinner loading mr-1"></i>æµ‹è¯•ä¸­...';
                btn.disabled = true;
                
                try {
                    const response = await fetch('/api/test/buff', { method: 'POST' });
                    const result = await response.json();
                    
                    if (result.success) {
                        alert(`Buffè¿æ¥æµ‹è¯•æˆåŠŸï¼\n${result.message}`);
                    } else {
                        alert(`Buffè¿æ¥æµ‹è¯•å¤±è´¥ï¼š\n${result.error}`);
                    }
                } catch (error) {
                    console.error('æµ‹è¯•Buffè¿æ¥å¤±è´¥:', error);
                    alert('æµ‹è¯•å¤±è´¥: ' + error.message);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
            
            async testYoupinConnection() {
                const btn = document.getElementById('testYoupinConnection');
                const originalText = btn.innerHTML;
                
                btn.innerHTML = '<i class="fas fa-spinner loading mr-1"></i>æµ‹è¯•ä¸­...';
                btn.disabled = true;
                
                try {
                    const response = await fetch('/api/test/youpin', { method: 'POST' });
                    const result = await response.json();
                    
                    if (result.success) {
                        alert(`æ‚ æ‚ æœ‰å“è¿æ¥æµ‹è¯•æˆåŠŸï¼\n${result.message}`);
                    } else {
                        alert(`æ‚ æ‚ æœ‰å“è¿æ¥æµ‹è¯•å¤±è´¥ï¼š\n${result.error}`);
                    }
                } catch (error) {
                    console.error('æµ‹è¯•æ‚ æ‚ æœ‰å“è¿æ¥å¤±è´¥:', error);
                    alert('æµ‹è¯•å¤±è´¥: ' + error.message);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }

            // ğŸ”¥ æ–°å¢ï¼šåº”ç”¨æ’åº
            applySorting() {
                if (this.sortBy === 'price_diff') {
                    this.items.sort((a, b) => (b.price_diff || 0) - (a.price_diff || 0));
                } else if (this.sortBy === 'profit_margin') {
                    this.items.sort((a, b) => (b.profit_rate || 0) - (a.profit_rate || 0));
                }
            }

            // ğŸ”¥ æ–°å¢ï¼šè®¡ç®—ç»Ÿè®¡ä¿¡æ¯
            calculateStatistics() {
                if (this.items.length === 0) {
                    document.getElementById('avgDiff').textContent = '-';
                    document.getElementById('maxDiff').textContent = '-';
                    return;
                }
                
                const totalDiff = this.items.reduce((sum, item) => sum + (item.price_diff || 0), 0);
                const avgDiff = totalDiff / this.items.length;
                const maxDiff = Math.max(...this.items.map(item => item.price_diff || 0));
                
                document.getElementById('avgDiff').textContent = `Â¥${avgDiff.toFixed(2)}`;
                document.getElementById('maxDiff').textContent = `Â¥${maxDiff.toFixed(2)}`;
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            new BuffMonitor();
        });
    </script>
</body>
</html> 