<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ç«¯é…ç½®è°ƒè¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-item { margin: 10px 0; padding: 10px; border: 1px solid #ddd; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        input { margin: 5px; padding: 5px; }
        button { margin: 5px; padding: 8px 15px; background: #007bff; color: white; border: none; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ” å‰ç«¯é…ç½®åŠ è½½è°ƒè¯•</h1>
    
    <div class="debug-item info">
        <h3>ğŸ“‹ æµ‹è¯•æ­¥éª¤</h3>
        <ol>
            <li>ç‚¹å‡»"æµ‹è¯•APIè¿æ¥"æ£€æŸ¥åç«¯æ˜¯å¦å¯è®¿é—®</li>
            <li>ç‚¹å‡»"åŠ è½½é…ç½®"æµ‹è¯•é…ç½®è·å–</li>
            <li>ä¿®æ”¹Buffä»·æ ¼åŒºé—´å¹¶ä¿å­˜</li>
            <li>å†æ¬¡åŠ è½½é…ç½®éªŒè¯æ˜¯å¦æˆåŠŸ</li>
        </ol>
    </div>

    <div class="debug-item">
        <h3>ğŸ”— APIè¿æ¥æµ‹è¯•</h3>
        <button onclick="testApiConnection()">æµ‹è¯•APIè¿æ¥</button>
        <div id="connectionResult"></div>
    </div>

    <div class="debug-item">
        <h3>ğŸ“¥ é…ç½®åŠ è½½æµ‹è¯•</h3>
        <button onclick="loadConfigDebug()">åŠ è½½é…ç½®</button>
        <div id="configResult"></div>
    </div>

    <div class="debug-item">
        <h3>ğŸ”§ Buffä»·æ ¼åŒºé—´è®¾ç½®</h3>
        <div>
            <label>æœ€å°ä»·æ ¼ï¼š</label>
            <input type="number" id="buffPriceMin" placeholder="æœ€å°ä»·æ ¼" step="0.1" min="0">
            <label>æœ€å¤§ä»·æ ¼ï¼š</label>
            <input type="number" id="buffPriceMax" placeholder="æœ€å¤§ä»·æ ¼" step="0.1" min="0">
            <button onclick="saveBuffPriceRange()">ä¿å­˜Buffä»·æ ¼åŒºé—´</button>
        </div>
        <div id="saveResult"></div>
    </div>

    <div class="debug-item">
        <h3>ğŸ“Š å½“å‰å€¼æ˜¾ç¤º</h3>
        <div>
            <p>Buffæœ€å°ä»·æ ¼è¾“å…¥æ¡†å€¼: <span id="currentMinValue">-</span></p>
            <p>Buffæœ€å¤§ä»·æ ¼è¾“å…¥æ¡†å€¼: <span id="currentMaxValue">-</span></p>
        </div>
    </div>

    <div class="debug-item">
        <h3>ğŸ“ è°ƒè¯•æ—¥å¿—</h3>
        <div id="debugLog" style="max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 4px;"></div>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <script>
        function log(message, type = 'info') {
            const debugLog = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> <span style="color: ${type === 'error' ? 'red' : type === 'success' ? 'green' : 'blue'};">${message}</span>`;
            debugLog.appendChild(logEntry);
            debugLog.scrollTop = debugLog.scrollHeight;
        }

        function clearLog() {
            document.getElementById('debugLog').innerHTML = '';
        }

        async function testApiConnection() {
            log('ğŸ” å¼€å§‹æµ‹è¯•APIè¿æ¥...', 'info');
            const resultDiv = document.getElementById('connectionResult');
            
            try {
                const response = await fetch('/api/settings');
                log(`ğŸ“¡ å“åº”çŠ¶æ€: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const data = await response.json();
                    log('âœ… APIè¿æ¥æˆåŠŸ', 'success');
                    resultDiv.innerHTML = '<div class="success">âœ… APIè¿æ¥æ­£å¸¸</div>';
                    log(`ğŸ“‹ è·å–åˆ°çš„æ•°æ®: ${JSON.stringify(data, null, 2)}`, 'info');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                log(`âŒ APIè¿æ¥å¤±è´¥: ${error.message}`, 'error');
                resultDiv.innerHTML = `<div class="error">âŒ APIè¿æ¥å¤±è´¥: ${error.message}</div>`;
            }
        }

        async function loadConfigDebug() {
            log('ğŸ“¥ å¼€å§‹åŠ è½½é…ç½®...', 'info');
            const resultDiv = document.getElementById('configResult');
            
            try {
                // æµ‹è¯• /api/settings æ¥å£
                log('ğŸ”— è¯·æ±‚ /api/settings...', 'info');
                const settingsResponse = await fetch('/api/settings');
                log(`ğŸ“¡ /api/settings å“åº”çŠ¶æ€: ${settingsResponse.status}`, settingsResponse.ok ? 'success' : 'error');
                
                if (!settingsResponse.ok) {
                    throw new Error(`settings API å¤±è´¥: ${settingsResponse.status}`);
                }
                
                const settingsData = await settingsResponse.json();
                log(`ğŸ“‹ /api/settings å“åº”æ•°æ®: ${JSON.stringify(settingsData, null, 2)}`, 'info');
                
                if (settingsData.success && settingsData.data.buff_price_range) {
                    const buffRange = settingsData.data.buff_price_range;
                    log(`ğŸ¯ æ‰¾åˆ° buff_price_range: min=${buffRange.min}, max=${buffRange.max}`, 'success');
                    
                    // å¡«å……è¾“å…¥æ¡†
                    const minInput = document.getElementById('buffPriceMin');
                    const maxInput = document.getElementById('buffPriceMax');
                    
                    log(`ğŸ” è·å–è¾“å…¥æ¡†å…ƒç´ : minInput=${!!minInput}, maxInput=${!!maxInput}`, 'info');
                    
                    if (minInput && maxInput) {
                        minInput.value = buffRange.min || '';
                        maxInput.value = buffRange.max || '';
                        log(`âœ… è¾“å…¥æ¡†å·²å¡«å……: min=${minInput.value}, max=${maxInput.value}`, 'success');
                        updateCurrentValues();
                    } else {
                        log('âŒ æ‰¾ä¸åˆ°è¾“å…¥æ¡†å…ƒç´ ', 'error');
                    }
                } else {
                    log('âŒ å“åº”ä¸­æ²¡æœ‰ buff_price_range æ•°æ®', 'error');
                }
                
                resultDiv.innerHTML = '<div class="success">âœ… é…ç½®åŠ è½½å®Œæˆï¼ŒæŸ¥çœ‹æ—¥å¿—äº†è§£è¯¦æƒ…</div>';
                
            } catch (error) {
                log(`âŒ åŠ è½½é…ç½®å¤±è´¥: ${error.message}`, 'error');
                resultDiv.innerHTML = `<div class="error">âŒ åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        async function saveBuffPriceRange() {
            const minValue = document.getElementById('buffPriceMin').value;
            const maxValue = document.getElementById('buffPriceMax').value;
            const resultDiv = document.getElementById('saveResult');
            
            log(`ğŸ’¾ å¼€å§‹ä¿å­˜ Buff ä»·æ ¼åŒºé—´: min=${minValue}, max=${maxValue}`, 'info');
            
            if (!minValue || !maxValue) {
                log('âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„æœ€å°å’Œæœ€å¤§ä»·æ ¼', 'error');
                resultDiv.innerHTML = '<div class="error">âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„æœ€å°å’Œæœ€å¤§ä»·æ ¼</div>';
                return;
            }

            try {
                const updateData = {
                    buff_price_min: parseFloat(minValue),
                    buff_price_max: parseFloat(maxValue)
                };
                
                log(`ğŸ“¤ å‘é€æ›´æ–°æ•°æ®: ${JSON.stringify(updateData)}`, 'info');
                
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });
                
                log(`ğŸ“¡ ä¿å­˜å“åº”çŠ¶æ€: ${response.status}`, response.ok ? 'success' : 'error');
                
                const result = await response.json();
                log(`ğŸ“‹ ä¿å­˜å“åº”æ•°æ®: ${JSON.stringify(result, null, 2)}`, 'info');
                
                if (result.success) {
                    log('âœ… ä¿å­˜æˆåŠŸ', 'success');
                    resultDiv.innerHTML = `<div class="success">âœ… ä¿å­˜æˆåŠŸ: ${result.message}</div>`;
                    
                    // é‡æ–°åŠ è½½é…ç½®éªŒè¯
                    setTimeout(() => {
                        log('ğŸ”„ è‡ªåŠ¨é‡æ–°åŠ è½½é…ç½®è¿›è¡ŒéªŒè¯...', 'info');
                        loadConfigDebug();
                    }, 500);
                } else {
                    throw new Error(result.error || 'ä¿å­˜å¤±è´¥');
                }
            } catch (error) {
                log(`âŒ ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
                resultDiv.innerHTML = `<div class="error">âŒ ä¿å­˜å¤±è´¥: ${error.message}</div>`;
            }
        }

        function updateCurrentValues() {
            const minInput = document.getElementById('buffPriceMin');
            const maxInput = document.getElementById('buffPriceMax');
            
            document.getElementById('currentMinValue').textContent = minInput ? minInput.value || 'ç©º' : 'å…ƒç´ ä¸å­˜åœ¨';
            document.getElementById('currentMaxValue').textContent = maxInput ? maxInput.value || 'ç©º' : 'å…ƒç´ ä¸å­˜åœ¨';
        }

        // ç›‘å¬è¾“å…¥æ¡†å˜åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            const minInput = document.getElementById('buffPriceMin');
            const maxInput = document.getElementById('buffPriceMax');
            
            if (minInput) minInput.addEventListener('input', updateCurrentValues);
            if (maxInput) maxInput.addEventListener('input', updateCurrentValues);
            
            updateCurrentValues();
            log('ğŸš€ è°ƒè¯•é¡µé¢åˆå§‹åŒ–å®Œæˆ', 'success');
        });
    </script>
</body>
</html>